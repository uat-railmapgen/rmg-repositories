import{j as w}from"./chakra-b44533e6.js";import{b as m,r as it}from"./react-14e694c6.js";import{u as W}from"./useEvent-801a7c9c.js";import{a8 as tt,l as O,e as lt,v as B,a9 as F,j as G,aa as Z,s as yt,f as et,a7 as $,n as st,c as U,r as nt,E as rt,h as ot,L as ct,ab as ht,S as xt,J as mt,p as X,o as At,Z as vt,$ as bt}from"./index-febab319.js";import{s as ft}from"./stations-03c6a73f.js";import{m as gt}from"./misc-nodes-2d937040.js";import{g as K,r as M,i as T}from"./helpers-2fcbe9c8.js";const q=e=>{const{id:t,type:s,attrs:c,styleType:n,styleAttrs:l=tt[n].defaultAttrs,newLine:g,handleClick:u}=e,{x1:y,y1:p,x2:b,y2:S}=e,[L,N]=m.useState("M 0,0 L 0,0");m.useEffect(()=>{N(O[s].generatePath(y,b,p,S,c))},[s,JSON.stringify(c),y,b,p,S]);const _=tt[n].component;return m.useMemo(()=>w.jsx(_,{id:t,type:s,path:L,styleAttrs:l,newLine:g,handleClick:u}),[t,s,L,n,JSON.stringify(l),g,u])},St=e=>{const t=e.filterDirectedEdges((c,n,l,g,u,y,p)=>c.startsWith("line")&&n.reconcileId!==""),s={};for(const c of t){const n=e.getEdgeAttribute(c,"reconcileId");n in s?s[n].push(c):s[n]=[c]}return s},at=e=>{const t=St(e),s=[],c=[];return Object.values(t).forEach(n=>{var j;if(n.length===1){c.push(...n);return}const l=e.getEdgeAttribute(n.at(0),"type");if(!n.every(h=>e.getEdgeAttribute(h,"type")===l)){c.push(...n);return}const g=e.getEdgeAttribute(n.at(0),"style");if(!n.every(h=>e.getEdgeAttribute(h,"style")===g)){c.push(...n);return}const u={},y=new Set,p=new Set,b=Object.fromEntries(n.map(h=>{const[E,P]=e.extremities(h);return u[E]=(u[E]??0)+1,u[P]=(u[P]??0)+1,y.add(E),p.add(P),[E,[h,P]]})),S=Array.from(y).filter(h=>u[h]===1),L=Array.from(p).filter(h=>u[h]===1);if(S.length!==1||L.length!==1){c.push(...n);return}const N=S[0],_=L[0];if(N===_){c.push(...n);return}const I=[b[N][0]];let k=b[N][1];for(let h=1;h<n.length;h=h+1){const E=(j=b[k])==null?void 0:j.at(1);if(!E){c.push(...n);return}I.push(b[k][0]),k=E}if(k!==_||I.length!==n.length){c.push(...n);return}s.push(I)}),{allReconciledLines:s,danglingLines:c}},wt=(e,t)=>{if(!t.every(n=>e.hasEdge(n)))return;const s=t.map(n=>{const[l,g]=e.extremities(n),u=e.getNodeAttributes(l),y=e.getNodeAttributes(g),p=e.getEdgeAttribute(n,"type"),b=e.getEdgeAttribute(n,p)??O[p].defaultAttrs;return O[p].generatePath(u.x,y.x,u.y,y.y,b)});let c=`${s[0]} `;for(let n=1;n<t.length;n=n+1)c+=s[n].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return c},dt=e=>e.filterNodes((t,s)=>t.startsWith("stn")).map(t=>[t,e.getNodeAttributes(t)]).filter(([t,s])=>s.visible).sort((t,s)=>t[1].zIndex-s[1].zIndex).map(([t,s])=>({node:t,visible:s.visible,zIndex:s.zIndex,x:s.x,y:s.y,type:s.type,[s.type]:s[s.type]})),Q=e=>e.filterDirectedEdges((t,s,c,n,l,g,u)=>t.startsWith("line")&&s.visible&&s.reconcileId==="").sort((t,s)=>e.getEdgeAttribute(t,"zIndex")-e.getEdgeAttribute(s,"zIndex")).map(t=>{const s=e.getEdgeAttribute(t,"type"),c=e.getEdgeAttribute(t,s),n=e.getEdgeAttribute(t,"style"),l=e.getEdgeAttribute(t,n),[g,u]=e.extremities(t),y=e.getNodeAttributes(g),p=e.getNodeAttributes(u);return{edge:t,x1:y.x,y1:y.y,x2:p.x,y2:p.y,type:s,attr:c,style:n,styleAttr:l}}),ut=e=>e.filterNodes((t,s)=>t.startsWith("misc_node")).map(t=>[t,e.getNodeAttributes(t)]).filter(([t,s])=>s.visible).sort((t,s)=>t[1].zIndex-s[1].zIndex).map(([t,s])=>({node:t,visible:s.visible,zIndex:s.zIndex,x:s.x,y:s.y,type:s.type,[s.type]:s[s.type]})),Et=()=>{const e=lt(),t=m.useRef(window.graph),{telemetry:{project:s}}=B(i=>i.app),{svgViewBoxZoom:c}=B(i=>i.param),{selected:n,refresh:{nodes:l,edges:g},mode:u,active:y,keepLastPath:p,theme:b}=B(i=>i.runtime),[S,L]=m.useState({x:0,y:0}),[N,_]=m.useState({x:0,y:0}),I=W((i,o)=>{o.stopPropagation();const a=o.currentTarget,{x:f,y:x}=K(o);a.setPointerCapture(o.pointerId),L({x:f,y:x}),e(F(i)),!o.shiftKey&&n.length<=1&&e(G()),e(Z(i))}),k=W((i,o)=>{o.stopPropagation();const{x:a,y:f}=K(o);u==="free"&&y===i?(n.forEach(x=>{t.current.updateNodeAttributes(x,v=>({...v,x:M(v.x-(S.x-a)*c/100,o.altKey?1:5),y:M(v.y-(S.y-f)*c/100,o.altKey?1:5)}))}),e(yt()),e(et())):u.startsWith("line")&&_({x:(S.x-a)*c/100,y:(S.y-f)*c/100})}),j=W((i,o)=>{if(o.stopPropagation(),u.startsWith("line")||u.startsWith("misc-edge"))p||e($("free")),["stn_core_","virtual_circle_"].forEach(f=>{var C,V;const v=(V=(C=document.elementsFromPoint(o.clientX,o.clientY)[0].attributes)==null?void 0:C.getNamedItem("id"))==null?void 0:V.value;if(v!=null&&v.startsWith(f)){const D=u.slice(5),pt=`line_${st(10)}`;t.current.addDirectedEdgeWithKey(pt,y,v.slice(f.length),{visible:!0,zIndex:0,type:D,[D]:JSON.parse(JSON.stringify(O[D].defaultAttrs)),style:U.SingleColor,[U.SingleColor]:{color:b},reconcileId:""}),s&&nt.event(rt.ADD_LINE,{type:D})}}),e(et()),e(ot(t.current.export()));else if(u==="free")if(y){const{x:a,y:f}=K(o);S.x-a===0&&S.y-f===0?e(Z(i)):e(ot(t.current.export()))}else e(Z(i));e(F(void 0))}),h=W((i,o)=>{e(G()),e(Z(i))}),[E,P]=m.useState(dt(t.current)),[Y,H]=m.useState(ut(t.current)),[R,z]=m.useState(Q(t.current)),[J,r]=m.useState([]),[d,A]=m.useState([]);return m.useEffect(()=>{P(dt(t.current)),H(ut(t.current))},[l]),m.useEffect(()=>{z(Q(t.current));const{allReconciledLines:i,danglingLines:o}=at(t.current);r(i),A(o)},[]),m.useEffect(()=>{z(Q(t.current));const{allReconciledLines:i,danglingLines:o}=at(t.current);r(i),A(o)},[g]),w.jsxs(w.Fragment,{children:[d.map(i=>{const[o,a]=t.current.extremities(i),f=t.current.getNodeAttributes(o),x=t.current.getNodeAttributes(a);return w.jsx(q,{id:i,x1:f.x,y1:f.y,x2:x.x,y2:x.y,newLine:!1,type:ct.Simple,attrs:O[ct.Simple].defaultAttrs,styleType:U.SingleColor,styleAttrs:{color:["","","#c0c0c0","#fff"]},handleClick:h},i)}),J.map(i=>{const o=wt(t.current,i);if(!o)return w.jsx(w.Fragment,{});const a=i.at(0),f=t.current.getEdgeAttribute(a,"type"),x=t.current.getEdgeAttribute(a,"style"),v=t.current.getEdgeAttribute(a,x),C=tt[x].component;return w.jsx(C,{id:a,type:f,path:o,styleAttrs:v,newLine:!1,handleClick:h},a)}),R.map(({edge:i,x1:o,y1:a,x2:f,y2:x,type:v,attr:C,style:V,styleAttr:D})=>w.jsx(q,{id:i,x1:o,y1:a,x2:f,y2:x,newLine:!1,type:v,attrs:C,styleType:V,styleAttrs:D,handleClick:h},i)),Y.map(i=>{const{node:o,x:a,y:f,type:x}=i,v=gt[x].component;return w.jsx(v,{id:o,x:a,y:f,attrs:i[x],handlePointerDown:I,handlePointerMove:k,handlePointerUp:j},o)}),E.map(i=>{const{node:o,x:a,y:f,type:x}=i,v=ft[x].component;return w.jsx(v,{id:o,x:a,y:f,attrs:{[x]:i[x]},handlePointerDown:I,handlePointerMove:k,handlePointerUp:j},o)}),u.startsWith("line")&&y&&w.jsx(q,{id:"create_in_progress___no_use",x1:t.current.getNodeAttribute(y,"x"),y1:t.current.getNodeAttribute(y,"y"),x2:t.current.getNodeAttribute(y,"x")-N.x,y2:t.current.getNodeAttribute(y,"y")-N.y,newLine:!0,type:u.slice(5),attrs:O[u.slice(5)].defaultAttrs,styleType:U.SingleColor,styleAttrs:{color:b}})]})},Nt=()=>{const[e,t]=it.useState({width:void 0,height:void 0});return it.useEffect(()=>{function s(){t({width:window.innerWidth,height:window.innerHeight})}return window.addEventListener("resize",s),s(),()=>window.removeEventListener("resize",s)},[]),e},zt=()=>{const e=lt(),t=m.useRef(window.graph),s=()=>{e(yt()),e(et()),e(ot(t.current.export()))},{telemetry:{project:c}}=B(r=>r.app),{svgViewBoxZoom:n,svgViewBoxMin:l}=B(r=>r.param),{mode:g,lastTool:u,active:y,selected:p,keepLastPath:b,theme:S,refresh:{nodes:L},nodeExists:N}=B(r=>r.runtime);m.useEffect(()=>{const r=JSON.parse(JSON.stringify(N));t.current.forEachNode(A=>{const i=t.current.getNodeAttribute(A,"type");r[i]=!0}),e(ht(r));let d;return r[xt.MTR]&&(d=document.createElement("link"),d.rel="stylesheet",d.id="fonts_mtr",d.href="/rmp//styles/fonts_mtr.css",document.head.append(d)),()=>{d&&document.head.removeChild(d)}},[L]);const[_,I]=m.useState({x:0,y:0}),[k,j]=m.useState({x:0,y:0}),h=W(r=>{const{x:d,y:A}=K(r);if(g.startsWith("station")){e($("free"));const i=st(10),o=g.slice(8),a=JSON.parse(JSON.stringify(ft[o].defaultAttrs));"color"in a&&(a.color=S),t.current.addNode(`stn_${i}`,{visible:!0,zIndex:0,x:M(d*n/100+l.x,10),y:M(A*n/100+l.y,10),type:o,[o]:a}),s(),c&&nt.event(rt.ADD_STATION,{type:o})}else if(g.startsWith("misc-node")){e($("free"));const i=st(10),o=g.slice(10);t.current.addNode(`misc_node_${i}`,{visible:!0,zIndex:0,x:M(d*n/100+l.x,10),y:M(A*n/100+l.y,10),type:o,[o]:JSON.parse(JSON.stringify(gt[o].defaultAttrs))}),s(),c&&nt.event(rt.ADD_STATION,{type:o})}else(g==="free"||g.startsWith("line"))&&(g.startsWith("line")&&(e($("free")),b&&e(mt(!1))),I({x:d,y:A}),j(l),r.shiftKey||(e(F("background")),e(G())))}),E=W(r=>{if(y==="background"){const{x:d,y:A}=K(r);e(X({x:k.x+(_.x-d)*n/100,y:k.y+(_.y-A)*n/100}))}}),P=W(r=>{y==="background"&&!r.shiftKey&&e(F(void 0))}),Y=W(r=>{let d=n;r.deltaY>0&&n+10<400?d=n+10:r.deltaY<0&&n-10>0&&(d=n-10),e(At(d));const{x:A,y:i}=K(r),o=r.currentTarget.getBoundingClientRect(),[a,f]=[A/o.width,i/o.height];e(X({x:l.x+A*n/100-J*d/100*a,y:l.y+i*n/100-z*d/100*f}))}),H=W(r=>{if(T?r.key==="Backspace":r.key==="Delete")p.length>0&&p.filter(d=>t.current.hasNode(d)||t.current.hasEdge(d)).forEach(d=>{e(G()),t.current.hasNode(d)?t.current.dropNode(d):t.current.dropEdge(d),s()});else if(r.key.startsWith("Arrow")){const A=r.key.endsWith("Left")?-1:r.key.endsWith("Right")?1:0,i=r.key.endsWith("Up")?-1:r.key.endsWith("Down")?1:0;e(X({x:l.x+100*n/100*A,y:l.y+100*n/100*i}))}else if(r.key==="i"||r.key==="j"||r.key==="k"||r.key==="l"){const A=(r.key==="j"?-1:r.key==="l"?1:0)*10,i=(r.key==="i"?-1:r.key==="k"?1:0)*10;p.length>0&&p.filter(o=>t.current.hasNode(o)).forEach(o=>{t.current.updateNodeAttribute(o,"x",a=>(a??0)+A),t.current.updateNodeAttribute(o,"y",a=>(a??0)+i),s()})}else r.key==="f"&&u?e($(u)):r.key==="z"&&(T?r.metaKey&&!r.shiftKey:r.ctrlKey)?(T&&r.preventDefault(),e(vt())):(T&&r.key==="z"&&r.metaKey&&r.shiftKey||!T&&r.key==="y"&&r.ctrlKey)&&e(bt())}),R=Nt(),z=(R.height??1280)-40,J=(R.width??720)-50;return w.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:50},height:z,width:J,viewBox:`${l.x} ${l.y} ${J*n/100} ${z*n/100}`,onPointerDown:h,onPointerMove:E,onPointerUp:P,onWheel:Y,tabIndex:0,onKeyDown:H,children:w.jsx(Et,{})})};export{zt as default};
