import{j as b}from"./chakra-e455e76b.js";import{b as x,r as dt}from"./react-beb26faf.js";import{u as L}from"./useEvent-32c835f5.js";import{ac as et,l as M,e as gt,z as B,ad as Y,j as q,ae as G,s as pt,f as st,ab as V,S as ht,J as vt,n as nt,c as J,r as rt,F as ot,h as it,L as ut,af as bt,P as wt,q as X,p as Et,a1 as St,a3 as kt}from"./index-dc5d0e90.js";import{s as xt}from"./stations-bdd375b0.js";import{m as mt}from"./misc-nodes-8046b086.js";import{g as K,r as D,i as R}from"./helpers-2fcbe9c8.js";const Q=e=>{const{id:t,type:n,attrs:u,styleType:r,styleAttrs:f=et[r].defaultAttrs,newLine:g,handleClick:l}=e,{x1:y,y1:p,x2:v,y2:m}=e,[k,E]=x.useState("M 0,0 L 0,0");x.useEffect(()=>{E(M[n].generatePath(y,v,p,m,u))},[n,JSON.stringify(u),y,v,p,m]);const N=et[r].component;return x.useMemo(()=>b.jsx(N,{id:t,type:n,path:k,styleAttrs:f,newLine:g,handleClick:l}),[t,n,k,r,JSON.stringify(f),g,l])},Nt=e=>{const t=e.filterDirectedEdges((u,r,f,g,l,y,p)=>u.startsWith("line")&&r.reconcileId!==""),n={};for(const u of t){const r=e.getEdgeAttribute(u,"reconcileId");r in n?n[r].push(u):n[r]=[u]}return n},lt=e=>{const t=Nt(e),n=[],u=[];return Object.values(t).forEach(r=>{var P;if(r.length===1){u.push(...r);return}const f=e.getEdgeAttribute(r.at(0),"type");if(!r.every(h=>e.getEdgeAttribute(h,"type")===f)){u.push(...r);return}const g=e.getEdgeAttribute(r.at(0),"style");if(!r.every(h=>e.getEdgeAttribute(h,"style")===g)){u.push(...r);return}const l={},y=new Set,p=new Set,v=Object.fromEntries(r.map(h=>{var C,W;const[w,I]=e.extremities(h);return l[w]=((C=l[w])!=null?C:0)+1,l[I]=((W=l[I])!=null?W:0)+1,y.add(w),p.add(I),[w,[h,I]]})),m=Array.from(y).filter(h=>l[h]===1),k=Array.from(p).filter(h=>l[h]===1);if(m.length!==1||k.length!==1){u.push(...r);return}const E=m[0],N=k[0];if(E===N){u.push(...r);return}const _=[v[E][0]];let S=v[E][1];for(let h=1;h<r.length;h=h+1){const w=(P=v[S])==null?void 0:P.at(1);if(!w){u.push(...r);return}_.push(v[S][0]),S=w}if(S!==N||_.length!==r.length){u.push(...r);return}n.push(_)}),{allReconciledLines:n,danglingLines:u}},Lt=(e,t)=>{if(!t.every(r=>e.hasEdge(r)))return;const n=t.map(r=>{var m;const[f,g]=e.extremities(r),l=e.getNodeAttributes(f),y=e.getNodeAttributes(g),p=e.getEdgeAttribute(r,"type"),v=(m=e.getEdgeAttribute(r,p))!=null?m:M[p].defaultAttrs;return M[p].generatePath(l.x,y.x,l.y,y.y,v)});let u=`${n[0]} `;for(let r=1;r<t.length;r=r+1)u+=n[r].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return u},yt=e=>e.filterNodes((t,n)=>t.startsWith("stn")).map(t=>[t,e.getNodeAttributes(t)]).filter(([t,n])=>n.visible).sort((t,n)=>t[1].zIndex-n[1].zIndex).map(([t,n])=>({node:t,visible:n.visible,zIndex:n.zIndex,x:n.x,y:n.y,type:n.type,[n.type]:n[n.type]})),tt=e=>e.filterDirectedEdges((t,n,u,r,f,g,l)=>t.startsWith("line")&&n.visible&&n.reconcileId==="").sort((t,n)=>e.getEdgeAttribute(t,"zIndex")-e.getEdgeAttribute(n,"zIndex")).map(t=>{const n=e.getEdgeAttribute(t,"type"),u=e.getEdgeAttribute(t,n),r=e.getEdgeAttribute(t,"style"),f=e.getEdgeAttribute(t,r),[g,l]=e.extremities(t),y=e.getNodeAttributes(g),p=e.getNodeAttributes(l);return{edge:t,x1:y.x,y1:y.y,x2:p.x,y2:p.y,type:n,attr:u,style:r,styleAttr:f}}),ft=e=>e.filterNodes((t,n)=>t.startsWith("misc_node")).map(t=>[t,e.getNodeAttributes(t)]).filter(([t,n])=>n.visible).sort((t,n)=>t[1].zIndex-n[1].zIndex).map(([t,n])=>({node:t,visible:n.visible,zIndex:n.zIndex,x:n.x,y:n.y,type:n.type,[n.type]:n[n.type]})),_t=()=>{const e=gt(),t=x.useRef(window.graph),{telemetry:{project:n}}=B(s=>s.app),{svgViewBoxZoom:u}=B(s=>s.param),{selected:r,refresh:{nodes:f,edges:g},mode:l,active:y,keepLastPath:p,theme:v}=B(s=>s.runtime),[m,k]=x.useState({x:0,y:0}),[E,N]=x.useState({x:0,y:0}),_=L((s,i)=>{i.stopPropagation();const a=i.currentTarget,{x:c,y:d}=K(i);a.setPointerCapture(i.pointerId),k({x:c,y:d}),e(Y(s)),!i.shiftKey&&r.length<=1&&e(q()),e(G(s))}),S=L((s,i)=>{i.stopPropagation();const{x:a,y:c}=K(i);l==="free"&&y===s?(r.forEach(d=>{t.current.updateNodeAttributes(d,A=>({...A,x:D(A.x-(m.x-a)*u/100,i.altKey?1:5),y:D(A.y-(m.y-c)*u/100,i.altKey?1:5)}))}),e(pt()),e(st())):l.startsWith("line")&&N({x:(m.x-a)*u/100,y:(m.y-c)*u/100})}),P=L((s,i)=>{if(i.stopPropagation(),l.startsWith("line")){p||e(V("free"));const a=[...Object.values(ht),vt.Virtual],c=t.current.hasNode(y)&&a.includes(t.current.getNodeAttribute(y,"type"));["stn_core_","virtual_circle_"].forEach(A=>{var ct,at;const z=(at=(ct=document.elementsFromPoint(i.clientX,i.clientY)[0].attributes)==null?void 0:ct.getNamedItem("id"))==null?void 0:at.value,H=z==null?void 0:z.startsWith(A);if(c&&H){const Z=l.slice(5),At=`line_${nt(10)}`;t.current.addDirectedEdgeWithKey(At,y,z.slice(A.length),{visible:!0,zIndex:0,type:Z,[Z]:structuredClone(M[Z].defaultAttrs),style:J.SingleColor,[J.SingleColor]:{color:v},reconcileId:""}),n&&rt.event(ot.ADD_LINE,{type:Z})}}),e(st()),e(it(t.current.export()))}else if(l==="free")if(y){const{x:a,y:c}=K(i);m.x-a===0&&m.y-c===0?e(G(s)):e(it(t.current.export()))}else e(G(s));e(Y(void 0))}),h=L((s,i)=>{e(q()),e(G(s))}),[w,I]=x.useState(yt(t.current)),[C,W]=x.useState(ft(t.current)),[$,j]=x.useState(tt(t.current)),[T,O]=x.useState([]),[F,o]=x.useState([]);return x.useEffect(()=>{I(yt(t.current)),W(ft(t.current))},[f]),x.useEffect(()=>{j(tt(t.current));const{allReconciledLines:s,danglingLines:i}=lt(t.current);O(s),o(i)},[]),x.useEffect(()=>{j(tt(t.current));const{allReconciledLines:s,danglingLines:i}=lt(t.current);O(s),o(i)},[g]),b.jsxs(b.Fragment,{children:[F.map(s=>{const[i,a]=t.current.extremities(s),c=t.current.getNodeAttributes(i),d=t.current.getNodeAttributes(a);return b.jsx(Q,{id:s,x1:c.x,y1:c.y,x2:d.x,y2:d.y,newLine:!1,type:ut.Simple,attrs:M[ut.Simple].defaultAttrs,styleType:J.SingleColor,styleAttrs:{color:["","","#c0c0c0","#fff"]},handleClick:h},s)}),T.map(s=>{const i=Lt(t.current,s);if(!i)return b.jsx(b.Fragment,{});const a=s.at(0),c=t.current.getEdgeAttribute(a,"type"),d=t.current.getEdgeAttribute(a,"style"),A=t.current.getEdgeAttribute(a,d),U=et[d].component;return b.jsx(U,{id:a,type:c,path:i,styleAttrs:A,newLine:!1,handleClick:h},a)}),$.map(({edge:s,x1:i,y1:a,x2:c,y2:d,type:A,attr:U,style:z,styleAttr:H})=>b.jsx(Q,{id:s,x1:i,y1:a,x2:c,y2:d,newLine:!1,type:A,attrs:U,styleType:z,styleAttrs:H,handleClick:h},s)),C.map(s=>{const{node:i,x:a,y:c,type:d}=s,A=mt[d].component;return b.jsx(A,{id:i,x:a,y:c,attrs:s[d],handlePointerDown:_,handlePointerMove:S,handlePointerUp:P},i)}),w.map(s=>{const{node:i,x:a,y:c,type:d}=s,A=xt[d].component;return b.jsx(A,{id:i,x:a,y:c,attrs:{[d]:s[d]},handlePointerDown:_,handlePointerMove:S,handlePointerUp:P},i)}),l.startsWith("line")&&y&&b.jsx(Q,{id:"create_in_progress___no_use",x1:t.current.getNodeAttribute(y,"x"),y1:t.current.getNodeAttribute(y,"y"),x2:t.current.getNodeAttribute(y,"x")-E.x,y2:t.current.getNodeAttribute(y,"y")-E.y,newLine:!0,type:l.slice(5),attrs:M[l.slice(5)].defaultAttrs,styleType:J.SingleColor,styleAttrs:{color:v}})]})},It=()=>{const[e,t]=dt.useState({width:void 0,height:void 0});return dt.useEffect(()=>{function n(){t({width:window.innerWidth,height:window.innerHeight})}return window.addEventListener("resize",n),n(),()=>window.removeEventListener("resize",n)},[]),e},Bt=()=>{var O,F;const e=gt(),t=x.useRef(window.graph),n=()=>{e(pt()),e(st()),e(it(t.current.export()))},{telemetry:{project:u}}=B(o=>o.app),{svgViewBoxZoom:r,svgViewBoxMin:f}=B(o=>o.param),{mode:g,lastTool:l,active:y,selected:p,keepLastPath:v,theme:m,refresh:{nodes:k},nodeExists:E}=B(o=>o.runtime);x.useEffect(()=>{const o=structuredClone(E);t.current.forEachNode(i=>{const a=t.current.getNodeAttribute(i,"type");o[a]=!0}),e(bt(o));let s;return o[ht.MTR]&&(s=document.createElement("link"),s.rel="stylesheet",s.id="fonts_mtr",s.href="/rmp//styles/fonts_mtr.css",document.head.append(s)),()=>{s&&document.head.removeChild(s)}},[k]);const[N,_]=x.useState({x:0,y:0}),[S,P]=x.useState({x:0,y:0}),h=L(o=>{const{x:s,y:i}=K(o);if(g.startsWith("station")){e(V("free"));const a=nt(10),c=g.slice(8),d=structuredClone(xt[c].defaultAttrs);"color"in d&&(d.color=m),t.current.addNode(`stn_${a}`,{visible:!0,zIndex:0,x:D(s*r/100+f.x,10),y:D(i*r/100+f.y,10),type:c,[c]:d}),n(),u&&rt.event(ot.ADD_STATION,{type:c})}else if(g.startsWith("misc-node")){e(V("free"));const a=nt(10),c=g.slice(10);t.current.addNode(`misc_node_${a}`,{visible:!0,zIndex:0,x:D(s*r/100+f.x,10),y:D(i*r/100+f.y,10),type:c,[c]:structuredClone(mt[c].defaultAttrs)}),n(),u&&rt.event(ot.ADD_STATION,{type:c})}else(g==="free"||g.startsWith("line"))&&(g.startsWith("line")&&(e(V("free")),v&&e(wt(!1))),_({x:s,y:i}),P(f),o.shiftKey||(e(Y("background")),e(q())))}),w=L(o=>{if(y==="background"){const{x:s,y:i}=K(o);e(X({x:S.x+(N.x-s)*r/100,y:S.y+(N.y-i)*r/100}))}}),I=L(o=>{y==="background"&&!o.shiftKey&&e(Y(void 0))}),C=L(o=>{let s=r;o.deltaY>0&&r+10<400?s=r+10:o.deltaY<0&&r-10>0&&(s=r-10),e(Et(s));const{x:i,y:a}=K(o),c=o.currentTarget.getBoundingClientRect(),[d,A]=[i/c.width,a/c.height];e(X({x:f.x+i*r/100-T*s/100*d,y:f.y+a*r/100-j*s/100*A}))}),W=L(o=>{if(R?o.key==="Backspace":o.key==="Delete")p.length>0&&p.filter(s=>t.current.hasNode(s)||t.current.hasEdge(s)).forEach(s=>{e(q()),t.current.hasNode(s)?t.current.dropNode(s):t.current.dropEdge(s),n()});else if(o.key.startsWith("Arrow")){const i=o.key.endsWith("Left")?-1:o.key.endsWith("Right")?1:0,a=o.key.endsWith("Up")?-1:o.key.endsWith("Down")?1:0;e(X({x:f.x+100*r/100*i,y:f.y+100*r/100*a}))}else if(o.key==="i"||o.key==="j"||o.key==="k"||o.key==="l"){const i=(o.key==="j"?-1:o.key==="l"?1:0)*10,a=(o.key==="i"?-1:o.key==="k"?1:0)*10;p.length>0&&p.filter(c=>t.current.hasNode(c)).forEach(c=>{t.current.updateNodeAttribute(c,"x",d=>(d!=null?d:0)+i),t.current.updateNodeAttribute(c,"y",d=>(d!=null?d:0)+a),n()})}else o.key==="f"&&l?e(V(l)):o.key==="z"&&(R?o.metaKey&&!o.shiftKey:o.ctrlKey)?(R&&o.preventDefault(),e(St())):(R&&o.key==="z"&&o.metaKey&&o.shiftKey||!R&&o.key==="y"&&o.ctrlKey)&&e(kt())}),$=It(),j=((O=$.height)!=null?O:1280)-40,T=((F=$.width)!=null?F:720)-40;return b.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40},height:j,width:T,viewBox:`${f.x} ${f.y} ${T*r/100} ${j*r/100}`,onPointerDown:h,onPointerMove:w,onPointerUp:I,onWheel:C,tabIndex:0,onKeyDown:W,children:b.jsx(_t,{})})};export{Bt as default};
