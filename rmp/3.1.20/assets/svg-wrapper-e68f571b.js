import{j as b}from"./chakra-1e9eecfc.js";import{b as m,r as it}from"./react-beb26faf.js";import{u as N}from"./useEvent-32c835f5.js";import{a8 as tt,l as B,e as lt,v as K,a9 as Y,j as H,aa as G,s as yt,f as et,a7 as V,n as st,c as J,r as nt,E as rt,h as ot,L as ct,ab as ht,S as xt,J as mt,p as X,o as At,Z as vt,$ as bt}from"./index-3076e358.js";import{s as ft}from"./stations-c951ea34.js";import{m as gt}from"./misc-nodes-aced6e55.js";import{g as T,r as M,i as O}from"./helpers-2fcbe9c8.js";const q=e=>{const{id:t,type:n,attrs:u,styleType:r,styleAttrs:y=tt[r].defaultAttrs,newLine:g,handleClick:l}=e,{x1:f,y1:p,x2:v,y2:A}=e,[k,E]=m.useState("M 0,0 L 0,0");m.useEffect(()=>{E(B[n].generatePath(f,v,p,A,u))},[n,JSON.stringify(u),f,v,p,A]);const L=tt[r].component;return m.useMemo(()=>b.jsx(L,{id:t,type:n,path:k,styleAttrs:y,newLine:g,handleClick:l}),[t,n,k,r,JSON.stringify(y),g,l])},wt=e=>{const t=e.filterDirectedEdges((u,r,y,g,l,f,p)=>u.startsWith("line")&&r.reconcileId!==""),n={};for(const u of t){const r=e.getEdgeAttribute(u,"reconcileId");r in n?n[r].push(u):n[r]=[u]}return n},at=e=>{const t=wt(e),n=[],u=[];return Object.values(t).forEach(r=>{var I;if(r.length===1){u.push(...r);return}const y=e.getEdgeAttribute(r.at(0),"type");if(!r.every(h=>e.getEdgeAttribute(h,"type")===y)){u.push(...r);return}const g=e.getEdgeAttribute(r.at(0),"style");if(!r.every(h=>e.getEdgeAttribute(h,"style")===g)){u.push(...r);return}const l={},f=new Set,p=new Set,v=Object.fromEntries(r.map(h=>{var P,C;const[w,W]=e.extremities(h);return l[w]=((P=l[w])!=null?P:0)+1,l[W]=((C=l[W])!=null?C:0)+1,f.add(w),p.add(W),[w,[h,W]]})),A=Array.from(f).filter(h=>l[h]===1),k=Array.from(p).filter(h=>l[h]===1);if(A.length!==1||k.length!==1){u.push(...r);return}const E=A[0],L=k[0];if(E===L){u.push(...r);return}const _=[v[E][0]];let S=v[E][1];for(let h=1;h<r.length;h=h+1){const w=(I=v[S])==null?void 0:I.at(1);if(!w){u.push(...r);return}_.push(v[S][0]),S=w}if(S!==L||_.length!==r.length){u.push(...r);return}n.push(_)}),{allReconciledLines:n,danglingLines:u}},Et=(e,t)=>{if(!t.every(r=>e.hasEdge(r)))return;const n=t.map(r=>{var A;const[y,g]=e.extremities(r),l=e.getNodeAttributes(y),f=e.getNodeAttributes(g),p=e.getEdgeAttribute(r,"type"),v=(A=e.getEdgeAttribute(r,p))!=null?A:B[p].defaultAttrs;return B[p].generatePath(l.x,f.x,l.y,f.y,v)});let u=`${n[0]} `;for(let r=1;r<t.length;r=r+1)u+=n[r].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return u},dt=e=>e.filterNodes((t,n)=>t.startsWith("stn")).map(t=>[t,e.getNodeAttributes(t)]).filter(([t,n])=>n.visible).sort((t,n)=>t[1].zIndex-n[1].zIndex).map(([t,n])=>({node:t,visible:n.visible,zIndex:n.zIndex,x:n.x,y:n.y,type:n.type,[n.type]:n[n.type]})),Q=e=>e.filterDirectedEdges((t,n,u,r,y,g,l)=>t.startsWith("line")&&n.visible&&n.reconcileId==="").sort((t,n)=>e.getEdgeAttribute(t,"zIndex")-e.getEdgeAttribute(n,"zIndex")).map(t=>{const n=e.getEdgeAttribute(t,"type"),u=e.getEdgeAttribute(t,n),r=e.getEdgeAttribute(t,"style"),y=e.getEdgeAttribute(t,r),[g,l]=e.extremities(t),f=e.getNodeAttributes(g),p=e.getNodeAttributes(l);return{edge:t,x1:f.x,y1:f.y,x2:p.x,y2:p.y,type:n,attr:u,style:r,styleAttr:y}}),ut=e=>e.filterNodes((t,n)=>t.startsWith("misc_node")).map(t=>[t,e.getNodeAttributes(t)]).filter(([t,n])=>n.visible).sort((t,n)=>t[1].zIndex-n[1].zIndex).map(([t,n])=>({node:t,visible:n.visible,zIndex:n.zIndex,x:n.x,y:n.y,type:n.type,[n.type]:n[n.type]})),St=()=>{const e=lt(),t=m.useRef(window.graph),{telemetry:{project:n}}=K(s=>s.app),{svgViewBoxZoom:u}=K(s=>s.param),{selected:r,refresh:{nodes:y,edges:g},mode:l,active:f,keepLastPath:p,theme:v}=K(s=>s.runtime),[A,k]=m.useState({x:0,y:0}),[E,L]=m.useState({x:0,y:0}),_=N((s,i)=>{i.stopPropagation();const a=i.currentTarget,{x:c,y:d}=T(i);a.setPointerCapture(i.pointerId),k({x:c,y:d}),e(Y(s)),!i.shiftKey&&r.length<=1&&e(H()),e(G(s))}),S=N((s,i)=>{i.stopPropagation();const{x:a,y:c}=T(i);l==="free"&&f===s?(r.forEach(d=>{t.current.updateNodeAttributes(d,x=>({...x,x:M(x.x-(A.x-a)*u/100,i.altKey?1:5),y:M(x.y-(A.y-c)*u/100,i.altKey?1:5)}))}),e(yt()),e(et())):l.startsWith("line")&&L({x:(A.x-a)*u/100,y:(A.y-c)*u/100})}),I=N((s,i)=>{if(i.stopPropagation(),l.startsWith("line")||l.startsWith("misc-edge"))p||e(V("free")),["stn_core_","virtual_circle_"].forEach(c=>{var z,F;const x=(F=(z=document.elementsFromPoint(i.clientX,i.clientY)[0].attributes)==null?void 0:z.getNamedItem("id"))==null?void 0:F.value;if(x!=null&&x.startsWith(c)){const D=l.slice(5),pt=`line_${st(10)}`;t.current.addDirectedEdgeWithKey(pt,f,x.slice(c.length),{visible:!0,zIndex:0,type:D,[D]:structuredClone(B[D].defaultAttrs),style:J.SingleColor,[J.SingleColor]:{color:v},reconcileId:""}),n&&nt.event(rt.ADD_LINE,{type:D})}}),e(et()),e(ot(t.current.export()));else if(l==="free")if(f){const{x:a,y:c}=T(i);A.x-a===0&&A.y-c===0?e(G(s)):e(ot(t.current.export()))}else e(G(s));e(Y(void 0))}),h=N((s,i)=>{e(H()),e(G(s))}),[w,W]=m.useState(dt(t.current)),[P,C]=m.useState(ut(t.current)),[Z,j]=m.useState(Q(t.current)),[$,R]=m.useState([]),[U,o]=m.useState([]);return m.useEffect(()=>{W(dt(t.current)),C(ut(t.current))},[y]),m.useEffect(()=>{j(Q(t.current));const{allReconciledLines:s,danglingLines:i}=at(t.current);R(s),o(i)},[]),m.useEffect(()=>{j(Q(t.current));const{allReconciledLines:s,danglingLines:i}=at(t.current);R(s),o(i)},[g]),b.jsxs(b.Fragment,{children:[U.map(s=>{const[i,a]=t.current.extremities(s),c=t.current.getNodeAttributes(i),d=t.current.getNodeAttributes(a);return b.jsx(q,{id:s,x1:c.x,y1:c.y,x2:d.x,y2:d.y,newLine:!1,type:ct.Simple,attrs:B[ct.Simple].defaultAttrs,styleType:J.SingleColor,styleAttrs:{color:["","","#c0c0c0","#fff"]},handleClick:h},s)}),$.map(s=>{const i=Et(t.current,s);if(!i)return b.jsx(b.Fragment,{});const a=s.at(0),c=t.current.getEdgeAttribute(a,"type"),d=t.current.getEdgeAttribute(a,"style"),x=t.current.getEdgeAttribute(a,d),z=tt[d].component;return b.jsx(z,{id:a,type:c,path:i,styleAttrs:x,newLine:!1,handleClick:h},a)}),Z.map(({edge:s,x1:i,y1:a,x2:c,y2:d,type:x,attr:z,style:F,styleAttr:D})=>b.jsx(q,{id:s,x1:i,y1:a,x2:c,y2:d,newLine:!1,type:x,attrs:z,styleType:F,styleAttrs:D,handleClick:h},s)),P.map(s=>{const{node:i,x:a,y:c,type:d}=s,x=gt[d].component;return b.jsx(x,{id:i,x:a,y:c,attrs:s[d],handlePointerDown:_,handlePointerMove:S,handlePointerUp:I},i)}),w.map(s=>{const{node:i,x:a,y:c,type:d}=s,x=ft[d].component;return b.jsx(x,{id:i,x:a,y:c,attrs:{[d]:s[d]},handlePointerDown:_,handlePointerMove:S,handlePointerUp:I},i)}),l.startsWith("line")&&f&&b.jsx(q,{id:"create_in_progress___no_use",x1:t.current.getNodeAttribute(f,"x"),y1:t.current.getNodeAttribute(f,"y"),x2:t.current.getNodeAttribute(f,"x")-E.x,y2:t.current.getNodeAttribute(f,"y")-E.y,newLine:!0,type:l.slice(5),attrs:B[l.slice(5)].defaultAttrs,styleType:J.SingleColor,styleAttrs:{color:v}})]})},kt=()=>{const[e,t]=it.useState({width:void 0,height:void 0});return it.useEffect(()=>{function n(){t({width:window.innerWidth,height:window.innerHeight})}return window.addEventListener("resize",n),n(),()=>window.removeEventListener("resize",n)},[]),e},jt=()=>{var R,U;const e=lt(),t=m.useRef(window.graph),n=()=>{e(yt()),e(et()),e(ot(t.current.export()))},{telemetry:{project:u}}=K(o=>o.app),{svgViewBoxZoom:r,svgViewBoxMin:y}=K(o=>o.param),{mode:g,lastTool:l,active:f,selected:p,keepLastPath:v,theme:A,refresh:{nodes:k},nodeExists:E}=K(o=>o.runtime);m.useEffect(()=>{const o=structuredClone(E);t.current.forEachNode(i=>{const a=t.current.getNodeAttribute(i,"type");o[a]=!0}),e(ht(o));let s;return o[xt.MTR]&&(s=document.createElement("link"),s.rel="stylesheet",s.id="fonts_mtr",s.href="/rmp//styles/fonts_mtr.css",document.head.append(s)),()=>{s&&document.head.removeChild(s)}},[k]);const[L,_]=m.useState({x:0,y:0}),[S,I]=m.useState({x:0,y:0}),h=N(o=>{const{x:s,y:i}=T(o);if(g.startsWith("station")){e(V("free"));const a=st(10),c=g.slice(8),d=structuredClone(ft[c].defaultAttrs);"color"in d&&(d.color=A),t.current.addNode(`stn_${a}`,{visible:!0,zIndex:0,x:M(s*r/100+y.x,10),y:M(i*r/100+y.y,10),type:c,[c]:d}),n(),u&&nt.event(rt.ADD_STATION,{type:c})}else if(g.startsWith("misc-node")){e(V("free"));const a=st(10),c=g.slice(10);t.current.addNode(`misc_node_${a}`,{visible:!0,zIndex:0,x:M(s*r/100+y.x,10),y:M(i*r/100+y.y,10),type:c,[c]:structuredClone(gt[c].defaultAttrs)}),n(),u&&nt.event(rt.ADD_STATION,{type:c})}else(g==="free"||g.startsWith("line"))&&(g.startsWith("line")&&(e(V("free")),v&&e(mt(!1))),_({x:s,y:i}),I(y),o.shiftKey||(e(Y("background")),e(H())))}),w=N(o=>{if(f==="background"){const{x:s,y:i}=T(o);e(X({x:S.x+(L.x-s)*r/100,y:S.y+(L.y-i)*r/100}))}}),W=N(o=>{f==="background"&&!o.shiftKey&&e(Y(void 0))}),P=N(o=>{let s=r;o.deltaY>0&&r+10<400?s=r+10:o.deltaY<0&&r-10>0&&(s=r-10),e(At(s));const{x:i,y:a}=T(o),c=o.currentTarget.getBoundingClientRect(),[d,x]=[i/c.width,a/c.height];e(X({x:y.x+i*r/100-$*s/100*d,y:y.y+a*r/100-j*s/100*x}))}),C=N(o=>{if(O?o.key==="Backspace":o.key==="Delete")p.length>0&&p.filter(s=>t.current.hasNode(s)||t.current.hasEdge(s)).forEach(s=>{e(H()),t.current.hasNode(s)?t.current.dropNode(s):t.current.dropEdge(s),n()});else if(o.key.startsWith("Arrow")){const i=o.key.endsWith("Left")?-1:o.key.endsWith("Right")?1:0,a=o.key.endsWith("Up")?-1:o.key.endsWith("Down")?1:0;e(X({x:y.x+100*r/100*i,y:y.y+100*r/100*a}))}else if(o.key==="i"||o.key==="j"||o.key==="k"||o.key==="l"){const i=(o.key==="j"?-1:o.key==="l"?1:0)*10,a=(o.key==="i"?-1:o.key==="k"?1:0)*10;p.length>0&&p.filter(c=>t.current.hasNode(c)).forEach(c=>{t.current.updateNodeAttribute(c,"x",d=>(d!=null?d:0)+i),t.current.updateNodeAttribute(c,"y",d=>(d!=null?d:0)+a),n()})}else o.key==="f"&&l?e(V(l)):o.key==="z"&&(O?o.metaKey&&!o.shiftKey:o.ctrlKey)?(O&&o.preventDefault(),e(vt())):(O&&o.key==="z"&&o.metaKey&&o.shiftKey||!O&&o.key==="y"&&o.ctrlKey)&&e(bt())}),Z=kt(),j=((R=Z.height)!=null?R:1280)-40,$=((U=Z.width)!=null?U:720)-50;return b.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:50},height:j,width:$,viewBox:`${y.x} ${y.y} ${$*r/100} ${j*r/100}`,onPointerDown:h,onPointerMove:w,onPointerUp:W,onWheel:P,tabIndex:0,onKeyDown:C,children:b.jsx(St,{})})};export{jt as default};
