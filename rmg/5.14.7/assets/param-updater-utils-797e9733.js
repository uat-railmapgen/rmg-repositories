import{u as S,j as l,c as T,e as p,an as C,a3 as O,M as I,a4 as A,q as D,r as P,s as E,v as N,d as k,Q as W,B as F,G as x,t as B}from"./chakra-81918c77.js";import{r as b}from"./react-50230a52.js";import{k as L,ax as z,b1 as $,b2 as U,aw as G,b as R,b3 as j,b4 as Y,m as J,r as h,aV as f,e as v,b5 as V,i as Z}from"./index-fa392ebd.js";var H=function(e){var n=e.children,s=e.noWrap,i=S("RmgOutput",{noWrap:s});return l.jsx(T.output,{sx:i,children:n})};function q(e){var n=e.fields,s=e.noLabel,i=e.minW;return l.jsx(p,{wrap:"wrap",children:n.map(function(r,c){if(r.hidden)return l.jsx(b.Fragment,{},c);var a=r.minW||i,d=a==="full";return l.jsx(L,{className:d?"mw-full":"",label:r.label,flex:d?void 0:1,minW:d?void 0:a,noLabel:s,oneLine:r.oneLine,children:function(t){switch(t.type){case"input":return l.jsx(G,{placeholder:t.placeholder,defaultValue:t.value,type:t.variant,validator:t.validator,onDebouncedChange:t.onChange,delay:t.debouncedDelay,optionList:t.optionList,isDisabled:t.isDisabled});case"output":return l.jsx(H,{noWrap:!0,children:t.value});case"textarea":return l.jsx(U,{placeholder:t.placeholder,defaultValue:t.value,onDebouncedChange:t.onChange,isDisabled:t.isDisabled});case"slider":return l.jsx($,{defaultValue:t.value,min:t.min,max:t.max,step:t.step,onThrottledChange:t.onChange,leftIcon:t.leftIcon,rightIcon:t.rightIcon,isDisabled:t.isDisabled});case"select":return l.jsx(z,{defaultValue:t.value,onChange:function(o){var g,u=o.target.value;return(g=t.onChange)===null||g===void 0?void 0:g.call(t,typeof t.value=="number"?Number(u):u.toString())},options:t.options,disabledOptions:t.disabledOptions,isInvalid:t.isInvalid,isDisabled:t.isDisabled});case"switch":return l.jsx(C,{isChecked:t.isChecked,isDisabled:t.isDisabled,onChange:function(o){var g,u=o.target.checked;return(g=t.onChange)===null||g===void 0?void 0:g.call(t,u)}});case"custom":return t.component;default:return l.jsx("div",{})}}(r)},c)})})}let M=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce((n,s)=>(s&=63,s<36?n+=s.toString(36):s<62?n+=(s-26).toString(36).toUpperCase():s>62?n+="-":n+="_",n),"");const ae=(e,n,s)=>{const i=new Blob([s],{type:n});K(e,i)},K=(e,n)=>{const s=window.URL.createObjectURL(n),i=document.createElement("a");i.href=s,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),window.URL.revokeObjectURL(s)},de=e=>new Promise(n=>{const s=new FileReader;s.onloadend=()=>n(s.result),s.readAsText(e)}),ue=()=>navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome"),Q=e=>{if(e){const n=new Date().getTime()-e;return n<60*1e3?["Just now"]:n<2*60*1e3?["1","minute ago"]:n<60*60*1e3?[Math.floor(n/1e3/60).toString(),"minutes ago"]:n<2*60*60*1e3?["1","hour ago"]:n<24*60*60*1e3?[Math.floor(n/1e3/60/60).toString(),"hours ago"]:n<48*60*60*1e3?["1","day ago"]:[Math.floor(n/1e3/60/60/24).toString(),"days ago"]}else return["Unknown"]},ge=e=>new Promise(n=>{setTimeout(n,e)});function X(e){var o;const{config:n,onClose:s,onUpdate:i}=e,{t:r}=R(),[c,a]=b.useState((o=n==null?void 0:n.name)!=null?o:"");b.useEffect(()=>{var g;n&&a((g=n.name)!=null?g:"")},[n]);const d=[{type:"input",label:r("Project name"),value:c,onChange:a,debouncedDelay:0}],t=()=>{var g;n&&((g=n.name)!=null?g:"")!==c&&i({...n,name:c})};return l.jsxs(O,{isOpen:!!n,onClose:s,isCentered:!0,children:[l.jsx(I,{}),l.jsxs(A,{children:[l.jsx(D,{children:r("Edit project info")}),l.jsx(P,{}),l.jsx(E,{children:l.jsx(q,{fields:d})}),l.jsx(N,{children:l.jsx(k,{colorScheme:"primary",onClick:t,children:r("Confirm")})})]})]})}const ee={flex:"2 1 0%",overflow:"hidden",minW:{base:"unset",md:240},w:{base:"100%",md:"unset"},mr:{base:0,md:2},mb:{base:2,md:0},"& > div":{flexDirection:"column",h:200,overflowX:"hidden",overflowY:"auto",borderRadius:"md",borderWidth:2,"& >.chakra-button":{alignItems:"center"},"& .chakra-button__group":{"& button:not(:first-of-type)":{h:"100%"}}}};function he(e){const{paramRegistry:n,downloading:s,selectedParam:i,onParamSelect:r,onParamRemove:c,onParamUpdate:a}=e,{t:d}=R(),[t,o]=b.useState(),g=u=>{a==null||a(u),o(void 0)};return l.jsxs(W,{sx:ee,children:[l.jsxs(p,{children:[s&&l.jsx(j,{variant:"ghost",primaryText:d("Downloading")+"...",secondaryText:s,isDisabled:!0}),n.slice().sort((u,_)=>{var y,m;return((y=_.lastModified)!=null?y:0)-((m=u.lastModified)!=null?m:0)}).map(u=>{var _;return l.jsxs(F,{size:"sm",isAttached:!0,colorScheme:i===u.id?"primary":void 0,variant:i===u.id?"solid":"ghost",children:[l.jsx(j,{primaryText:(_=u.name)!=null?_:d("Project")+" "+u.id,secondaryText:d("Last modified")+": "+Q(u.lastModified).map(y=>d(y)).join(" "),"aria-pressed":i===u.id,onClick:()=>r(u.id)}),a&&l.jsx(x,{"aria-label":d("Edit project info"),title:d("Edit project info"),icon:l.jsx(Y,{}),onClick:()=>o(u)}),c&&l.jsx(x,{"aria-label":d("Remove project"),title:d("Remove project"),icon:l.jsx(J,{}),onClick:()=>c(u.id)})]},u.id)})]}),n.length>=10&&l.jsx(B,{as:"em",fontSize:"xs",children:d("You have reached the maximum number of projects.")}),l.jsx(X,{config:t,onClose:()=>o(void 0),onUpdate:g})]})}const te=()=>{const e="".concat(h.getAppName(),"__").concat(f.PARAM_CONFIG_BY_ID),n=Object.entries(h.storage.getAll()).filter(([s])=>s.startsWith(e)).map(([s,i])=>{const r=s.slice(e.length);if(i)try{return{...JSON.parse(i),id:r}}catch(c){return{id:r}}else return{id:r}});return console.log("loadParamRegistry():: Found param config in localStorage",n.map(s=>s.id)),n},fe=()=>{const e=te(),n="".concat(h.getAppName(),"__").concat(f.PARAM_BY_ID),s=Object.keys(h.storage.getAll()).filter(i=>i.startsWith(n)).map(i=>{var c;const r=i.slice(n.length);return(c=e.find(a=>a.id===r))!=null?c:{id:r}});return console.log("getParamRegistry():: Actual param found in localStorage",s.map(i=>i.id)),e.filter(i=>s.every(r=>r.id!==i.id)).forEach(i=>h.storage.remove(f.PARAM_CONFIG_BY_ID+i.id)),s},_e=e=>{const n=h.storage.get(f.PARAM_CONFIG_BY_ID+e),s=h.storage.get(f.PARAM_BY_ID+e);return{param:s&&JSON.parse(s),config:n&&JSON.parse(n)}},ne=(e,n)=>{const s=M();return h.storage.set(f.PARAM_BY_ID+s,e),h.storage.set(f.PARAM_CONFIG_BY_ID+s,JSON.stringify({name:n,lastModified:Date.now()})),s},ye=async e=>{const n=e.split("/").at(-1);try{const s=await fetch(e);if(s.ok){const i=await s.text();return ne(i,n)}else return console.warn("Failed to download param"),null}catch(s){return console.warn("Failed to download param.",s),null}},be=e=>{var n,s,i,r,c,a,d;"line_name"in e||(e.line_name=["路線名","Name of Line"]),"dest_legacy"in e||(e.dest_legacy=!1),delete e.fontZH,delete e.fontEN,delete e.weightZH,delete e.weightEN;for(const[t,o]of Object.entries(e.stn_list))"branch"in o||(e.stn_list[t].branch={left:[],right:[]},o.children.length===2?e.stn_list[t].branch.right=["through",o.children[1]]:e.stn_list[t].branch.right=[],o.parents.length===2?e.stn_list[t].branch.left=["through",o.parents[1]]:e.stn_list[t].branch.left=[]);"psd_num"in e?e.psd_num=e.psd_num.toString():e.psd_num="1","line_num"in e||(e.line_num="1"),e.theme.length===3&&e.theme.push("#fff");for(const[t,o]of Object.entries(e.stn_list))"num"in o||(e.stn_list[t].num="00"),"interchange"in o&&o.interchange.map(g=>g.forEach(u=>{u.length===5&&u.splice(3,0,"#fff")}));for(const[t,o]of Object.entries(e.stn_list))o.change_type==="osi22_end_p"&&(e.stn_list[t].change_type="osi22_pr"),o.change_type==="osi22_end_u"&&(e.stn_list[t].change_type="osi22_ur");for(const[t,o]of Object.entries(e.stn_list))"interchange"in o||(e.stn_list[t].interchange=[[]]);"info_panel_type"in e?e.info_panel_type=(t=>{switch(t){case"gz_1":case"panasonic":return"gz28";case"gz_2":return"gz6";case"gz_3":return"gz3";default:return t}})(e.info_panel_type):e.info_panel_type="gz28","direction_gz_x"in e||(e.direction_gz_x=50),"direction_gz_y"in e||(e.direction_gz_y=70);for(const[t,o]of Object.entries(e.stn_list))"transfer"in o||(e.stn_list[t].transfer={tick_direc:o.change_type==="none"||o.change_type==="int2"?"r":(n=o.change_type)==null?void 0:n.split("_")[1].split("").slice().reverse()[0],paid_area:((s=o.change_type)==null?void 0:s.indexOf("osi"))!==-1?((i=o.change_type)==null?void 0:i.split("_")[1][0])==="p":!0,osi_names:((r=o.change_type)==null?void 0:r.indexOf("osi"))!==-1?[o.interchange[1][0]]:[],info:o.interchange.length===2?[o.interchange[0],o.interchange[1].slice(1)]:o.interchange}),delete e.stn_list[t].change_type,delete e.stn_list[t].interchange;for(const[t,o]of Object.entries(e.stn_list))"services"in o||(e.stn_list[t].services=["local"]),"facility"in o||("usage"in o?e.stn_list[t].facility=o.usage:e.stn_list[t].facility=""),delete e.stn_list[t].usage;"customiseMTRDest"in e||(e.customiseMTRDest={isLegacy:e.dest_legacy||!1,terminal:!1}),delete e.dest_legacy,"svgWidth"in e||(e.svgWidth={destination:e.svg_dest_width,runin:e.svg_dest_width,railmap:e.svg_width,indoor:e.svg_width}),"indoor"in e.svgWidth||(e.svgWidth.indoor=e.svgWidth.railmap),delete e.svg_width,delete e.svg_dest_width,"notesGZMTR"in e||(e.notesGZMTR=[]),e.notesGZMTR=(c=e.notesGZMTR)==null?void 0:c.map(t=>t.length===4?t.concat([!1]):t),delete e.char_form,delete e.show_outer,delete e.strip_pc,delete e.txt_bg_gap,"namePosMTR"in e||(e.namePosMTR={isStagger:!0,isFlip:e.txt_flip}),delete e.txt_flip,Object.keys(e.stn_list).forEach(t=>{"secondaryName"in e.stn_list[t]?e.stn_list[t].secondaryName!==!1&&e.stn_list[t].secondaryName.join()===","&&(e.stn_list[t].secondaryName=!1):e.stn_list[t].secondaryName=!1,"type"in e.stn_list[t].transfer&&delete e.stn_list[t].transfer.type}),e.style=e.style===void 0||!Object.values(v).includes(e.style)?v.MTR:e.style,e.coline=(a=e.coline)!=null?a:[],e.loop=(d=e.loop)!=null?d:!1,e.loop_info=e.loop_info===void 0?{bank:!0,left_and_right_factor:0,bottom_factor:1}:{...e.loop_info,bottom_factor:Math.max(e.loop_info.bottom_factor,1)};for(const[t,o]of Object.entries(e.stn_list))"loop_pivot"in o||(e.stn_list[t].loop_pivot=!1);return Array.isArray(e.coline)&&(e.coline=e.coline.reduce((t,o)=>({...t,[M(4)]:o}),{})),e.platform_num===!1&&(e.platform_num=""),Object.values(e.stn_list).forEach(t=>{var g,u;const o=t;o.one_line=(g=o.one_line)!=null?g:!1,o.int_padding=(u=o.int_padding)!=null?u:e.loop?250:355}),e.branchSpacingPct===void 0&&(e.style===v.SHMetro?e.branchSpacingPct=Math.round(e.branch_spacing/e.svg_height*300):e.branchSpacingPct=Math.round(e.branch_spacing/e.svg_height*200),delete e.branch_spacing),se(e),e},se=e=>{for(const[n,s]of Object.entries(e.stn_list)){const i=s.transfer.info;i&&(e.stn_list[n].transfer.groups=i.map((r,c)=>r.length?{name:s.transfer.osi_names[c-1],lines:r.map(a=>{const d=a;return{theme:d.slice(0,4),name:d.slice(4,6)}})}:{lines:[]})),delete e.stn_list[n].transfer.info,delete e.stn_list[n].transfer.osi_names}},w=e=>e.length===4&&e.every(n=>typeof n=="string")&&!!e[2].match(/^#[0-9a-fA-F]{6}$/)&&Object.values(Z).includes(e[3]),oe=e=>{const n=[],s=(i,r)=>{if(Array.isArray(i)&&w(i)){n.push({path:r||"",value:i});return}for(const c in i){const a=i[c],d=r?"".concat(r,".").concat(c):c;Array.isArray(a)?w(a)?n.push({path:d,value:a}):a.forEach((t,o)=>s(t,"".concat(d,".").concat(o))):a&&typeof a=="object"&&s(a,d)}};return s(e),n},ie=(e,n,s)=>{const i=n.split(".");let r=e;for(let c=0;c<i.length-1;c++)r=r[i[c]];r[i[i.length-1]]=s},ve=async e=>{const n=new Date().getTime(),s=oe(e);console.log("[rmg] Found all themes pending for update",s);const i=JSON.parse(JSON.stringify(e)),r=5e3;let c,a=!1;const d=new Promise((t,o)=>{c=setTimeout(()=>{a=!0,o("Executing time exceeds ".concat(r,"ms"))},r),(async()=>{for(const{path:g,value:u}of s){if(a)throw new Error("Update aborted");const _=await V(u);ie(i,g,_)}})().then(t).catch(o)});try{return await d,console.log("[rmg] Themes update completed, elapsed time ".concat((new Date().getTime()-n)/1e3," sec")),i}catch(t){return console.warn("[rmg] Error occurs when updating themes, elapsed time ".concat((new Date().getTime()-n)/1e3," sec"),t),i}finally{clearTimeout(c)}};export{he as P,q as R,ae as a,ne as b,_e as c,K as d,ve as e,ye as f,fe as g,ue as i,M as n,de as r,be as u,ge as w};
