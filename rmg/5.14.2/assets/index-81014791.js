import{j as e}from"./chakra-81918c77.js";import{r as h}from"./react-50230a52.js";import{i as P,be as T,u as j,x as J,S as p,bc as v,a3 as B}from"./index-8982d5e2.js";import{a as q,c as _,b as K,d as Q,S as G}from"./share-493a5ba5.js";import{i as ee}from"./param-updater-utils-f07ce729.js";function te(n){const{num:t,inStrip:a,...r}=n;return e.jsxs("g",{textAnchor:"middle",fill:a?P.black:"var(--rmg-theme-fg)",...r,children:[e.jsx("rect",{height:40,width:40,rx:4,x:-20,fill:a?"#fff":"var(--rmg-theme-colour)"}),e.jsx("text",{className:"rmg-name__en",fontSize:20,dy:12,children:t}),e.jsx("text",{className:"rmg-name__zh",fontSize:12,dy:26,children:"屏蔽门"}),e.jsx("text",{className:"rmg-name__en",fontSize:6.5,dy:36,children:"Screen Door"})]})}const Z=n=>{const t=(s=>{switch(s){case"gz28":case"gz2otis":case"gz6":case"gzgf":return 60;case"gz1":case"gz3":return 40;case"gz4":case"gz5":case"gz1421":return 20;default:return 0}})(n.variant),a=h.useMemo(()=>{switch(n.variant){case"gz1":return e.jsx("circle",{cy:-58,r:16,fill:"red"});case"gz28":case"gz2otis":return e.jsx("ellipse",{cy:-30,rx:24,ry:12,fill:"orange"});case"gz3":return e.jsx("rect",{x:-15,y:-55,height:30,width:30,fill:"red"});case"gz6":return e.jsx("ellipse",{cy:-30,rx:24,ry:12,fill:"white"});case"gz1421":return e.jsx("ellipse",{cy:-38,rx:24,ry:12,fill:"orange"});case"gz5":return e.jsx("rect",{x:-30,y:-70,height:30,width:60,fill:"orange"});case"gz4":return e.jsx("rect",{x:-50,y:-50,height:25,width:100,fill:"whitesmoke"});case"gzgf":return e.jsx("rect",{x:-30,y:-58,height:30,width:60,fill:"orange"});default:return e.jsx(e.Fragment,{})}},[n.variant]),r=-20;return e.jsxs("g",{transform:"translate(0,".concat(n.variant==="gz4"?r:0,")"),children:[e.jsx("rect",{id:"strip_gz",style:{"--height":"".concat(t,"px")}}),e.jsx("g",{style:{transform:"translate(calc(var(--rmg-svg-width) / 2),var(--rmg-svg-height))"},children:n.isShowLight&&a}),n.isShowPSD!==!1&&e.jsx(ne,{...n})]})},ne=h.memo(function(t){const a=["gz28","gz2otis","gz6","gzgf"].includes(t.variant),r=(s=>{switch(s){case"gz1":case"gz3":return"82px";case"gz4":return"65px";case"gz5":return"80px";case"gz1421":return"62px";default:return"58px"}})(t.variant);return e.jsx(te,{num:t.isShowPSD,inStrip:a,style:{"--psd-dy":r,transform:"translate(var(--translate-x), var(--translate-y))","--translate-x":"calc(var(--rmg-svg-width) / 2 + 80px)","--translate-y":"calc(var(--rmg-svg-height) - var(--psd-dy, 58px))"}})},(n,t)=>n.variant===t.variant&&n.isShowPSD===t.isShowPSD);var re=globalThis&&globalThis.__read||function(n,t){var a=typeof Symbol=="function"&&n[Symbol.iterator];if(!a)return n;var r=a.call(n),s,o=[],i;try{for(;(t===void 0||t-- >0)&&!(s=r.next()).done;)o.push(s.value)}catch(c){i={error:c}}finally{try{s&&!s.done&&(a=r.return)&&a.call(r)}finally{if(i)throw i.error}}return o};const se=h.memo(function(t){var a=t.lineName,r=t.commonPart,s=h.useRef(null),o=re(h.useState({x:0,height:0,width:0}),2),i=o[0],c=o[1];h.useEffect(function(){s.current&&c(s.current.getBBox())},[a.toString()]);var m=$/Math.max($,i.width),l=(-i.x-i.width/2)*m,d=i.height*(1-m)*1.2/2;return e.jsx("g",{ref:s,transform:"translate(".concat(l,",").concat(d,")scale(").concat(m,")"),children:e.jsxs("text",{className:"rmg-name__zh",fontSize:14,y:12,textAnchor:"end",children:[r,e.jsx("tspan",{className:"rmg-name__zh",fontSize:8,x:0,dy:-2,textAnchor:"start",children:a[0].slice(r.length).trim()}),e.jsx("tspan",{className:"rmg-name__en",fontSize:4,x:0,dy:6,textAnchor:"start",children:a[1].slice(r.length).trim()})]})})},function(n,t){return n.lineName.toString()===t.lineName.toString()});var O=globalThis&&globalThis.__assign||function(){return O=Object.assign||function(n){for(var t,a=1,r=arguments.length;a<r;a++){t=arguments[a];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(n[s]=t[s])}return n},O.apply(this,arguments)};function ae(n){return e.jsx("rect",O({x:-22.5,height:24,width:45,rx:4.5},n))}var A=globalThis&&globalThis.__read||function(n,t){var a=typeof Symbol=="function"&&n[Symbol.iterator];if(!a)return n;var r=a.call(n),s,o=[],i;try{for(;(t===void 0||t-- >0)&&!(s=r.next()).done;)o.push(s.value)}catch(c){i={error:c}}finally{try{s&&!s.done&&(a=r.return)&&a.call(r)}finally{if(i)throw i.error}}return o},$=42;const U=h.memo(function(t){var a=t.lineName,r=t.foregroundColour,s=t.backgroundColour,o=t.passed,i=A(ie(a),2),c=i[0],m=i[1],l=h.useRef(null),d=h.useRef(null),g=A(h.useState({width:0}),2),x=g[0],f=g[1],u=A(h.useState({width:0}),2),z=u[0],S=u[1];h.useEffect(function(){l.current&&f(l.current.getBBox()),d.current&&S(d.current.getBBox())},[a.toString()]);var w=$/Math.max($,x.width),b=$/Math.max($,z.width),R={nameZh:{y:7.3+13.5*(1-w)*w/2},nameEn:{y:19.5-9*(1-b)*b/2}};return e.jsxs("g",{textAnchor:"middle",fill:o?P.white:r,children:[e.jsx(ae,{fill:o?"#aaa":s}),c===2?e.jsx(se,{lineName:a,commonPart:m}):e.jsxs(e.Fragment,{children:[e.jsx("text",{ref:l,className:"rmg-name__zh",fontSize:12,transform:"translate(0,".concat(R.nameZh.y,")scale(").concat(w,")"),children:c===1?e.jsxs(e.Fragment,{children:[e.jsx("tspan",{fontSize:16,dy:.7,className:"rmg-name__zh",children:m}),e.jsx("tspan",{dy:-.7,className:"rmg-name__zh",children:a[0].slice(m.length)})]}):a[0]}),e.jsx("text",{ref:d,className:"rmg-name__en",fontSize:8,transform:"translate(0,".concat(R.nameEn.y,")scale(").concat(b,")"),children:a[1]})]})]})},function(n,t){return n.lineName.toString()===t.lineName.toString()&&n.foregroundColour===t.foregroundColour&&n.backgroundColour===t.backgroundColour&&n.passed===t.passed});var ie=function(n){var t=n[0].match(/^(\d+)\D+$/);if(t)return[1,t[1]];var a=n.map(function(r){return r.match(/^(\w+).+$/)});return a[0]&&a[1]&&a[0][1]===a[1][1]?[2,a[0][1]]:[3,""]};const oe=h.memo(function(t){var a=t.stroke,r=t.large,s=r?"M0,12.95 V-12.95 H-12.95 a12.95,12.95 0 0,0 0,25.9 h25.9 a12.95,12.95 0 0,0 0,-25.9 H0":"M0,9.25 V-9.25 H-9.25 a9.25,9.25 0 0,0 0,18.5 h18.5 a9.25,9.25 0 0,0 0,-18.5 H0";return e.jsx("path",{d:s,fill:"#fff",strokeWidth:2,stroke:a})},function(n,t){return n.stroke===t.stroke&&n.large===t.large});var C=globalThis&&globalThis.__assign||function(){return C=Object.assign||function(n){for(var t,a=1,r=arguments.length;a<r;a++){t=arguments[a];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(n[s]=t[s])}return n},C.apply(this,arguments)},ce=globalThis&&globalThis.__rest||function(n,t){var a={};for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&t.indexOf(r)<0&&(a[r]=n[r]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,r=Object.getOwnPropertySymbols(n);s<r.length;s++)t.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(n,r[s])&&(a[r[s]]=n[r[s]]);return a},H=globalThis&&globalThis.__read||function(n,t){var a=typeof Symbol=="function"&&n[Symbol.iterator];if(!a)return n;var r=a.call(n),s,o=[],i;try{for(;(t===void 0||t-- >0)&&!(s=r.next()).done;)o.push(s.value)}catch(c){i={error:c}}finally{try{s&&!s.done&&(a=r.return)&&a.call(r)}finally{if(i)throw i.error}}return o},E=15;function V(n){var t=n.lineNum,a=n.stnNum,r=n.strokeColour,s=n.passed,o=n.large,i=ce(n,["lineNum","stnNum","strokeColour","passed","large"]),c=h.useRef(null),m=h.useRef(null),l=H(h.useState({width:0}),2),d=l[0],g=l[1],x=H(h.useState({width:0}),2),f=x[0],u=x[1];h.useEffect(function(){c.current&&g(c.current.getBBox()),m.current&&u(m.current.getBBox())},[t,a]);var z=E/Math.max(E,d.width),S=t.length===2&&a.length===2?z:E/Math.max(E,f.width);return e.jsxs("g",C({},i,{children:[e.jsx(oe,{stroke:s?"#aaa":r,large:o}),e.jsxs("g",{textAnchor:"middle",fontSize:13.5,transform:o?"scale(1.4)":"",fill:s?"#aaa":"#000",children:[e.jsx("g",{transform:"translate(-9.25,0)scale(".concat(z,")"),children:e.jsx("text",{ref:c,className:"rmg-name__zh",children:t})}),e.jsx("g",{transform:"translate(9.25,0)scale(".concat(S,")"),children:e.jsx("text",{ref:m,className:"rmg-name__zh",children:a})})]})]}))}const le=h.memo(function(t){const{stnName:a,onUpdate:r}=t,s=h.useRef(null);return h.useEffect(()=>{s.current&&r&&r(s.current.getBBox())},[a.toString()]),e.jsxs("g",{ref:s,children:[e.jsx("text",{className:"rmg-name__zh",fontSize:18,children:a[0]}),e.jsx("g",{fontSize:10.5,children:a[1].split("\\").map((o,i)=>e.jsx("text",{className:"rmg-name__en",dy:16+i*11,children:o},i))})]})},(n,t)=>n.stnName.toString()===t.stnName.toString());function me(n){const{stnName:t,onUpdate:a,passed:r,...s}=n,o=h.useRef(null),[i,c]=h.useState({x:0,width:0});return h.useEffect(()=>{if(o.current){const m=o.current.getBBox();c(m),a&&a(m)}},[t.toString()]),!t[0]&&!t[1]?e.jsx(e.Fragment,{}):e.jsxs("g",{fill:r?"#aaa":"#000",...s,children:[e.jsxs("g",{transform:"translate(0,3)",fontSize:18,children:[e.jsx("text",{textAnchor:"end",x:i.x-3,className:"rmg-name__zh",children:"("}),e.jsx("text",{textAnchor:"start",x:i.width+i.x+3,className:"rmg-name__zh",children:")"})]}),e.jsxs("g",{ref:o,textAnchor:"middle",children:[e.jsx("text",{className:"rmg-name__zh",fontSize:13,children:t[0]}),e.jsx("text",{dy:10,className:"rmg-name__en",fontSize:6.5,children:t[1]})]})]})}function he(n){const{passed:t,...a}=n;return e.jsxs("g",{textAnchor:"middle",fill:t?"#aaa":"var(--rmg-theme-colour)",...a,children:[e.jsx("text",{className:"rmg-name__zh",fontSize:13,children:"快车停靠站"}),e.jsx("text",{dy:10,className:"rmg-name__en",fontSize:6.5,children:"Express Station"})]})}function xe(n){const{primaryName:t,secondaryName:a,stationState:r,flipped:s,express:o}=n,[i,c]=h.useState({width:0}),[m,l]=h.useState({x:0,width:-20}),d=f=>{switch(f){case T.PASSED:return"#aaa";case T.CURRENT:return"#f00";case T.FUTURE:return"#000"}},g=t[1].split("\\").length,x={g:{x:0,y:s?17.5:-20-g*14*Math.cos(-45)},StationSecondaryName:{x:(i.width+m.width/2+10)*(s?-1:1),y:2+5*(g-1)},ExpressTag:{x:(i.width+m.width+20+35)*(s?-1:1),y:2+5*(g-1)}};return e.jsxs("g",{textAnchor:s?"end":"start",fill:d(r),transform:"translate(".concat(x.g.x,",").concat(x.g.y,")rotate(-45)"),children:[e.jsx(le,{stnName:t,onUpdate:c}),a&&e.jsx(me,{stnName:a,onUpdate:l,passed:r===T.PASSED,transform:"translate(".concat(x.StationSecondaryName.x,",").concat(x.StationSecondaryName.y,")")}),o&&e.jsx(he,{passed:r===T.PASSED,transform:"translate(".concat(x.ExpressTag.x,",").concat(x.ExpressTag.y,")")})]})}function de(n){const{stnId:t,stnState:a,stnY:r}=n,s=j(x=>x.param.theme),o=j(x=>x.param.line_name),i=j(x=>x.param.line_num),c=j(x=>x.param.stn_list[t]),m=c.parents.length===2||c.children.length===2,l=r>0||c.parents.indexOf(c.branch.left[1]||"")===1||c.children.indexOf(c.branch.right[1]||"")===1?180:0,d=c.name[1].split("\\").length,g=m?l===180?16+(d-1)*12*Math.cos(-45):-9:l===180?-6:(25+(d-1)*15)*Math.cos(-45);return e.jsxs(e.Fragment,{children:[e.jsx(ge,{intInfos:m?[{theme:[s[0],s[1],"var(--rmg-theme-colour)","var(--rmg-theme-fg)"],name:o},...c.transfer.groups[0].lines]:c.transfer.groups[0].lines,stnState:a,tickRotation:l}),e.jsx(V,{lineNum:i,stnNum:c.num,strokeColour:s[2],passed:a===-1}),e.jsx("g",{transform:"translate(".concat(-g,",0)"),children:e.jsx(xe,{primaryName:c.name,secondaryName:c.secondaryName||void 0,stationState:a,flipped:l===180,express:c.services.includes(J.express)})})]})}const ge=n=>e.jsxs(e.Fragment,{children:[e.jsx(ue,{strokeWidth:4,...n}),e.jsx(fe,{transform:"translate(0,".concat(n.tickRotation===180?-47:23,")"),...n})]}),ue=n=>{const{intInfos:t,stnState:a,tickRotation:r,...s}=n;return e.jsx("g",{...s,children:t.map((o,i)=>{var c;return e.jsx("use",{xlinkHref:"#inttick",stroke:a===-1?"#aaa":(c=o.theme)==null?void 0:c[2],transform:"translate(".concat(-2*(t.length-1)+4*i,",0)rotate(").concat(r===180?180:0,")")},i)})})},fe=n=>{const{intInfos:t,tickRotation:a,stnState:r,...s}=n;return e.jsx("g",{...s,children:t.map((o,i)=>{var c,m,l,d;return e.jsx("g",{transform:"translate(0,".concat(i*28*(a===180?-1:1),")"),children:e.jsx(U,{lineName:o.name,foregroundColour:(m=(c=o.theme)==null?void 0:c[3])!=null?m:P.white,backgroundColour:(d=(l=o.theme)==null?void 0:l[2])!=null?d:"#aaaaaa",passed:r===-1})},i)})})},M=(n,t)=>n[t].parents.length===2||n[t].children.length===2?.25:0,pe=(n,t,a)=>{const r=_("linestart","lineend",t);if(r.nodes.includes(n))return _(r.nodes[1],n,t).len;{const s=a.filter(l=>l.includes(n))[0];let o=n;for(;!r.nodes.includes(o);)o=s[s.indexOf(o)-1];let i=n;for(;!r.nodes.includes(i);)i=s[s.indexOf(i)+1];const c=o==="linestart",m=i==="lineend";if(s.toString()===a[0].toString()){const l=[];return!c&&!m?(l[0]=_(r.nodes[1],o,t).len,l[1]=_(o,i,t).len,l[2]=_(o,n,t).len,l[3]=_(n,i,t).len):c?(l[0]=0,l[1]=_(r.nodes[1],i,t).len,l[2]=_(s[1],n,t).len,l[3]=_(n,i,t).len):(l[0]=_(r.nodes[1],o,t).len,l[1]=_(o,r.nodes.slice(-2)[0],t).len,l[2]=_(o,n,t).len,l[3]=_(n,s.slice(-2)[0],t).len),l[0]+l[2]*l[1]/(l[2]+l[3])}else if(!c&&!m){const l=[];return l[0]=_(r.nodes[1],o,t).len,l[1]=_(o,i,t).len,l[2]=_(o,n,t).len,l[3]=_(n,i,t).len,l[0]+l[2]*l[1]/(l[2]+l[3])}else return c?_(r.nodes[1],i,t).len-_(n,i,t).len:_(r.nodes[1],o,t).len+_(o,n,t).len}},je=()=>{const{branches:n,routes:t,depsStr:a}=j(y=>y.helper),{svgWidth:r,svg_height:s,y_pc:o,padding:i,branchSpacingPct:c,direction:m,line_name:l,current_stn_idx:d,stn_list:g}=j(y=>y.param),x=q(g,M,M),f=h.useMemo(()=>(console.log("computing x shares"),Object.keys(g).reduce((y,N)=>({...y,[N]:pe(N,x,n)}),{})),[n.toString(),JSON.stringify(x)]),u=_("linestart","lineend",x),z=_(u.nodes[1],u.nodes.slice(-2)[0],x),S=m===p.right?[r[v.RailMap]*i/100+65,r[v.RailMap]*(1-i/100)-20]:[r[v.RailMap]*i/100,r[v.RailMap]*(1-i/100)-65],w=Object.keys(f).reduce((y,N)=>({...y,[N]:S[0]+f[N]/z.len*(S[1]-S[0])}),{}),b=h.useMemo(()=>(console.log("computing y shares"),Object.keys(g).reduce((y,N)=>{if(n[0].includes(N))return{...y,[N]:0};{const k=n.slice(1).filter(Y=>Y.includes(N))[0];return{...y,[N]:g[k[0]].children.indexOf(k[1])?-2:2}}},{})),[a]),R=Object.keys(b).reduce((y,N)=>({...y,[N]:-b[N]*c*s/200}),{}),L=h.useMemo(()=>K(d,t,m),[d,m,t.toString()]),W=n.map(y=>Q(y,L)).reduce((y,N)=>(y.main.push(N.main),y.pass.push(N.pass),y),{main:[],pass:[]}),X=Object.keys(W).reduce((y,N)=>({...y,[N]:W[N].map(k=>_e(k,w,R))}),{});return e.jsxs("g",{id:"main",style:{"--y-percentage":o,transform:"translateY(calc(var(--y-percentage) * var(--rmg-svg-height) / 100))"},children:[e.jsx(Se,{paths:X}),e.jsx(ye,{xs:w,ys:R,stnStates:L}),e.jsx("g",{id:"line_name",style:{"--translate-x":m===p.right?"".concat(S[0]-65,"px"):"".concat(S[1]+65,"px")},children:e.jsx(U,{lineName:l,foregroundColour:"var(--rmg-theme-fg)",backgroundColour:"var(--rmg-theme-colour)"})})]})},Se=h.memo(function(t){return e.jsxs("g",{fill:"none",strokeWidth:4,children:[e.jsx("g",{stroke:"#aaa",strokeDasharray:4,children:t.paths.pass.map((a,r)=>e.jsx("path",{d:a},r))}),e.jsx("g",{stroke:"var(--rmg-theme-colour)",children:t.paths.main.map((a,r)=>e.jsx("path",{d:a},r))})]})},(n,t)=>JSON.stringify(n.paths)===JSON.stringify(t.paths)),_e=(n,t,a)=>{let r;const s=[];return n.forEach(o=>{const i=t[o],c=a[o];if(!r&&r!==0){r=c,s.push("M ".concat(i,",").concat(c));return}c===0?(c<r&&s.push("H ".concat(i-40),"a 40,40 0 0,0 40,-40","V ".concat(c)),c>r&&s.push("H ".concat(i-40),"a 40,40 0 0,1 40,40","V ".concat(c))):(c<r&&s.push("V ".concat(c+40),"a 40,40 0 0,1 40,-40","H ".concat(i)),c>r&&s.push("V ".concat(c-40),"a 40,40 0 0,0 40,40","H ".concat(i))),s.push("H ".concat(i)),r=c}),s.join(" ").replace(/( H ([\d.]+))+/g," H $2")},ye=n=>{const{xs:t,ys:a,stnStates:r}=n,s=j(o=>o.param.stn_list);return e.jsx("g",{id:"stn_icons",children:Object.keys(s).filter(o=>!["linestart","lineend"].includes(o)).map(o=>e.jsx("g",{style:{transform:"translate(".concat(t[o],"px,").concat(a[o],"px)")},children:e.jsx(de,{stnId:o,stnState:r[o],stnY:a[o]})},o))})};function D(n){return e.jsx("path",{d:"M60,60 L0,0 L60,-60 H90 L40,-10 H150 V10 H40 L90,60z",fill:"black",...n})}function Ne(n){const{destIds:t,textAnchor:a,...r}=n,s=j(l=>l.param.direction),o=j(l=>l.param.stn_list),i=t.map(l=>o[l].name[0].length),c=Math.min(...i),m=c>1&&i[0]!==i[1]?Math.abs(i[0]-i[1])/(c-1):0;return e.jsxs("g",{textAnchor:a,...r,children:[t.map((l,d)=>{const g=i[d]>i[1-d],x=!ee()&&a==="end"&&!g;return e.jsxs(h.Fragment,{children:[e.jsx("text",{className:"rmg-name__zh",fontSize:25,x:s===p.left?0:-75,y:-21+42*d,letterSpacing:g?"0em":"".concat(m,"em"),dx:x?"".concat(m,"em"):"0em",children:o[l].name[0]}),e.jsx("text",{className:"rmg-name__en",fontSize:11.5,x:s===p.left?0:-75,y:-1+42*d,children:"Towards "+o[l].name[1].replace("\\"," ")})]},l)}),e.jsx("text",{className:"rmg-name__zh",fontSize:28,x:s===p.left?25*(Math.max(...i)+1):0,y:5,children:"方向"})]})}const F=v.RailMap,ve=()=>{const{canvasScale:n}=j(x=>x.app),{svgWidth:t,svg_height:a,direction:r,psd_num:s,info_panel_type:o,notesGZMTR:i,current_stn_idx:c,stn_list:m,theme:l}=j(x=>x.param),d=t[F],g=m[c];return e.jsxs(G,{type:F,svgWidth:d,svgHeight:a,canvasScale:n,theme:l,children:[e.jsx(ze,{}),e.jsx(Z,{variant:o,isShowLight:o===B.gz2otis,isShowPSD:o===B.gz2otis&&s}),r===p.left&&g.parents.includes("linestart")||r===p.right&&g.children.includes("lineend")?e.jsx(be,{}):e.jsxs(e.Fragment,{children:[e.jsx(je,{}),e.jsx(we,{}),i.map((x,f)=>e.jsx($e,{note:x},f))]}),o===B.gz2otis&&e.jsx("line",{x2:d,transform:"translate(0,90)",strokeWidth:3,stroke:"black"})]})},ze=h.memo(function(){return e.jsx("defs",{children:e.jsx("path",{id:"inttick",d:"M 0,0 v 18",strokeLinecap:"square"})})}),we=()=>{const{routes:n}=j(c=>c.helper),{direction:t,direction_gz_x:a,direction_gz_y:r,current_stn_idx:s}=j(c=>c.param),o=h.useMemo(()=>[...new Set(n.reduce((c,m)=>m.includes(s)?c.concat(m.filter(l=>!["linestart","lineend"].includes(l)).slice(t===p.left?0:-1)[0]):c,[]).filter(c=>c!==s))],[s,t,n.toString()]),i={textAnchor:t===p.left?"start":"end",transform:"translate(".concat(t===p.left?65:-65,",-5)"),destIds:o};return e.jsxs("g",{id:"direction_gz",style:{"--x-percentage":a,"--y-percentage":r},children:[e.jsx(D,{transform:"scale(0.35)rotate(".concat(t===p.left?0:180,")")}),o.length!==2?e.jsx(Be,{...i}):e.jsx(Ne,{...i})]})},Be=n=>{const{destIds:t,...a}=n,r=j(s=>s.param.stn_list);return e.jsxs("g",{...a,children:[e.jsx("text",{className:"rmg-name__zh",fontSize:28,children:t.map(s=>r[s].name[0]).join("/")+"方向"}),e.jsx("text",{className:"rmg-name__en",fontSize:14,dy:22,children:"Towards "+t.map(s=>r[s].name[1].replace("\\"," ")).join("/")})]})},be=h.memo(function(){return e.jsxs("g",{id:"terminus_gz",textAnchor:"middle",children:[e.jsx("text",{className:"rmg-name__zh",fontSize:90,children:"终 点 站"}),e.jsx("text",{dy:70,className:"rmg-name__en",fontSize:36,children:"Terminal"}),e.jsxs("g",{strokeWidth:8,stroke:"#000",children:[e.jsx("path",{d:"M -160,68 h -160"}),e.jsx("path",{d:"M 160,68 h 160"})]})]})}),$e=h.memo(function(t){const a=h.useRef(null),[r,s]=h.useState({width:0,height:0,y:0});return h.useEffect(()=>{a.current&&s(a.current.getBBox())},[t.note[0],t.note[1]]),e.jsxs("g",{className:"note-box",style:{"--x-percentage":t.note[2],"--y-percentage":t.note[3]},children:[t.note[4]&&e.jsx("rect",{height:r.height+4,width:r.width+4,x:-2,y:r.y-2,fill:"none",stroke:"black",strokeWidth:.5}),e.jsxs("g",{ref:a,children:[e.jsx("g",{fontSize:16,letterSpacing:1.2,children:t.note[0].split("\n").map((o,i)=>e.jsx("text",{className:"rmg-name__zh",y:i*18,children:o},i))}),e.jsx("g",{fontSize:10,letterSpacing:.33,transform:"translate(0,".concat(18*t.note[0].split("\n").length,")"),children:t.note[1].split("\n").map((o,i)=>{var c;return e.jsx("text",{className:"rmg-name__en",y:i*11,textLength:i<(((c=t.note[1].match(/\n/g))==null?void 0:c.length)||0)?r.width:navigator.userAgent.includes("Firefox")?-1:0,lengthAdjust:"spacing",children:o},i)})})]})]})},(n,t)=>n.note.toString()===t.note.toString()),Re=h.memo(function(t){const{stnName:a,onUpdate:r}=t,s=h.useRef(null);return h.useEffect(()=>{s.current&&r&&r(s.current.getBBox())},[a.toString()]),e.jsxs("g",{ref:s,children:[e.jsx("text",{className:"rmg-name__zh",fontSize:90,children:a[0]}),e.jsx("g",{fontSize:36,children:a[1].split("\\").map((o,i)=>e.jsx("text",{className:"rmg-name__en",dy:70+i*36,children:o},i))})]})},(n,t)=>n.stnName.toString()===t.stnName.toString()),Te=n=>{const{secondaryName:t,transform:a}=n,r=h.useRef(null),[s,o]=h.useState({x:0,width:0});return h.useEffect(()=>{r.current&&o(r.current.getBBox())},[t.toString()]),e.jsxs("g",{transform:a,children:[e.jsxs("g",{transform:"translate(0,4.5)",fontSize:36,children:[e.jsx("text",{textAnchor:"end",x:s.x-3,className:"rmg-name__zh",children:"("}),e.jsx("text",{textAnchor:"start",x:s.width+s.x+3,className:"rmg-name__zh",children:")"})]}),e.jsxs("g",{ref:r,textAnchor:"middle",children:[e.jsx("text",{className:"rmg-name__zh",fontSize:26,children:t[0]}),e.jsx("text",{dy:22,className:"rmg-name__en",fontSize:14,children:t[1]})]})]})},ke=()=>{const{svg_height:n,svgWidth:t,theme:a,direction:r,info_panel_type:s,line_num:o,current_stn_idx:i,stn_list:c}=j(u=>u.param),m=c[i],[l,d]=h.useState({width:0}),g=m[r===p.left?"parents":"children"],x={name:"translate(".concat((r===p.left?1:-1)*t[v.RunIn]/4,",45)"),next:"translate(".concat((r===p.left?1:-1)*t[v.RunIn]/10,",45)")},f={nameGroup:{x:t.runin/2,y:.5*n-50-(m.name[1].split("\\").length-1)*18-(m.secondaryName?29:0)},secondaryName:{x:0,y:70+m.name[1].split("\\").length*36}};return e.jsxs("g",{children:[e.jsxs("g",{transform:s===B.gz2otis?x.name:"",children:[e.jsxs("g",{textAnchor:"middle",transform:"translate(".concat(f.nameGroup.x,",").concat(f.nameGroup.y,")"),children:[e.jsx(Re,{stnName:m.name,onUpdate:d}),m.secondaryName&&e.jsx(Te,{secondaryName:m.secondaryName,transform:"translate(".concat(f.secondaryName.x,",").concat(f.secondaryName.y,")")})]}),e.jsx(V,{lineNum:o,stnNum:m.num,strokeColour:a[2],style:{"--translate-x":"".concat((t[v.RunIn]+l.width)/2+55,"px"),"--translate-y":"".concat(.5*n-30-(m.name[1].split("\\").length-1)*18-(m.secondaryName?58/2:0),"px"),transform:"translate(var(--translate-x, 800px), var(--translate-y, 145px))"},large:!0})]}),e.jsx("g",{transform:s===B.gz2otis?x.next:"",children:!g||g.includes("linestart")||g.includes("lineend")?e.jsx(e.Fragment,{}):g.length===1?e.jsx(Ee,{nextId:g[0],nameBBox:l}):e.jsx(Ie,{nextIds:g,nameBBox:l})})]})},Ee=n=>{const{nextId:t,nameBBox:a}=n,r=j(f=>f.param.svgWidth),s=j(f=>f.param.direction),o=j(f=>f.param.stn_list[t]),{name:i,secondaryName:c}=o,[m,l]=h.useState({width:0}),d=h.useRef(null);h.useEffect(()=>{d.current&&l(d.current.getBBox())},[i.toString()]);const g=i[0].length,x=(r[v.RunIn]-a.width)/2;return e.jsxs(e.Fragment,{children:[e.jsxs("g",{id:"big_next",children:[e.jsxs("g",{textAnchor:"middle",style:{"--translate-x":s===p.left?"80px":g<=2?"".concat(r[v.RunIn]-45-m.width-70,"px"):"".concat(r[v.RunIn]-45-m.width-35*1.5,"px")},children:[e.jsx("text",{className:"rmg-name__zh",fontSize:35,children:"下站"}),e.jsx("text",{className:"rmg-name__en",fontSize:17,dy:30,children:"Next"})]}),e.jsxs("g",{textAnchor:"start",ref:d,style:{"--translate-x":s===p.left?g<=2?"".concat(115+35,"px"):"".concat(115+35/2,"px"):"".concat(r[v.RunIn]-45-m.width,"px")},children:[e.jsx("text",{className:"rmg-name__zh",fontSize:35,children:i[0]}),e.jsx("g",{fontSize:17,children:i[1].split("\\").map((f,u)=>e.jsx("text",{className:"rmg-name__en",dy:30+u*17,children:f},u))})]}),c&&e.jsx("g",{textAnchor:"middle",style:{"--translate-x":s===p.left?g<=2?"".concat(115+35,"px"):"".concat(115+35/2,"px"):"".concat(r[v.RunIn]-45-m.width,"px")},children:e.jsx(Ae,{secName:c,transform:"translate(".concat(m.width/2,",").concat(30+i[1].split("\\").length*17+5,")")})})]}),e.jsx(D,{id:"arrow",style:{"--translate-x":s===p.left?"".concat((115+35*((g<=2?1:.5)+g)+x)/2-20,"px"):"".concat((r[v.RunIn]-45-m.width-(g<=2?70+35:35*2.5)+x+n.nameBBox.width+55+18.5*1.4)/2+20,"px"),"--rotate":s===p.left?"0deg":"180deg"}})]})},Ae=n=>{const{secName:t,...a}=n,r=h.useRef(null),[s,o]=h.useState({x:0,width:0});return h.useEffect(()=>{r.current&&o(r.current.getBBox())},[n.secName.toString()]),e.jsxs("g",{...a,children:[e.jsxs("g",{transform:"translate(0,2.5)",fontSize:25,children:[e.jsx("text",{textAnchor:"end",x:s.x-3,className:"rmg-name__zh",children:"("}),e.jsx("text",{textAnchor:"start",x:s.width+s.x+3,className:"rmg-name__zh",children:")"})]}),e.jsxs("g",{ref:r,children:[e.jsx("text",{className:"rmg-name__zh",fontSize:18,children:t[0]}),e.jsx("text",{className:"rmg-name__en",fontSize:10,dy:15,children:t[1]})]})]})},Ie=n=>{const{nextIds:t,nameBBox:a}=n,{routes:r}=j(u=>u.helper),s=j(u=>u.param.svgWidth),o=j(u=>u.param.direction),i=j(u=>u.param.stn_list),c=t.map(u=>i[u].name),[m,l]=h.useState({width:0}),d=h.useRef([]);h.useEffect(()=>{l(u=>({...u,width:0})),d.current.forEach(u=>{const z=u==null?void 0:u.getBBox();l(S=>z?S.width>z.width?S:z:S)})},[c.toString()]);const g=n.nextIds.map(u=>r.reduce((z,S)=>S.includes(u)?z.concat(S.filter(w=>!["linestart","lineend"].includes(w)).slice(o===p.left?0:-1)[0]):z,[])),x=Math.max(...c.map(u=>u[0].length)),f=(s[v.RunIn]-a.width)/2;return e.jsxs(e.Fragment,{children:[e.jsx("g",{id:"big_next_2",children:c.map((u,z)=>e.jsxs(h.Fragment,{children:[e.jsxs("g",{textAnchor:"middle",style:{"--translate-x":o===p.left?"72px":"".concat(s[v.RunIn]-45-m.width-41,"px")},children:[e.jsx("text",{className:"rmg-name__zh",children:"下站"}),e.jsx("text",{className:"rmg-name__en",y:22,children:"Next"})]}),e.jsxs("g",{ref:S=>d.current[z]=S,textAnchor:"start",style:{"--translate-x":o===p.left?"113px":"".concat(s[v.RunIn]-45-m.width,"px")},children:[e.jsx("text",{className:"rmg-name__zh",children:u[0]}),u[1].split("\\").map((S,w)=>e.jsx("text",{className:"rmg-name__en",y:22+w*13,children:S},w)),e.jsx("text",{className:"rmg-name__zh",y:-35,children:g[z].map(S=>i[S].name[0]).join("/")+"方向"}),e.jsx("text",{className:"rmg-name__en rmg-name__gzmtr--next2-dest",y:-20,children:"Towards "+g[z].map(S=>i[S].name[1]).join("/").replace("\\"," ")})]})]},z))}),e.jsx(D,{id:"arrow",style:{"--translate-x":o===p.left?"".concat((99+27*(1+x)+f)/2-20,"px"):"".concat((s[v.RunIn]-45-m.width-41-27+f+n.nameBBox.width+55+18.5*1.4)/2+20,"px"),"--rotate":o===p.left?"0deg":"180deg"}})]})};function Oe(n){const{num:t,...a}=n;return e.jsxs("g",{textAnchor:"middle",fill:"var(--rmg-theme-fg)",...a,children:[e.jsx("circle",{cx:0,cy:0,r:30,fill:"var(--rmg-theme-colour)"}),e.jsx("text",{className:"rmg-name__en",fontSize:38,dy:-9.5,children:t}),e.jsx("text",{className:"rmg-name__zh",fontSize:13,dy:10,children:"站台"}),e.jsx("text",{className:"rmg-name__en",fontSize:9,dy:21,children:"Platform"})]})}function Ce(n){const{canvasType:t}=n,{svgWidth:a,svg_height:r}=j(s=>s.param);return e.jsxs("g",{id:"otis_frame",strokeWidth:3,stroke:"black",children:[e.jsx("line",{y2:r,transform:"translate(".concat(a[t]/2,",0)")}),e.jsx("line",{x2:a[t],transform:"translate(0,90)"})]})}const I=v.RunIn;function Pe(){const{canvasScale:n}=j(d=>d.app),{svgWidth:t,svg_height:a,direction:r,info_panel_type:s,platform_num:o,psd_num:i,theme:c}=j(d=>d.param),m=t[I],l={platform:"translate(".concat(r===p.left?50:-50,",45)")};return e.jsxs(G,{type:I,svgWidth:m,svgHeight:a,canvasScale:n,theme:c,children:[e.jsx(Z,{variant:s,isShowLight:s!==B.gz2otis,isShowPSD:s!==B.gz2otis&&i}),e.jsx("g",{transform:s===B.gz2otis?l.platform:"",children:e.jsx(Oe,{num:o,style:{"--translate-x":"".concat(r===p.left?m-100:100,"px"),"--translate-y":"calc(var(--rmg-svg-height) / 2 - 30px)",transform:"translate(var(--translate-x, 100px), var(--translate-y))"}})}),e.jsx(ke,{}),s===B.gz2otis&&e.jsx(Ce,{canvasType:I})]})}const Fe={runin:e.jsx(Pe,{}),railmap:e.jsx(ve,{})};export{Fe as default};
