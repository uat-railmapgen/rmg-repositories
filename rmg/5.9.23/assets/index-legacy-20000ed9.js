!function(){function n(t){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},n(t)}var t=["nextName"],e=["stnName","oneLine","directionPolarity"],r=["intInfos","direction"],i=["stnName","nameDirection"];function a(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),e.push.apply(e,r)}return e}function c(n){for(var t=1;t<arguments.length;t++){var e=null!=arguments[t]?arguments[t]:{};t%2?a(Object(e),!0).forEach((function(t){o(n,t,e[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):a(Object(e)).forEach((function(t){Object.defineProperty(n,t,Object.getOwnPropertyDescriptor(e,t))}))}return n}function o(t,e,r){return(e=function(t){var e=function(t,e){if("object"!==n(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var i=r.call(t,e||"default");if("object"!==n(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"===n(e)?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function s(n,t){if(null==n)return{};var e,r,i=function(n,t){if(null==n)return{};var e,r,i={},a=Object.keys(n);for(r=0;r<a.length;r++)e=a[r],t.indexOf(e)>=0||(i[e]=n[e]);return i}(n,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(n);for(r=0;r<a.length;r++)e=a[r],t.indexOf(e)>=0||Object.prototype.propertyIsEnumerable.call(n,e)&&(i[e]=n[e])}return i}function l(n,t){return function(n){if(Array.isArray(n))return n}(n)||function(n,t){var e=null==n?null:"undefined"!=typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(null!=e){var r,i,a,c,o=[],s=!0,l=!1;try{if(a=(e=e.call(n)).next,0===t){if(Object(e)!==e)return;s=!1}else for(;!(s=(r=a.call(e)).done)&&(o.push(r.value),o.length!==t);s=!0);}catch(u){l=!0,i=u}finally{try{if(!s&&null!=e.return&&(c=e.return(),Object(c)!==c))return}finally{if(l)throw i}}return o}}(n,t)||d(n,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function u(n){return function(n){if(Array.isArray(n))return f(n)}(n)||function(n){if("undefined"!=typeof Symbol&&null!=n[Symbol.iterator]||null!=n["@@iterator"])return Array.from(n)}(n)||d(n)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function d(n,t){if(n){if("string"==typeof n)return f(n,t);var e=Object.prototype.toString.call(n).slice(8,-1);return"Object"===e&&n.constructor&&(e=n.constructor.name),"Map"===e||"Set"===e?Array.from(n):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?f(n,t):void 0}}function f(n,t){(null==t||t>n.length)&&(t=n.length);for(var e=0,r=new Array(t);e<t;e++)r[e]=n[e];return r}System.register(["./vendor-legacy-b5979a18.js","./index-legacy-4c5337ee.js","./app-router-legacy-acfc9b4a.js","./share-legacy-a24f6630.js","./mtr-legacy-5f001621.js","./param-selector-legacy-d1064296.js"],(function(n,a){"use strict";var d,f,h,m,g,x,p,j,v,_,y,b,w,S,k;return{setters:[function(n){d=n.m,f=n.j,h=n.b2},function(n){m=n.ar,g=n.u,x=n.F,p=n.j},function(n){j=n.i},function(n){v=n.S,_=n.d,y=n.a,b=n.c,w=n.g,S=n.b},function(n){k=n.a},null],execute:function(){var a=function(n,t,e,r){var i=n.length-2*r-e,a=[].concat(u(n),u(n),u(n)),c=n.length+n.findIndex((function(n){return n===t})),o=a[c+i-1],s=n.length+n.findIndex((function(n){return n===o}))+(c+i>2*n.length?n.length:0);return{top:a.slice(c,s+1),left:a.slice(c-r,c),right:a.slice(s+1,s+1+r),bottom:a.slice(s+1+r,s+1+r+e)}},M=m.Destination;function O(){var n=g((function(n){return n.app})).canvasScale,t=g((function(n){return n.param})),e=t.svgWidth,r=t.svg_height,i=t.theme,a=e[M];return f.jsxs(v,{type:M,svgWidth:a,svgHeight:r,canvasScale:n,theme:i,children:[f.jsx(z,{}),f.jsx(I,{})]})}var z=d.memo((function(){return f.jsx("defs",{children:f.jsx("marker",{id:"slope",viewBox:"-1.5 0 3 1.5",refY:.5,children:f.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})})})})),I=function(){var n=g((function(n){return n.helper})),t=n.routes,e=n.branches,r=g((function(n){return n.param})),i=r.line_name,a=r.theme,c=r.current_stn_idx,o=r.direction,s=r.stn_list,d=r.info_panel_type,h=r.loop,m=r.coline,x=function(n,t,e){return u(new Set(n.filter((function(n){return n.includes(e)})).map((function(n){var e=n.filter((function(n){return!["linestart","lineend"].includes(n)}));return"l"===t?e[0]:e.reverse()[0]}))))},p=function(n,t){return t?[[n.map((function(n){return s[n].name[0]})).join("，"),n.map((function(n){return s[n].name[1]})).join(", ")].map((function(n){return n.replace("\\","")}))]:n.map((function(n){return s[n].name.map((function(n){return n.replace("\\","")}))}))},v=h?function(n,t,e,r){var i=n[0].filter((function(n){return!["linestart","lineend"].includes(n)})),a=[].concat(u(i),u(i),u(i)),c="r"===t?a:a.reverse(),o=c.findIndex((function(n){return r===n}))+i.length;return c.slice(o+1).filter((function(n){return e[n].loop_pivot})).slice(void 0,2)}(e,o,s,c):x(t,o,c),_=(h?x(t,o,c):v).filter((function(n){return e.slice(1).filter((function(n){return j(n,s)})).some((function(t){return t.includes(n)}))})),y=p(v.filter((function(n){return!_.includes(n)})),!(h||"sh2020"===d));console.log(y);var b=p(_,!0),w=Object.fromEntries(_.map((function(n){return[n,Object.values(m).filter((function(t){return t.from===n||t.to===n})).at(0)]})).filter((function(n){return l(n,2)[1]})));return f.jsxs(f.Fragment,{children:[f.jsx(N,{dest_names:y,line_name:i,line_color:[a[2],a[3]],coline:!!_.length,upper:!!_.length}),_.length&&_.map((function(n){var t,e,r;return f.jsx("g",{transform:"translate(0,".concat(-250,")"),children:f.jsx(N,{dest_names:[b.at(0)],line_name:null===(t=w[n])||void 0===t?void 0:t.colors.at(0).slice(4),line_color:[null===(e=w[n])||void 0===e?void 0:e.colors.at(0)[2],null===(r=w[n])||void 0===r?void 0:r.colors.at(0)[3]],coline:!0,upper:!1})},"coline_".concat(n))}))]})},N=function(n){var t=n.dest_names,e=n.line_name,r=n.line_color,i=n.coline,a=n.upper,c=g((function(n){return n.param})),o=c.current_stn_idx,s=c.direction,u=c.platform_num,h=c.svgWidth,m=c.svg_height,x=d.useRef(null),p=l(d.useState({width:0}),2),j=p[0],v=p[1];d.useEffect((function(){x.current&&v(x.current.getBBox())}),[JSON.stringify(t),JSON.stringify(o)]);var _=h.destination/2,y=_-10-36-j.width>=162.5&&_-10-36-264>=162.5?_:"l"===s?(h.destination+j.width-264)/2:(h.destination-j.width+264)/2;return f.jsxs("g",{transform:"translate(0,".concat(m-300,")"),children:[f.jsx("path",{stroke:r[0],strokeWidth:12,d:"l"===s?"M".concat(h.destination-24,",16 H 36"):"M24,16 H ".concat(h.destination-36),transform:"translate(0,".concat(a?-20:220,")"),markerEnd:i?void 0:"url(#slope)"}),f.jsx(H,{ref:x,dest_names:t}),""!==u&&f.jsx("g",{transform:"translate(".concat(y,",0)"),children:f.jsx(L,{})}),e[0].match(/^[\w\d]+(号)?线/)?f.jsx(P,{line_name:e,line_color:r}):f.jsx(W,{line_name:e,line_color:r})]})},H=d.forwardRef((function(n,t){var e=n.dest_names,r=g((function(n){return n.param})),i=r.direction,a=r.svgWidth;return f.jsxs("g",{ref:t,transform:"translate(".concat("l"===i?36:a.destination-36,",145)"),children:[f.jsx("g",{transform:"translate(0,".concat(2===e.length?-20:20,")"),children:f.jsx("path",{d:"M60,60L0,0L60-60H100L55-15H160V15H55L100,60z",fill:"black",transform:"rotate(".concat("l"===i?0:180,")scale(0.8)")})}),f.jsx("g",{textAnchor:"l"===i?"start":"end",transform:"translate(".concat("l"===i?148:-148,",25)"),children:e.map((function(n,t){return f.jsxs(d.Fragment,{children:[f.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:70,dy:-100*t+7,children:"往"+n[0]},"zh".concat(t)),f.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:25,dy:-100*t+40,children:"To "+n[1]},"en".concat(t))]},t)}))})]})})),L=function(){var n=g((function(n){return n.param})).platform_num;return d.useMemo((function(){return f.jsxs("g",{transform:"translate(".concat(-102.5,",150)"),children:[f.jsx("circle",{r:60,fill:"none",stroke:"black",strokeWidth:2}),f.jsx("text",{className:"rmg-name__en rmg-outline",dominantBaseline:"central",fontSize:120,textAnchor:"middle",children:n}),f.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:100,dominantBaseline:"central",x:65,children:"站台"})]})}),[n])},W=function(n){var t=n.line_name,e=n.line_color,r=g((function(n){return n.param})),i=r.direction,a=r.svgWidth,c="l"===i?a.destination-42:42,o=d.useRef(null),s=l(d.useState({width:0}),2),h=s[0],m=s[1];d.useEffect((function(){o.current&&m(o.current.getBBox())}),u(t));var x=("l"===i?-h.width:0)-6,p=("l"===i?-1:1)*h.width/2;return d.useMemo((function(){return f.jsxs("g",{transform:"translate(".concat(c,",92)"),children:[f.jsx("rect",{fill:e[0],x:x,width:h.width+10,height:120}),f.jsxs("g",{textAnchor:"r"===i?"start":"end",transform:"translate(0,68)",fill:e[1],children:[f.jsx("g",{ref:o,children:f.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:68,children:t[0]})}),f.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:30,textAnchor:"middle",x:p,dy:42,children:t[1]})]})]})}),[h].concat(u(t),u(e),[i,a.destination]))},P=function(n){var t=n.line_name,e=n.line_color,r=g((function(n){return n.param})),i=r.direction,a=r.svgWidth,c=l(t[0].match(/^[\w\d]+|.+/g),2),o=c[0],s=c[1],h="l"===i?a.destination-36-210:90;return d.useMemo((function(){return f.jsxs("g",{transform:"translate(".concat(h,",92)"),children:[f.jsx("rect",{fill:e[0],x:-54,width:108,height:120}),f.jsx("text",{className:"rmg-name__zh rmg-outline",fill:e[1],fontSize:96,textAnchor:"middle",dominantBaseline:"central",transform:"translate(0,60)",letterSpacing:-5,children:o}),f.jsxs("g",{textAnchor:"start",transform:"translate(74,68)",children:[f.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:68,children:s}),f.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:30,dy:42,children:t[1]})]})]})}),[h].concat(u(t),u(e),[i,a.destination]))},F=function(n,t){return n.map((function(n){var e=t.filter((function(t){return t.includes(n.from)&&t.includes(n.to)}));if(1!==e.length)return{linePath:[],colors:n.colors};var r=e.flat(),i=r.indexOf(n.from),a=r.indexOf(n.to);return{linePath:i<a?r.slice(i,a+1):r.slice(a,i+1),colors:n.colors}})).filter((function(n){return 0!==n.linePath.length}))},B=function(){return h.useMemo((function(){return f.jsxs("filter",{id:"pujiang_outline",colorInterpolationFilters:"sRGB",filterUnits:"userSpaceOnUse",x:"0",y:"-1000",width:"5000",height:"2000",children:[f.jsxs("feComponentTransfer",{in:"SourceGraphic",children:[f.jsx("feFuncR",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"}),f.jsx("feFuncG",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"}),f.jsx("feFuncB",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"})]}),f.jsx("feColorMatrix",{type:"matrix",values:"1 0 0 0 0\n                            0 1 0 0 0\n                            0 0 1 0 0\n                            1 1 1 1 -3",result:"selectedColor"}),f.jsx("feMorphology",{operator:"erode",in:"selectedColor",radius:"0",result:"e1"}),f.jsx("feMorphology",{operator:"erode",in:"selectedColor",radius:"1",result:"e2"}),f.jsx("feComposite",{in:"e1",in2:"e2",operator:"xor",result:"uncoloredOutline"}),f.jsx("feFlood",{floodColor:"rgb(0,0,0)"}),f.jsx("feComposite",{operator:"in",in2:"uncoloredOutline",result:"outline"}),f.jsx("feComposite",{in:"outline",in2:"selectedColor",operator:"over",result:"result"}),f.jsx("feComposite",{in:"result",in2:"SourceGraphic",operator:"over"})]})}),[])};B.displayName="PujiangLineDefs";var E=m.RunIn,A=function(){var n=g((function(n){return n.app})).canvasScale,t=g((function(n){return n.helper})),e=t.branches,r=t.routes,i=t.depsStr,a=g((function(n){return n.param})),c=a.svgWidth,o=a.svg_height,s=a.current_stn_idx,l=a.direction,u=a.loop,h=a.theme,m=c[E],x=o-300,p=d.useMemo((function(){var n=r.filter((function(n){return n.includes(s)})).map((function(n){return n[n.indexOf(s)+("l"===l?1:-1)]})).reduce((function(n,t){return n.includes(t)?n:n.concat(t)}),[]);return u&&e[0].includes(s)&&1===n.length&&["linestart","lineend"].includes(n[0])&&(n="l"===l?[e[0][1]]:[e[0][e[0].length-2]]),n}),[i,s,l,u]),j=d.useMemo((function(){var n=r.filter((function(n){return n.includes(s)})).map((function(n){return n[n.indexOf(s)+("l"===l?-1:1)]})).reduce((function(n,t){return n.includes(t)?n:n.concat(t)}),[]);return u&&e[0].includes(s)&&1===n.length&&["linestart","lineend"].includes(n[0])&&(n="l"===l?[e[0][e[0].length-2]]:[e[0][1]]),n}),[i,s,l,u]);return f.jsxs(v,{type:E,svgWidth:m,svgHeight:o,canvasScale:n,theme:h,children:[f.jsx(D,{}),f.jsx("g",{transform:"translate(0,".concat(x,")"),children:f.jsx(R,{prevStnIds:p,nextStnIds:j})})]})},D=d.memo((function(){return f.jsxs("defs",{children:[f.jsx("marker",{id:"slope",viewBox:"-1.5 0 3 1.5",refY:.5,children:f.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})}),f.jsx(B,{})]})})),R=function(n){var t=n.prevStnIds,e=n.nextStnIds,r=g((function(n){return n.param})),i=r.info_panel_type,a=r.svgWidth,c=r.stn_list,o=a.runin/2,s=1===e.length&&["linestart","lineend"].includes(e[0]),l=1===t.length&&["linestart","lineend"].includes(t[0]),u=e.map((function(n){return c[n].name})),d=t.map((function(n){return c[n].name})),h=10+(e.length>1?-50*(u[0][0].split("\\").length-1)+-30*(u[0][1].split("\\").length-1):0),m=10+(t.length>1?-50*(d[0][0].split("\\").length-1)+-30*(d[0][1].split("\\").length-1):0);return f.jsxs(f.Fragment,{children:[f.jsx(Y,{prevStnIds:t,nextStnIds:e,nextBranchLineDy:h,prevBranchLineDy:m}),s&&"sh2020"!==i?f.jsx(C,{mode:"terminal",prevStnIds:t,nextStnIds:e}):l&&"sh2020"!==i?f.jsx(C,{mode:"original",prevStnIds:t,nextStnIds:e}):f.jsxs(f.Fragment,{children:[f.jsx(V,{prevStnIds:t,nextStnIds:e}),f.jsx("g",{transform:"translate(".concat(o,",160)"),textAnchor:"middle",children:f.jsx(T,{})})]}),(l||!s)&&f.jsx(X,{stnIds:n.nextStnIds}),(s||!l)&&f.jsx(U,{stnIds:n.prevStnIds})]})},C=function(n){var t,e=n.mode,r=n.prevStnIds,i=n.nextStnIds,a=g((function(n){return n.param})),c=a.current_stn_idx,o=a.theme,s=a.svgWidth,l=a.direction,u=a.coline,d=g((function(n){return n.helper})).branches,h={l:{original:{x:s.runin-36,anchor:"end"},terminal:{x:36,anchor:"start"}},r:{original:{x:36,anchor:"start"},terminal:{x:s.runin-36,anchor:"end"}}},m=F(Object.values(u),d),x="terminal"===e?r:i,p=i.length>1?"var(--rmg-theme-colour)":null!==(t=m.filter((function(n){return n.linePath.includes(c)&&n.linePath.includes(x[0])})).map((function(n){return n.colors[0][2]}))[0])&&void 0!==t?t:"var(--rmg-theme-colour)";return f.jsxs(f.Fragment,{children:["original"===e&&f.jsx("path",{transform:"translate(0,".concat(u.length?"198":"220",")").concat(u.length?"scale(1,2)":""),stroke:p,strokeWidth:12,d:"l"===l?"M ".concat(s.runin-24,",16 H 36"):"M24,16 H ".concat(s.runin-36),markerEnd:"url(#slope)"}),"terminal"===e&&f.jsx("g",{filter:"#B5B5B6"===o[2]?"url(#pujiang_outline)":void 0,children:f.jsx("path",{transform:"translate(0,".concat(u.length?"198":"220",")").concat(u.length?"scale(1,2)":""),stroke:"var(--rmg-grey)",strokeWidth:12,d:"M24,16 H ".concat(s.runin-24)})}),f.jsx("g",{transform:"translate(".concat(h[l][e].x,",160)"),textAnchor:h[l][e].anchor,children:f.jsx(T,{})})]})},V=function(n){var t,e,r,i,a=n.prevStnIds,c=n.nextStnIds,o=g((function(n){return n.param})),s=o.direction,l=o.svgWidth,u=o.theme,d=o.coline,h=o.current_stn_idx,m=o.stn_list,x=g((function(n){return n.helper})).branches,p=l.runin/2,v=function(n){return n.includes("linestart")||n.includes("lineend")},_=F(Object.values(d),x),y=c.length>1?"single":v(c)?_.filter((function(n){return[h,a[0]].every((function(t){return n.linePath.includes(t)}))})).length>0?"multiple":"single":[h,c[0]].every((function(n){return x[0].includes(n)}))&&_.filter((function(n){return[h,c[0]].every((function(t){return n.linePath.includes(t)}))})).length>0?"multiple":"single",b=v(c)?a:c,w=c.length>1?"var(--rmg-theme-colour)":null!==(t=_.filter((function(n){return n.linePath.includes(h)&&n.linePath.includes(b[0])})).map((function(n){return n.colors[0][2]}))[0])&&void 0!==t?t:"var(--rmg-theme-colour)",S=Object.keys(d).length>0&&(e=h,r=c,i=m,x.slice(1).filter((function(n){return[e,r[0]].every((function(t){return n.includes(t)}))})).filter((function(n){return j(n,i)})).length>0)?w:"var(--rmg-theme-colour)",k=Object.keys(d).length>0&&1===c.length&&(!(!v(a)&&!v(c))||!([h,c[0]].every((function(n){return x[0].includes(n)}))&&0!==_.filter((function(n){return n.linePath.includes(h)&&n.linePath.includes(c[0])})).length)),M=Object.keys(d).length>0&&1===a.length;return f.jsxs("g",{transform:"translate(0,220)",strokeWidth:12,children:[f.jsxs(f.Fragment,{children:["var(--rmg-theme-colour)"!==S&&f.jsx("marker",{id:"slope_".concat(S),viewBox:"-1.5 0 3 1.5",refY:.5,children:f.jsx("path",{d:"M0,0L1,1H-1z",fill:S})}),f.jsx("path",{stroke:S,d:"M ".concat(p,",16 H ").concat("l"===s?36:l.runin-36),markerEnd:"var(--rmg-theme-colour)"===S?"url(#slope)":"url(#slope_".concat(S,")"),transform:k?"translate(0,-22)scale(1,2)":void 0})]}),"multiple"===y&&f.jsxs(f.Fragment,{children:[f.jsx("marker",{id:"slope_".concat(w),viewBox:"-1.5 0 3 1.5",refY:.5,children:f.jsx("path",{d:"M0,0L1,1H-1z",fill:w})}),f.jsx("path",{stroke:w,d:"M ".concat(p,",16 H ").concat("l"===s?48:l.runin-48),markerEnd:"url(#slope_".concat(w,")"),transform:"translate(0,-12)"})]}),f.jsx("g",{filter:"#B5B5B6"===u[2]?"url(#pujiang_outline)":void 0,transform:"translate(0,".concat(M?-22:0,")scale(1,").concat(M?2:1,")"),children:f.jsx("path",{stroke:"var(--rmg-grey)",d:"M ".concat(p,",16 H ").concat("l"===s?l.runin-24:24," ")})})]})},Y=function(n){var t=n.prevStnIds,e=n.nextStnIds,r=n.nextBranchLineDy,i=n.prevBranchLineDy,a=g((function(n){return n.param})),c=a.direction,o=a.svgWidth,s=a.current_stn_idx,l=a.coline,u=a.theme,d=g((function(n){return n.helper})).branches,h=o.runin/2,m=125,x=function(n){return"".concat(n[0],",").concat(n[1])},p=function(n){return"M".concat(x(n.at(0))," ")+n.slice(1).map((function(n){return"L".concat(x(n))})).join(" ")},j="l"===c?[[o.runin/3,m],[o.runin/6,r],[36,r]]:[[o.runin/3*2,m],[o.runin/6*5,r],[o.runin-36,r]],v="l"===c?[[o.runin/3*2,m],[o.runin/6*5,i],[o.runin-24,i]]:[[o.runin/3,m],[o.runin/6,i],[24,i]],_="var(--rmg-theme-colour)";if(Object.keys(l).length>0){var y=F(Object.values(l),d);e.length>1&&y.filter((function(n){return n.linePath.includes(s)&&e.some((function(t){return n.linePath.includes(t)}))}))&&(j[0][1]-=11,j.unshift([h,114]),_=y.filter((function(n){return n.linePath.includes(s)&&e.some((function(t){return n.linePath.includes(t)}))})).at(0).colors.at(0)[2]),t.length>1&&y.filter((function(n){return n.linePath.includes(s)&&t.some((function(t){return n.linePath.includes(t)}))}))&&(v[0][1]-=11,v.unshift([h,114]))}return f.jsxs("g",{transform:"translate(0,110)",strokeWidth:12,fill:"none",filter:"#B5B5B6"===u[2]?"url(#pujiang_outline)":void 0,children:[f.jsx("marker",{id:"slope_branch",viewBox:"-1.5 0 3 1.5",refY:.5,children:f.jsx("path",{d:"M0,0L1,1H-1z",fill:_})}),e.length>1&&f.jsx("path",{stroke:_,d:p(j),markerEnd:"url(#slope_branch)"}),t.length>1&&f.jsx("path",{stroke:"var(--rmg-grey)",d:p(v)})]})},T=function(){var n=g((function(n){return n.param})),t=n.stn_list[n.current_stn_idx].name;return d.useMemo((function(){return f.jsxs(f.Fragment,{children:[f.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:112,children:t[0].replace("\\","")}),f.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:36,dy:50,children:t[1].replace("\\","")})]})}),u(t))},G=function(n){var e=n.nextName,r=s(n,t);return f.jsx("g",c(c({},r),{},{children:d.useMemo((function(){return f.jsxs(f.Fragment,{children:[e[0].split("\\").map((function(n,t,r){return f.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:48,dy:-50*(r.length-1-t)-30*(e[1].split("\\").length-1),children:n},n)})),e[1].split("\\").map((function(n,t,e){return f.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:24,dy:28+-30*(e.length-1-t),children:n},n)}))]})}),u(e))}))},U=function(n){var t=g((function(n){return n.param})),e=n.stnIds.map((function(n){return t.stn_list[n].name})),r=(n.stnIds.length>1?15:125)+-50*e.map((function(n){return n[0].split("\\").length})).reduce((function(n,t){return n+t}),-e.length)+-30*e.map((function(n){return n[1].split("\\").length})).reduce((function(n,t){return n+t}),-e.length),i=70+(n.stnIds.length>1?-50*(e[0][0].split("\\").length-1)+-30*(e[0][1].split("\\").length-1):0);return f.jsxs("g",{fill:"gray",textAnchor:"l"===t.direction?"end":"start",transform:"translate(".concat("l"===t.direction?t.svgWidth.runin-36:36,",0)"),children:[f.jsx(G,{nextName:e[0],transform:"translate(0,183)"}),n.stnIds.length>1&&f.jsx(G,{nextName:e[1],transform:"translate(0,".concat(i,")")}),f.jsxs("g",{transform:"translate(0, ".concat(r,")"),children:[f.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:22,children:"上一站"}),f.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:12,dx:"l"===t.direction?-70:70,children:"Past Stop"})]})]})},X=function(n){var t=g((function(n){return n.param})),e=n.stnIds.map((function(n){return t.stn_list[n].name})),r=(n.stnIds.length>1?15:125)+-50*e.map((function(n){return n[0].split("\\").length})).reduce((function(n,t){return n+t}),-e.length)+-30*e.map((function(n){return n[1].split("\\").length})).reduce((function(n,t){return n+t}),-e.length),i=70+(n.stnIds.length>1?-50*(e[0][0].split("\\").length-1)+-30*(e[0][1].split("\\").length-1):0);return f.jsxs("g",{textAnchor:"l"===t.direction?"start":"end",transform:"translate(".concat("l"===t.direction?36:t.svgWidth.runin-36,",0)"),children:[f.jsx(G,{nextName:t.stn_list[n.stnIds[0]].name,transform:"translate(0,183)"}),n.stnIds.length>1&&f.jsx(G,{nextName:t.stn_list[n.stnIds[1]].name,transform:"translate(0,".concat(i,")")}),f.jsxs("g",{transform:"translate(0, ".concat(r,")"),children:[f.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:22,children:"下一站"}),f.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:12,dx:"l"===t.direction?70:-70,children:"Next Stop"})]})]})},Z=function(n){var t,e=n.stnId,r=n.stnState,i=n.color,a=n.bank,o=n.direction,s=g((function(n){return n.param})),l=s.direction,d=s.info_panel_type,h=s.stn_list,m=s.loop,x=h[e],p=null!=o?o:l,j=m?0:([].concat(u(x.branch.left),u(x.branch.right)).length?8+12*x.name[1].split("\\").length:0)*("r"===p?-1:1),v={};"sh2020"===d?(t=3===x.services.length?"stn_sh_2020_direct":2===x.services.length?"stn_sh_2020_express":"stn_sh_2020",v.fill=-1===r?"gray":i||"var(--rmg-theme-colour)"):(t=3===x.services.length?"direct_sh":2===x.services.length?"express_sh":[].concat(u(x.transfer.info[0]),u(x.transfer.info[1]||[])).length>0?"int2_sh":"stn_sh",v.stroke=-1===r?"gray":i||"var(--rmg-theme-colour)");var _=null!=a?a:0,y=("l"===p?6:-6)+j+30*_,b=("sh2020"===d?-20:-6)+Math.abs(_)*("sh2020"===d?25:11),w=_?0:"l"===p?-45:45;return f.jsxs(f.Fragment,{children:[f.jsx("use",c(c({xlinkHref:"#".concat(t)},v),{},{transform:"translate(".concat(_*("sh2020"===d?5:0),",0)rotate(").concat(90*_*("sh2020"===d?1:-1),")")})),f.jsx("g",{transform:"translate(".concat(y,",").concat(b,")rotate(").concat(w,")"),children:f.jsx(J,{name:x.name,infos:x.transfer.info,stnState:r,direction:p,facility:x.facility,bank:_,oneLine:x.one_line,intPadding:x.int_padding})}),0===r?f.jsx(q,{}):void 0]})},J=function(n){var t,e=n.name,r=n.infos,i=n.stnState,a=n.direction,c=n.facility,o=n.bank,s=n.oneLine,h=n.intPadding,m=d.useRef(null),g="l"===a?1:-1,p=c!==x.none?30:0,j=o?-12:0,v=d.useRef(null),_=l(d.useState(0),2),y=_[0],b=_[1];d.useEffect((function(){var n,t;return b(null!==(n=null===(t=v.current)||void 0===t?void 0:t.getBBox().width)&&void 0!==n?n:0)}),u(JSON.stringify(r)));var w=h-y;return f.jsxs(f.Fragment,{children:[r.flat().length>0&&f.jsxs(f.Fragment,{children:[f.jsx("line",{x1:(j+p)*g,x2:w*g,stroke:-1===i?"gray":"black",strokeWidth:.5}),f.jsx(K,{ref:v,intInfos:r,direction:a,transform:"translate(".concat(w*g,",-10.75)")})]}),c!==x.none&&f.jsx("use",{xlinkHref:"#"+c,x:10*g,y:-30}),f.jsxs("g",{textAnchor:"l"===a?"start":"end",transform:"translate(".concat(p*g,",-14)"),children:[f.jsx($,{ref:m,stnName:e,oneLine:s,directionPolarity:g,fill:-1===i?"gray":0===i?"red":"black"}),(null===(t=r[1])||void 0===t?void 0:t.length)>0&&f.jsx("g",{transform:"translate(".concat((w+y/2)*g,",-30)"),children:f.jsx(en,{osiInfos:r[1]})}),u(r[2]||[]).length>0&&f.jsx("g",{transform:"translate(".concat((h+5)*g,",0)"),children:f.jsx(rn,{osysiInfos:r[2],direction:n.direction})})]})]})},$=d.forwardRef((function(n,t){var r=n.stnName,i=n.oneLine,a=n.directionPolarity,o=s(n,e),h=d.useRef(null),m=l(d.useState(0),2),g=m[0],x=m[1];d.useEffect((function(){i&&h.current?x(h.current.getBBox().width+5):x(0)}),[].concat(u(r),[i]));return f.jsx("g",c(c({ref:t},o),{},{children:d.useMemo((function(){return f.jsxs(f.Fragment,{children:[f.jsx("g",{ref:h,children:r[0].split("\\").map((function(n,t,e){return f.jsx("text",{className:"rmg-name__zh rmg-outline",dy:-20*(e.length-1-t)+(i?8:-8*(r[1].split("\\").length-1)),children:n},t)}))}),f.jsx("g",{fontSize:8,transform:"translate(".concat(g*a,",0)"),children:r[1].split("\\").map((function(n,t,e){return f.jsx("text",{className:"rmg-name__en rmg-outline",dy:-8*(e.length-2-t)+2,children:n},t)}))})]})}),[].concat(u(r),[i,g,a]))}))})),q=function(){var n=g((function(n){return n.param})).stn_list,t=[-1,35,50,75][new Set(Object.values(n).map((function(n){return n.services})).flat()).size];return f.jsx("g",{transform:"translate(0, ".concat(t,")"),children:f.jsx("text",{className:"rmg-name__zh",fill:"red",textAnchor:"middle",children:"本站"})})},K=d.forwardRef((function(n,t){var e,i=n.intInfos,a=(n.direction,s(n,r)),o=[].concat(u(i[0]),u(i[1]||[]),u((null===(e=i[2])||void 0===e?void 0:e.filter((function(n){return Boolean(n[4].match(/^磁(悬)*浮/))})))||[])),l=0;return f.jsx("g",c(c({ref:t,fontSize:14,textAnchor:"middle"},a),{},{children:o.map((function(t,e){var r,i=Boolean(t[4].match(/^\w+(号)?线/)),a=Boolean(t[4].match(/^磁(悬)*浮/));return"r"===n.direction&&(l-=(i||a?20:14*t[4].length+12)+(0===e?0:5)),r=a?f.jsx("g",{transform:"translate(".concat(l,",-16)scale(0.1428571429)"),children:f.jsx(Q,{info:t})},e):i?f.jsx("g",{transform:"translate(".concat(l,",0)"),children:f.jsx(nn,{info:t})},e):f.jsx("g",{transform:"translate(".concat(l,",0)"),children:f.jsx(tn,{info:t})},e),"l"===n.direction&&(l+=i||a?25:14*t[4].length+12+5),r}))}))})),Q=d.memo((function(n){return f.jsx(f.Fragment,{children:f.jsx("use",{xlinkHref:"#intbox_maglev",fill:n.info[2],stroke:n.info[2]})})}),(function(n,t){return n.info.toString()===t.info.toString()})),nn=d.memo((function(n){var t;return f.jsxs(f.Fragment,{children:[f.jsx("use",{xlinkHref:"#intbox_number",fill:n.info[2]}),f.jsx("text",{x:10,className:"rmg-name__zh",fill:n.info[3],dominantBaseline:"central",children:null===(t=n.info[4].match(/(\d*)\w+/))||void 0===t?void 0:t[0]})]})}),(function(n,t){return n.info.toString()===t.info.toString()})),tn=d.memo((function(n){var t=n.info[4].split("\\")[0].length;return f.jsxs(f.Fragment,{children:[f.jsx("rect",{height:22,width:14*t+12,y:-11,fill:n.info[2]}),f.jsx("text",{x:7*t+6,className:"rmg-name__zh",fill:n.info[3],dominantBaseline:"central",children:n.info[4].split("\\")[0]})]})}),(function(n,t){return n.info.toString()===t.info.toString()})),en=function(n){var t=n.osiInfos.map((function(n){return n[4]})).join("，");return d.useMemo((function(){return f.jsxs("g",{textAnchor:"middle",fontSize:"50%",children:[f.jsx("text",{className:"rmg-name__zh",dy:-5,children:"换乘".concat(t)}),f.jsx("text",{className:"rmg-name__zh",dy:5,children:"仅限公共交通卡"}),f.jsx("text",{className:"rmg-name__en",dy:12.5,fontSize:"75%",children:"Only for Public Transportation Card"})]})}),[t.toString()])},rn=function(n){var t=n.osysiInfos.map((function(n){return n[4]})).join("，"),e=n.osysiInfos.map((function(n){return n[5]})).join(", ");return d.useMemo((function(){return f.jsxs("g",{textAnchor:"l"===n.direction?"start":"end",fontSize:"50%",children:[f.jsxs("text",{className:"rmg-name__zh",dy:3,children:["转乘",t]}),f.jsxs("text",{className:"rmg-name__en",dy:10,fontSize:"75%",children:["To ",e]})]})}),[n.osysiInfos.toString(),n.direction])},an=["shanghai","sh4","#5F259F","#fff","4号线","Line 4"],cn=function(n){var t=n.xs,e=n.servicesPresent,r=n.stnStates,i=g((function(n){return n.param})),a=i.svg_height,s=i.direction,h=i.stn_list,m=i.current_stn_idx,x=i.branchSpacingPct,p=i.info_panel_type,j=i.coline,v=g((function(n){return n.helper})),y=v.branches,b=v.depsStr,w=d.useMemo((function(){return console.log("computing y shares"),Object.keys(h).reduce((function(n,t){if(y[0].includes(t))return c(c({},n),{},o({},t,0));var e=y.slice(1).filter((function(n){return n.includes(t)}))[0];return c(c({},n),{},o({},t,h[e[0]].children.indexOf(e[1])?-3:3))}),{})}),[b]),S=Object.entries(w).filter((function(n){var t=l(n,2);t[0];return t[1]<=0})).reduce((function(n,t){var e=l(t,2),r=e[0],i=e[1];return c(c({},n),{},o({},r,i))}),{}),k=Object.keys(S).reduce((function(n,t){return c(c({},n),{},o({},t,-S[t]*x*a/300))}),{}),M=d.useMemo((function(){return function(n,t){return n.map((function(n){var e=_(n.linePath,t);return{main:[{linePath:e.main,colors:n.colors}],pass:[{linePath:e.pass,colors:n.colors}]}})).reduce((function(n,t){return n.main=[].concat(u(n.main),u(t.main)),n.pass=[].concat(u(n.pass),u(t.pass)),n}),{main:[],pass:[]})}(F(Object.values(j).filter((function(n){return n.display})),y),r)}),[JSON.stringify(j),m,s,b]),O=e.reduce((function(n,r){return c(c({},n),{},o({},r,Object.keys(M).reduce((function(n,i){return c(c({},n),{},o({},i,M[i].map((function(n){return{path:fn(n.linePath,i,t,k,s,r,e.length,h,"diagonal"),colors:n.colors}})).filter((function(n){return""!==n.path}))))}),{})))}),{}),z=F(Object.values(j).filter((function(n){return n.display})),y).map((function(n){return n.linePath})).flat(),I="sh2020"===p?3:0;return f.jsx(f.Fragment,{children:f.jsxs("g",{id:"coline",transform:"translate(0,".concat(12+I,")"),children:[f.jsx(on,{paths:O,direction:s}),f.jsx(sn,{colineStns:M,branches:y,xs:t,ys:k,stnStates:r,lineWidth:12,colineGap:I}),f.jsx(ln,{stnIds:Object.entries(w).filter((function(n){var t=l(n,2);t[0];return t[1]<0})).reduce((function(n,t){var e=l(t,2),r=e[0];e[1];return[].concat(u(n),[r])}),[]).filter((function(n){return!["linestart","lineend"].includes(n)})).filter((function(n){return 0!==h[n].services.length})).filter((function(n){return z.includes(n)})),xs:t,ys:k,stnStates:r})]})})},on=function(n){var t=n.paths,e=n.direction;return f.jsx(f.Fragment,{children:Object.keys(t).map((function(n,r){var i,a;return f.jsx("g",{transform:"translate(0,".concat(25*r,")"),children:f.jsxs("g",{children:[null===(i=t[n])||void 0===i?void 0:i.pass.map((function(t,e){return f.jsx(d.Fragment,{children:f.jsx("path",{stroke:"var(--rmg-grey)",strokeWidth:12,fill:"none",d:t.path,strokeLinejoin:"round",filter:n===p.local?void 0:"url(#contrast-".concat(n,")")},e)},e)})),null===(a=t[n])||void 0===a?void 0:a.main.map((function(t,r){var i;return f.jsxs(d.Fragment,{children:[t.colors.length>1&&f.jsx("linearGradient",{id:"grad".concat(r),y1:"-100%",y2:"100%",x1:"0",x2:"0",gradientUnits:"userSpaceOnUse",children:t.colors.map((function(n,e){return f.jsxs(d.Fragment,{children:[f.jsx("stop",{offset:"".concat(100/t.colors.length*(e+0),"%"),stopColor:n[2]}),f.jsx("stop",{offset:"".concat(100/t.colors.length*(e+1),"%"),stopColor:n[2]})]},e)}))}),"l"===e&&f.jsx("marker",{id:"arrow_left_".concat(r,"_").concat(t.colors.map((function(n){return n[2]})).join("_")),refY:.5,refX:1,children:f.jsx("path",{d:"M1,0L0,1H1z",fill:t.colors.length>1?"url(#grad".concat(r,")"):t.colors[0][2]})}),"r"===e&&f.jsx("marker",{id:"arrow_right_".concat(r,"_").concat(t.colors.map((function(n){return n[2]})).join("_")),refY:.5,children:f.jsx("path",{d:"M0,0L1,1H-1z",fill:t.colors.length>1?"url(#grad".concat(r,")"):t.colors[0][2]})}),f.jsx("path",{stroke:(null!==(i=t.colors.at(-1))&&void 0!==i?i:an)[2],strokeWidth:12,fill:"none",d:t.path,markerStart:"l"===e?"url(#arrow_left_".concat(r,"_").concat(t.colors.map((function(n){return n[2]})).join("_"),")"):void 0,markerEnd:"r"===e?"url(#arrow_right_".concat(r,"_").concat(t.colors.map((function(n){return n[2]})).join("_"),")"):void 0,strokeLinejoin:"round",filter:n===p.local?void 0:"url(#contrast-".concat(n,")")},r)]},r)}))]})},"servicePath".concat(r))}))})},sn=function(n){var t=n.colineStns,e=n.branches,r=n.xs,i=n.ys,a=n.stnStates,c=n.lineWidth,o=n.colineGap,s=g((function(n){return n.param})),l=s.line_name,d=s.theme,h=s.info_panel_type,m=[].concat(u(t.main),u(t.pass)).map((function(n){return n.linePath.map((function(t){var e;return{curStn:t,x:r[t],y:i[t],color:null!==(e=n.colors.at(-1))&&void 0!==e?e:[].concat(u(d),u(l))}}))})).flat().reduce((function(n,t){return n.find((function(n){return n.curStn===t.curStn}))?n:n.concat(t)}),[]).filter((function(n){return e[0].includes(n.curStn)}));return console.log(m),f.jsx("g",{id:"stations_in_mainline",children:m.map((function(n){var t=n.curStn,e=n.x,r=n.y,i=n.color,s=(-1===a[t]?0:c)+o+c,l=(-1===a[t]?0:-c)-o-c/2;return f.jsx("g",{transform:"translate(".concat(e,",").concat(r,")"),children:"sh2020"===h?f.jsx("rect",{stroke:"none",height:s,width:12,x:-6,y:l,fill:-1===a[t]?"var(--rmg-grey)":i[2]}):f.jsx("use",{xlinkHref:"#int2_sh",stroke:"var(--rmg-theme-colour)",transform:"translate(0,".concat(-c,")")})},t)}))})},ln=function(n){var t=n.xs,e=n.ys,r=n.stnStates,i=n.stnIds,a=g((function(n){return n.helper})),s=a.branches,l=a.depsStr,h=g((function(n){return n.param})),m=h.line_name,x=h.theme,p=h.coline,j=d.useMemo((function(){return F(Object.values(p),s)}),[JSON.stringify(p),l]),v=i.reduce((function(n,t){var e;return c(c({},n),{},o({},t,null!==(e=j.filter((function(n){return n.linePath.includes(t)})).map((function(n){return n.colors})).flat().at(0))&&void 0!==e?e:[].concat(u(x),u(m))))}),{});return f.jsx("g",{id:"stations_in_coline",children:i.map((function(n){return f.jsx("g",{transform:"translate(".concat(t[n],",").concat(e[n],")"),children:f.jsx(Z,{stnId:n,stnState:r[n],color:v[n][2]})},n)}))})},un=function(){var n=g((function(n){return n.helper})),t=n.routes,e=n.branches,r=n.depsStr,i=g((function(n){return n.param})),a=g((function(n){return n.param})),s=a.svg_height,u=a.stn_list,h=a.branchSpacingPct,m=a.coline,x=a.direction,j=y(i.stn_list,(function(){return 0}),(function(){return 0})),v=b("linestart","lineend",j),k=b(v.nodes[1],v.nodes.slice(-2)[0],j),M=d.useMemo((function(){return console.log("computing x shares"),Object.keys(i.stn_list).reduce((function(n,t){return c(c({},n),{},o({},t,w(t,j,e)))}),{})}),[e.toString(),JSON.stringify(j)]),O=[i.svgWidth.railmap*i.padding/100,i.svgWidth.railmap*(1-i.padding/100)],z=Object.keys(M).reduce((function(n,t){return c(c({},n),{},o({},t,O[0]+M[t]/k.len*(O[1]-O[0])))}),{}),I=d.useMemo((function(){return console.log("computing y shares"),Object.keys(u).reduce((function(n,t){if(e[0].includes(t))return c(c({},n),{},o({},t,0));var r=e.slice(1).filter((function(n){return n.includes(t)}))[0];return c(c({},n),{},o({},t,u[r[0]].children.indexOf(r[1])?-3:3))}),{})}),[r]),N=Object.entries(I).filter((function(n){return l(n,2)[1]>=0})).reduce((function(n,t){var e=l(t,2),r=e[0],i=e[1];return c(c({},n),{},o({},r,i))}),{}),H=Object.keys(N).reduce((function(n,t){return c(c({},n),{},o({},t,-N[t]*h*s/300))}),{}),L=d.useMemo((function(){return S(i.current_stn_idx,t,i.direction)}),[i.current_stn_idx,i.direction,t.toString()]),W=Object.values(p),P=Object.values(i.stn_list).map((function(n){return n.services})).flat().reduce((function(n,t){return n[W.indexOf(t)]=!0,n}),[!1,!1,!1]).map((function(n,t){return[W[t],n]})).filter((function(n){return n[1]})).map((function(n){return n[0]})),F=e.map((function(n){return _(n,L)})).reduce((function(n,t){return n.main.push(t.main),n.pass.push(t.pass),n}),{main:[],pass:[]}),B=P.reduce((function(n,t){return c(c({},n),{},o({},t,Object.keys(F).reduce((function(n,e){return c(c({},n),{},o({},e,F[e].map((function(n){return fn(n,e,z,H,x,t,P.length,u)})).filter((function(n){return""!==n}))))}),{})))}),{});return f.jsxs("g",{id:"main",transform:"translate(0,".concat(i.svg_height*(Object.keys(m).length>0?.5:.7+.1),")"),children:[f.jsx(dn,{paths:B,direction:i.direction}),f.jsx(hn,{stnIds:Object.keys(N).filter((function(n){return!["linestart","lineend"].includes(n)})).filter((function(n){return 0!==u[n].services.length})),xs:z,ys:H,stnStates:L}),Object.keys(m).length>0&&f.jsx(cn,{xs:z,servicesPresent:P,stnStates:L}),P.length>1&&f.jsx(mn,{servicesLevel:P,lineXs:O})]})},dn=function(n){var t=g((function(n){return n.param})).theme,e=n.paths,r=n.direction;return f.jsx(f.Fragment,{children:Object.keys(e).map((function(i,a){var c,o;return f.jsxs("g",{transform:"translate(0,".concat(25*a,")"),filter:"#B5B5B6"===t[2]?"url(#pujiang_outline)":void 0,children:[f.jsx("g",{children:null===(c=e[i])||void 0===c?void 0:c.pass.map((function(t,e){return f.jsx("path",{stroke:"var(--rmg-grey)",strokeWidth:12,fill:"none",d:t,markerStart:"l"===n.direction?"url(#arrow_gray)":void 0,markerEnd:"r"===n.direction?"url(#arrow_gray)":void 0,strokeLinejoin:"round"},e)}))}),f.jsx("g",{children:null===(o=e[i])||void 0===o?void 0:o.main.map((function(n,t){return f.jsx("path",{stroke:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:n,markerStart:"l"===r?"url(#arrow_theme_left)":void 0,markerEnd:"r"===r?"url(#arrow_theme_right)":void 0,strokeLinejoin:"round",filter:i===p.local?void 0:"url(#contrast-".concat(i,")")},t)}))})]},"servicePath".concat(a))}))})},fn=function(n,t,e,r,i,a,c,o){var s=arguments.length>8&&void 0!==arguments[8]?arguments[8]:"rightangle",u=[],d=u[0],f=u[1],h={},m={local:0,express:20,direct:40}[a],g=c>1?50:0,x=30;if(n.length>0){var p=!1,j=!1;o[n.at(-1)||0].children.some((function(n){return["linestart","lineend"].includes(n)}))?j=!0:o[n.at(0)||0].parents.some((function(n){return["linestart","lineend"].includes(n)}))&&(p=!0),x=p||j?x:0}var v=30;if(n.forEach((function(n){var t=e[n],i=r[n];if(!d&&0!==d)return f=t,d=i,void(h.start=[t,i]);0===i?i!==d&&(h.bifurcate=[f,d]):i!==d&&(h.bifurcate=[t,i]),h.end=[t,i],f=t,d=i})),"start"in h){if("end"in h){if("bifurcate"in h){var _=l(h.start,2),y=_[0],b=_[1],w=h.bifurcate[0],S=l(h.end,2),k=S[0],M=S[1];return"main"===t?"l"===i?M>b?(console.log(h),"rightangle"===s?"M ".concat(y-x,",").concat(b," H ").concat(k," V ").concat(M):"M ".concat(y,",").concat(b," H ").concat(y+v," L ").concat(w-v,",").concat(M," H ").concat(k)):"rightangle"===s?"M ".concat(y,",").concat(b," V ").concat(M," H ").concat(k):"M ".concat(y-x,",").concat(b," H ").concat(w+v," L ").concat(k-v,",").concat(M," H ").concat(k):M>b?"rightangle"===s?"M ".concat(y,",").concat(b," H ").concat(k," V ").concat(M):"M ".concat(y,",").concat(b," H ").concat(y+v," L ").concat(w-v,",").concat(M," H ").concat(k+x):"rightangle"===s?"M ".concat(y,",").concat(b," V ").concat(M," H ").concat(k+x):"M ".concat(y,",").concat(b," H ").concat(w+v," L ").concat(k-v,",").concat(M," H ").concat(k):M>b?"rightangle"===s?"M ".concat(y-x,",").concat(b," H ").concat(k," V ").concat(M):"M ".concat(y,",").concat(b," H ").concat(y+v," L ").concat(w-v,",").concat(M," H ").concat(k+x):"rightangle"===s?"M ".concat(y,",").concat(b," V ").concat(M," H ").concat(k+x):"M ".concat(y-x,",").concat(b," H ").concat(w+v," L ").concat(k-v,",").concat(M," H ").concat(k)}var O=l(h.start,2),z=O[0],I=O[1],N=h.end[0];return"main"===t?"l"===i?"M ".concat(z-x-m,",").concat(I," H ").concat(N):"M ".concat(z,",").concat(I," H ").concat(N+x+m):"l"===i?"M ".concat(z-x,",").concat(I," H ").concat(N+x+g):"M ".concat(z-x-g,",").concat(I," H ").concat(N+x)}var H=l(h.start,2),L=H[0],W=H[1];return"main"===t?"l"===i?"M ".concat(L-x-m,",").concat(W," H ").concat(L):"M ".concat(L,",").concat(W," H ").concat(L+x+m):"l"===i?"M ".concat(L,",").concat(W," L ").concat(L+x+g,",").concat(W):"M ".concat(L-x-g,",").concat(W," L ").concat(L,",").concat(W)}return""},hn=function(n){var t=n.xs,e=n.ys,r=n.stnStates,i=n.stnIds;return f.jsx("g",{children:i.map((function(n){return f.jsx("g",{transform:"translate(".concat(t[n],",").concat(e[n],")"),children:f.jsx(Z,{stnId:n,stnState:r[n]})},n)}))})},mn=function(n){var t=g((function(n){return n.param})),e=t.svg_height,r=t.direction,i=t.svgWidth,a=130-e,c=n.servicesLevel.map((function(n){return{local:"普通车",express:"大站车",direct:"直达车"}[n]})),o="r"===r?n.lineXs[0]-42:n.lineXs[1]+42,s=2===n.servicesLevel.length?350:500;return d.useMemo((function(){return f.jsxs("g",{children:[c.map((function(n,t){return f.jsxs("g",{transform:"translate(".concat(o,",").concat(25*t,")"),children:[f.jsx("rect",{x:-27.5,height:10,width:55,fill:"white",stroke:"black",y:-5}),f.jsx("text",{className:"rmg-name__zh",fontSize:9,y:3,textAnchor:"middle",children:"".concat(n,"运行线")})]},n)})),f.jsxs("g",{transform:"translate(".concat("r"===r?30:i.railmap-s,",").concat(a,")"),children:[f.jsx("text",{className:"rmg-name__zh",children:"图例："}),c.map((function(n,t){return f.jsxs("g",{transform:"translate(".concat(150*t+50,",0)"),children:[f.jsx("line",{x1:"0",x2:"35",y1:"-5",y2:"-5",stroke:"var(--rmg-theme-colour)",strokeWidth:"12",filter:2===t?"url(#contrast-direct)":1===t?"url(#contrast-express)":""}),f.jsx("use",{x:"17.5",y:"-5",xlinkHref:"#stn_sh",fill:"var(--rmg-theme-colour)"}),f.jsx("text",{x:"40",className:"rmg-name__zh",children:"".concat(n,"停靠站")})]},"serviceLevel".concat(t))}))]})]})}),[e,r,i,n.servicesLevel,n.lineXs])},gn=function(){var n=g((function(n){return n.param})),t=n.direction,e=n.svgWidth,r=n.coline,i=!!Object.keys(r).length;return d.useMemo((function(){return f.jsxs("g",{transform:"translate(".concat("l"===t?50:e.railmap-150,",50)"),children:[f.jsx("text",{className:"rmg-name__zh",children:"列车前进方向"}),f.jsx("path",{d:"M60,60L0,0L60-60H100L55-15H160V15H55L100,60z",stroke:i?"var(--rmg-black)":void 0,strokeWidth:i?5:void 0,fill:i?"var(--rmg-white)":"var(--rmg-theme-colour)",transform:"translate(".concat("l"===t?-30:125,",-5)rotate(").concat("l"===t?0:180,")scale(0.15)")})]})}),[t,r,e.railmap])},xn=function(n){var t,e=n.stnId,r=n.nameDirection,i=n.services,a=n.color,c=g((function(n){return n.param.stn_list[e]})),o=[].concat(u(c.transfer.info[0]),u(c.transfer.info[1]||[]));t=3===c.services.length?"direct_indoor_sh":2===c.services.length?"express_indoor_sh":o.length>0?"int2_indoor_sh":"stn_indoor_sh";var s="left"===r||"right"===r?90:0;return f.jsxs(f.Fragment,{children:[f.jsx(pn,{name:c.name,infos:c.transfer.info,nameDirection:r,services:i}),f.jsx("use",{xlinkHref:"#".concat(t),stroke:o.length>0?"var(--rmg-black)":null!=a?a:"var(--rmg-theme-colour)",transform:"rotate(".concat(s,")")}),c.services.length>1&&f.jsx("text",{className:"rmg-name__zh",writingMode:"tb",fontSize:"60%",dy:"-12",children:"大站车".concat(c.services.length>2?" 直达车":"","停靠")})]})},pn=function(n){var t,e,r,i,a,c,o,s,l=n.name,d=n.infos,h=n.nameDirection,m=n.services,g={upward:60,downward:-30,left:0,right:0}[h],x={upward:0,downward:0,left:85,right:-85}[h],p={upward:-185,downward:150+(3===m.length?40:0),left:-30,right:-30}[h],j=(null===(t=d[2])||void 0===t?void 0:t.length)>0?{upward:0,downward:0,left:d[0].length+d[1].length!==0?85:25,right:d[0].length+d[1].length!==0?-85:-25}[h]:0,v=(null===(e=d[2])||void 0===e?void 0:e.length)>0?{upward:null!==(r=d[1])&&void 0!==r&&r.length?-210:d[0].length?-180:-100,downward:(null!==(i=d[1])&&void 0!==i&&i.length?190:d[0].length?160:100)+(3===m.length?40:0),left:null!==(a=d[1])&&void 0!==a&&a.length?-60:d[0].length?-30:0,right:null!==(c=d[1])&&void 0!==c&&c.length?-60:d[0].length?-30:0}[h]:0;return f.jsxs("g",{transform:"translate(0,".concat(g,")"),children:["upward"===h||"downward"===h?f.jsxs(f.Fragment,{children:[f.jsx("line",{x1:-30,x2:30,y1:"upward"===h?-23:-10,y2:"upward"===h?-23:-10,stroke:"black"}),f.jsx("line",{y1:"upward"===h?-23:-10,y2:"upward"===h?-48:20,stroke:"black"})]}):f.jsxs(f.Fragment,{children:[f.jsx("line",{x1:"left"===h?-50:15,x2:"left"===h?-15:50,y1:0,y2:0,stroke:"black"}),f.jsx("line",{x1:"left"===h?-50:50,x2:"left"===h?-50:50,y1:-30,y2:30,stroke:"black"})]}),[].concat(u(d[0]),u(d[1]||[])).length>0&&f.jsx(vn,{intInfos:[].concat(u(d[0]),u(d[1]||[])),arrowDirection:h,services:m}),f.jsx(jn,{stnName:l,nameDirection:h,fill:"black"}),(null===(o=d[1])||void 0===o?void 0:o.length)>0&&f.jsx("g",{transform:"translate(".concat(x,",").concat(p,")"),children:f.jsx(_n,{osiInfos:d[1],nameDirection:h})}),(null===(s=d[2])||void 0===s?void 0:s.length)>0&&f.jsx("g",{transform:"translate(".concat(j,",").concat(v,")"),children:f.jsx(yn,{osysiInfos:d[2],nameDirection:h})})]})},jn=d.forwardRef((function(n,t){var e=n.stnName,r=n.nameDirection,a=s(n,i),o=e[0].split("\\"),l=e[1].split("\\").length,h={upward:0,downward:0,left:-60,right:60}[r],m={upward:-2,downward:-30-12*(l-1),left:-10*(l-1),right:-10*(l-1)}[r],g={upward:"middle",downward:"middle",left:"end",right:"start"}[r];return f.jsx("g",c(c({ref:t},a),{},{textAnchor:g,transform:"translate(".concat(h,",").concat(m,")"),children:d.useMemo((function(){return f.jsxs(f.Fragment,{children:[o.map((function(n,t,e){return f.jsx("text",{className:"rmg-name__zh",dy:"upward"===r?16*t:-16*(e.length-1-t),children:n},t)})),f.jsx("g",{fontSize:9.6,children:e[1].split("\\").map((function(n,t){return f.jsx("text",{className:"rmg-name__en",dy:12*(t+1)+("upward"===r&&o.length>1?7.5*o.length:0),children:n},t)}))})]})}),u(e))}))})),vn=function(n){var t=n.intInfos,e=n.arrowDirection,r=n.services,i=t.map((function(n){return n[2]})).reduce((function(n,t){return n+t}),""),a=[t.filter((function(n){return n[4].match(/^\d+.*$/)})).map((function(n){return n[4].replace(/^(\d+)(.*)$/,"$1")})).join("，").concat("号线"),t.filter((function(n){return!n[4].match(/^\d+.*$/)})).map((function(n){return n[4]})).join("，")].filter((function(n){return n&&"号线"!==n})).join("，"),c=["Line ".concat(t.filter((function(n){return n[5].match(/^(L|l)ine$/)})).map((function(n){return n[5].replace("Line","").replace("line","").trim()})).join(",")),t.filter((function(n){return!n[5].match(/^(L|l)ine$/)})).map((function(n){return n[5]})).join("，")].filter((function(n){return n&&"Line "!==n})).join(","),o=3===r.length?80:45,s={upward:-145,downward:125+(3===r.length?40:0),left:7,right:7}[e],l={upward:0,downward:0,left:20,right:-20}[e],u={upward:-74,downward:44,left:0,right:0}[e],h={upward:0,downward:180,left:90,right:-90}[e],m={upward:0,downward:0,left:85,right:-85}[e],g={upward:"middle",downward:"middle",left:"start",right:"end"}[e];return f.jsxs("g",{children:[f.jsx("path",{id:"int_indoor_arrow_sh",stroke:"var(--rmg-black)",strokeWidth:1,transform:"translate(".concat(l,",").concat(u,")rotate(").concat(h,")"),fill:1===t.length?t[0][2]:"url(#grad".concat(i,")"),d:"M -7.5,0 v -".concat(o," h -7.5 l 15,-15 l 15,15 h -7.5 v ").concat(o," Z")}),t.length>1&&f.jsx(f.Fragment,{children:f.jsx("linearGradient",{id:"grad".concat(i),y1:"0",y2:"0",x1:"upward"===e?"25%":"75%",x2:"upward"===e?"75%":"25%",children:t.map((function(n,e){return f.jsxs(d.Fragment,{children:[f.jsx("stop",{offset:"".concat(100/t.length*e,"%"),stopColor:n[2]}),f.jsx("stop",{offset:"".concat(100/t.length*(e+1),"%"),stopColor:n[2]})]},e)}))})}),f.jsxs("g",{transform:"translate(".concat(m,",").concat(s,")"),textAnchor:"".concat(g),children:[f.jsx("text",{className:"rmg-name__zh",dy:-7,children:"换乘".concat(a)}),f.jsx("text",{className:"rmg-name__en",dy:5,fontSize:9.6,children:"Interchange ".concat(c)})]})]})},_n=function(n){var t={upward:"middle",downward:"middle",left:"start",right:"end"}[n.nameDirection];return d.useMemo((function(){return f.jsxs("g",{textAnchor:"".concat(t),fontSize:"50%",children:[f.jsx("text",{className:"rmg-name__zh",dy:-5,children:"换乘".concat(n.osiInfos.map((function(n){return n[4]})).join("，"))}),f.jsx("text",{className:"rmg-name__zh",dy:5,children:"仅限公共交通卡"}),f.jsx("text",{className:"rmg-name__en",dy:12.5,fontSize:"75%",children:"Only for Public Transportation Card"})]})}),[n.osiInfos.toString(),n.nameDirection])},yn=function(n){var t={upward:"middle",downward:"middle",left:"start",right:"end"}[n.nameDirection];return d.useMemo((function(){return f.jsxs("g",{textAnchor:"".concat(t),children:[f.jsx("text",{className:"rmg-name__zh",dy:-5,children:"转乘".concat(n.osysiInfos.map((function(n){return n[4]})).join("，"))}),f.jsx("text",{className:"rmg-name__en",dy:7.5,fontSize:9.6,children:"To ".concat(n.osysiInfos.map((function(n){return n[5]})).join(", "))})]})}),[n.osysiInfos.toString(),n.nameDirection])},bn=function(n){var t,e,r,i,a=n.loop_branches,c=n.edges,o=n.xs,s=n.ys,u=n.canvas,d=l(c,4),x=d[0],j=d[1],v=d[2],_=(d[3],g((function(n){return n.helper})).branches),y=g((function(n){return n.param})),b=y.current_stn_idx,w=y.direction,S=y.coline,k=u===m.RailMap?30:0,M=["M ".concat(x,",").concat(v," H ").concat(Number(o[null!==(t=null===(e=a.at(0))||void 0===e?void 0:e.at(0))&&void 0!==t?t:""])-k),"M ".concat(j,",").concat(v," H ").concat(Number(o[null!==(r=null===(i=a.at(1))||void 0===i?void 0:i.at(-1))&&void 0!==r?r:""])+k)],O=_[0].filter((function(n){return!["linestart","lineend"].includes(n)})),z=Object.values(S).filter((function(n){return![n.from,n.to].every((function(n){return O.includes(n)}))})).map((function(n){return n.colors}));return f.jsx(f.Fragment,{children:a.map((function(n,t){var e,r,i;return f.jsxs(h.Fragment,{children:[z.filter((function(n,t,e){return t===e.findIndex((function(t){var e,r;return(null===(e=t.at(0))||void 0===e?void 0:e.at(2))===(null===(r=n.at(0))||void 0===r?void 0:r.at(2))}))})).map((function(n){return f.jsx("marker",{id:"arrow_theme_".concat(n[0][2]),refX:1,refY:.5,children:f.jsx("path",{d:"M0,1H2L1,0z",fill:n[0][2]})},n[0][2])})),f.jsx("path",{stroke:null!==(e=null===(r=z.at(t))||void 0===r||null===(i=r.at(0))||void 0===i?void 0:i.at(2))&&void 0!==e?e:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:M[t],markerEnd:u===m.RailMap&&("l"===w&&0===t||"r"===w&&1===t)?z.at(t)?"url(#arrow_theme_".concat(z[t][0][2],")"):"url(#arrow_theme)":void 0}),n.filter((function(n){return!["linestart","lineend"].includes(n)})).map((function(n){var e,r,i,c;return f.jsxs(h.Fragment,{children:[u===m.RailMap&&f.jsx("g",{transform:"translate(".concat(o[n],",").concat(s[n],")"),children:f.jsx(Z,{stnId:n,stnState:b===n?0:1,bank:0,direction:w,color:null===(e=z.at(t))||void 0===e||null===(r=e.at(0))||void 0===r?void 0:r.at(2)})},n),u===m.Indoor&&f.jsx("g",{transform:"translate(".concat(o[n],",").concat(s[n],")"),children:f.jsx(xn,{stnId:n,nameDirection:a.filter((function(t){return t.includes(n)})).map((function(t){return t.indexOf(n)%2==0?"downward":"upward"}))[0],services:[p.local],color:null===(i=z.at(t))||void 0===i||null===(c=i.at(0))||void 0===c?void 0:c.at(2)})},n)]},n)}))]},n.at(0))}))})},wn=function(n){var t,e=n.edges,r=n.loop_stns,i=n.xs,a=n.ys,c=n.canvas,o=l(e,4),s=o[0],u=o[1],d=o[2],h=(o[3],g((function(n){return n.param}))),x=h.info_panel_type,p=h.stn_list,v=h.coline,_=g((function(n){return n.helper})).branches,y=Object.values(v).filter((function(n){return[n.from,n.to].every((function(n){return _.slice(1,3).filter((function(n){return j(n,p)})).flat().includes(n)}))})).map((function(n){return n.colors})).at(0),b=c===m.RailMap&&"sh2020"===x?3:0;return f.jsxs("g",{id:"coline_main",children:[f.jsx("path",{d:"M ".concat(s,",").concat(d," H").concat(u),strokeWidth:12,stroke:null==y||null===(t=y.at(0))||void 0===t?void 0:t.at(2)}),c===m.RailMap&&Object.keys(v).length>0&&r.top.map((function(n){var t;return f.jsx("g",{transform:"translate(".concat(i[n],",").concat(a[n],")"),children:"sh2020"===x?f.jsxs(f.Fragment,{children:[f.jsx("rect",{stroke:"none",height:24,width:12,x:-6,y:-b-1,fill:null==y||null===(t=y.at(0))||void 0===t?void 0:t.at(2)}),f.jsx("rect",{stroke:"none",height:b+12,width:12,x:-6,y:10,fill:"var(--rmg-theme-colour)"})]}):f.jsx("use",{xlinkHref:"#int2_sh",stroke:"var(--rmg-theme-colour)",transform:"translate(0,".concat(13,")")})},n)}))]})},Sn=function(n){var t,e,r=n.bank_angle,i=n.canvas,s=g((function(n){return n.helper})).branches,d=g((function(n){return n.param})),h=d.current_stn_idx,x=d.svgWidth,p=d.svg_height,v=d.padding,_=d.branchSpacingPct,y=d.direction,b=d.info_panel_type,w=d.stn_list,S=d.loop_info,k=S.left_and_right_factor,M=S.bottom_factor,O=d.coline,z=s[0].filter((function(n){return!["linestart","lineend"].includes(n)})),I=s.slice(0,3).flat().filter((e={},function(n){return 2===(e[n]=(e[n]||0)+1)})).filter((function(n){return!["linestart","lineend"].includes(n)})),N=null!==(t=Object.values(O).filter((function(n){return[n.from,n.to].every((function(n){return s.slice(1,3).filter((function(n){return j(n,w)})).flat().includes(n)}))})).map((function(n){var t=z.findIndex((function(t){return t===n.from})),e=z.findIndex((function(t){return t===n.to}));return Math.abs(e-t)>z.length-2-Math.abs(e-t)?"major":"minor"})).at(0))&&void 0!==t?t:"minor",H=I.at(1)?function(n,t,e,r){var i=n.findIndex((function(n){return n===t[0]})),c=n.findIndex((function(n){return n===t[1]})),o=l(i>c?[c,i,t[1],t[0]]:[i,c,t[0],t[1]],4);i=o[0],c=o[1],t[0]=o[2],t[1]=o[3];var s=n.slice(i,c+1),u=n.filter((function(n){return!s.filter((function(n){return!t.includes(n)})).includes(n)})),d=n.length-("major"===r?Math.max:Math.min)(s.length,u.length)-2*e,f="major"===r?s.length>u.length?t[0]:t[1]:s.length>u.length?t[1]:t[0];return a(n,f,d,e)}(z,I,k,N):I.at(0)?a(z,I[0],M,k):function(n,t,e,r){var i=n.length-2*r-e,a=n.findIndex((function(n){return n===t})),c=[].concat(u(n),u(n),u(n)),o=n.length+a-Math.floor(i/2)+(i%2==0?1:0),s=n.length+a+Math.floor(i/2);return{top:c.slice(o,s+1),left:c.slice(o-r,o),right:c.slice(s+1,s+1+r),bottom:c.slice(s+1+r,s+1+r+e)}}(z,h,M,k),L=function(n,t){var e=Object.fromEntries(n.map((function(n){return[n,-1]}))),r=Object.fromEntries(n.map((function(n){return[n,-1]})));return t.top.forEach((function(n,i){e[n]=0+1/(t.top.length+1)*(i+1),r[n]=0})),t.right.forEach((function(n,i){e[n]=1,r[n]=0+1/(t.right.length+1)*(i+1)})),t.bottom.forEach((function(n,i){e[n]=1-1/(t.bottom.length+1)*(i+1),r[n]=1})),t.left.forEach((function(n,i){e[n]=0,r[n]=1-1/(t.left.length+1)*(i+1)})),{x_shares:e,y_shares:r}}(z,H),W=L.x_shares,P=L.y_shares,F=function(n,t,e,r,i,a){var o,s,l,d,f=n[0].filter((function(n){return!["linestart","lineend"].includes(n)})),h=n.slice(1,3).map((function(n){return n.slice(1,n.length-1)})),m=h.reduce((function(n,e){return n+e.filter((function(n){return!["linestart","lineend"].concat(u(t)).includes(n)})).length}),0)+f.length-a-2*i,g=(e-e*r/100*2)/(1+m),x=[e*r/100+(null!==(o=h.at(0))&&void 0!==o?o:[]).length*g,e*(1-r/100)-(null!==(s=h.at(1))&&void 0!==s?s:[]).length*g],p=c(c({},Object.fromEntries((null!==(l=h.at(0))&&void 0!==l?l:[]).map((function(n,t){return[n,e*r/100+t*g]})))),Object.fromEntries((null!==(d=h.at(1))&&void 0!==d?d:[]).map((function(n,t){return[n,x[1]+(1+t)*g]}))));return{loop_branches:h,line_xs_branches:x,xs_branches:p}}(s,I,x[i],v,k,H.bottom.length),B=F.loop_branches,E=F.line_xs_branches,A=F.xs_branches,D=c(c({},P),Object.fromEntries(B.flat().map((function(n){return[n,0]})))),R=_*p/300,C=[225+R,p-75-(i===m.RailMap?0:125)-R],V=Object.keys(D).reduce((function(n,t){return c(c({},n),{},o({},t,C[0]+D[t]*(C[1]-C[0])))}),{}),Y=[Math.max(x[i]*v/100+(r&&i===m.RailMap?100:0),E[0]),Math.min(x[i]*(1-v/100)-(r&&i===m.RailMap?100:0),E[1])],T=Object.keys(W).reduce((function(n,t){return c(c({},n),{},o({},t,Y[0]+W[t]*(Y[1]-Y[0])))}),{}),G=r?{l:1,r:-1}[y]:0;[].concat(u(H.right),u(H.left)).forEach((function(n){T[n]-=(V[n]-C[0])*G})),H.bottom.forEach((function(n){T[n]-=(C[1]-C[0])*G}));var U=c(c({},A),T),X=kn(H,U,V,G,[].concat(Y,C),y),Z=i===m.RailMap&&"sh2020"===b?3:0;Object.keys(O).length>0&&H.top.forEach((function(n){V[n]-=Z+12}));var J=B.length?0:(C[1]-C[0])*G/2;return f.jsxs("g",{id:"loop",transform:"translate(".concat(J,",0)"),children:[f.jsx("path",{stroke:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:X,strokeLinejoin:"round"}),i===m.RailMap&&f.jsx(Mn,{canvas:i,loop_stns:H,xs:U,ys:V}),f.jsxs("g",{transform:"translate(0,".concat(Object.keys(O).length>0?-12-Z:0,")"),children:[f.jsx(bn,{loop_branches:B,edges:[].concat(Y,C),xs:U,ys:V,canvas:i}),Object.keys(O).length>0&&f.jsx(wn,{edges:[].concat(Y,C),loop_stns:H,xs:U,ys:V,canvas:i})]}),i===m.Indoor&&f.jsx(Mn,{canvas:i,loop_stns:H,xs:U,ys:V})]})},kn=function(n,t,e,r,i,a){var c=l(i,4),o=c[0],s=c[1],u=c[2],d=c[3],f=function(n,t,e,i,a){return{right:[e+(i-u)*r,t],bottom:[n-(d-t)*r,i],left:[e-(d-i)*r,t],top:[n+(t-u)*r,i]}[a]},h=[];n.top.forEach((function(n){h.push([t[n],e[n]])})),["right","bottom","left"].forEach((function(i){if(n[i].length>0)h.push(f(h.at(-1)[0],h.at(-1)[1],t[n[i][0]],e[n[i][0]],i)),n[i].forEach((function(n){h.push([t[n],e[n]])}));else{var c={right:[s,h.at(-1)[1]],bottom:[h.at(-1)[0]+(d-h.at(-1)[1])*-r,h.at(-1)[1]+(d-h.at(-1)[1])],left:[o+(0===r?0:(d-u)*("l"===a?-1:1)),h.at(-1)[1]]};h.push(c[i])}})),h.push(f(h.at(-1)[0],h.at(-1)[1],t[n.top[0]],e[n.top[0]],"top"));var m=h.slice(1).map((function(n){var t=l(n,2),e=t[0],r=t[1];return"L".concat(e,",").concat(r," ")})).join(" ");return"M".concat(h[0][0],",").concat(h[0][1]," ").concat(m," Z")},Mn=function(n){var t=n.canvas,e=n.loop_stns,r=n.xs,i=n.ys,a=g((function(n){return n.param})).current_stn_idx,c={top:0,bottom:0,left:-1,right:1},o={left:"r",right:"l",top:void 0,bottom:void 0},s=function(n,t){return{top:t%2==0?"upward":"downward",bottom:t%2==0?"upward":"downward",left:"left",right:"right"}[n]};return f.jsxs("g",{id:"loop_stations",children:[t===m.RailMap&&Object.entries(e).map((function(n){var t=l(n,2),e=t[0];return t[1].map((function(n){return f.jsx("g",{transform:"translate(".concat(r[n],",").concat(i[n],")"),children:f.jsx(Z,{stnId:n,stnState:a===n?0:1,bank:c[e],direction:o[e]})},n)}))})),t===m.Indoor&&Object.entries(e).map((function(n){var t=l(n,2),e=t[0];return t[1].map((function(n,t){return f.jsx("g",{transform:"translate(".concat(r[n],",").concat(i[n],")"),children:f.jsx(xn,{stnId:n,nameDirection:s(e,t),services:[p.local]})},n)}))}))]})},On=m.RailMap;function zn(){var n=g((function(n){return n.app})).canvasScale,t=g((function(n){return n.param})),e=t.svgWidth,r=t.svg_height,i=t.theme,a=t.loop,c=t.loop_info.bank,o=e[On];return f.jsxs(v,{type:On,svgWidth:o,svgHeight:r,canvasScale:n,theme:i,children:[f.jsx(In,{}),a?f.jsx(Sn,{bank_angle:c,canvas:m.RailMap}):f.jsx(un,{}),f.jsx(gn,{})]})}var In=d.memo((function(){return f.jsxs("defs",{children:[f.jsx("circle",{id:"stn_sh",fill:"var(--rmg-white)",strokeWidth:2,r:5}),f.jsx("path",{id:"int2_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V10 a 5,5 0 1 1 -10,0Z"}),f.jsx("path",{id:"express_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V25 a 5,5 0 1 1 -10,0Z"}),f.jsx("path",{id:"direct_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V50 a 5,5 0 1 1 -10,0Z"}),f.jsx("rect",{id:"stn_sh_2020",stroke:"none",height:24,width:12,x:-6,y:-18}),f.jsx("rect",{id:"stn_sh_2020_express",stroke:"none",height:49,width:12,x:-6,y:-18}),f.jsx("rect",{id:"stn_sh_2020_direct",stroke:"none",height:74,width:12,x:-6,y:-18}),f.jsx("rect",{id:"intbox_number",height:22,width:20,y:-11}),f.jsxs("g",{id:"intbox_maglev",transform:"translate(-25,0)",children:[f.jsx("rect",{id:"maglev_5",height:144,width:130,y:"40",x:"30",strokeWidth:10}),f.jsx("path",{id:"maglev_3",fill:"var(--rmg-white)",d:"m90,55a40,5 0 0 0 -40,3a5,5 0 0 0 -5,5a5,60 0 0 0 -3,60a5,5 0 0 0 5,5l96,0a5,5 0 0 0 5,-5a5,60 0 0 0 -3,-60a5,5 0 0 0 -5,-5a40,5 0 0 0 -40,-3l-5,-10l-5,10"}),f.jsx("path",{id:"maglev_4",fill:"var(--rmg-white)",d:"m90,140l-40,0a10,5 0 0 1 -10,-5l0,25a10,15 0 0 0 10,15l15,0l0,-10l-15,0l0,-15l90,0l0,15l-15,0l0,10l15,0a10,15 0 0 0 10,-15l0,-25a10,5 0 0 1 -10,5l-50,0"}),f.jsx("rect",{id:"maglev_1",height:"25",width:"40",y:"80",x:"50"}),f.jsx("rect",{id:"maglev_2",height:"25",width:"40",y:"80",x:"100"})]}),f.jsxs("g",{id:"airport",transform:"scale(0.5)",children:[f.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)"}),f.jsx("path",{id:"airport",d:"M28.9769,6.60134c1.711.013,3.111,2.53205,3.111,4.241v10.337s17.106,15.435,17.358,15.666a1.145,1.145,0,0,1,.488,1.152v2.833c0,.651-.451.61-.695.467-.334-.119-17.151-8.863-17.151-8.863-.004,1.458-.797,9.006-1.326,13.304,0,0,4.61,2.457,4.699,2.521.334.268.352.359.352.852v2.001c0,.477-.352.428-.51.324-.183-.062-5.693-1.921-5.693-1.921a2.56018,2.56018,0,0,0-.633-.127,2.31654,2.31654,0,0,0-.666.127s-5.477,1.859-5.672,1.921c-.185.104-.523.153-.523-.324v-2.001c0-.493.029-.584.367-.852.086-.064,4.678-2.521,4.678-2.521-.524-4.298-1.307-11.846-1.325-13.304,0,0-16.822,8.744-17.148,8.863-.217.143-.69.184-.69-.467v-2.833a1.16206,1.16206,0,0,1,.473-1.152c.276-.231,17.365-15.666,17.365-15.666v-10.337c0-1.709,1.403-4.228,3.14105-4.241",transform:"translate(-28.9697,0.14347)",fill:"var(--rmg-white)"})]}),f.jsxs("g",{id:"disney",transform:"scale(0.5)",children:[f.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)"}),f.jsx("path",{fill:"var(--rmg-white)",d:"M45.6152,7.85015a9.80248,9.80248,0,0,0-9.79907,9.801,9.70059,9.70059,0,0,0,.342,2.582c.002.026.002.055.002.093a.31815.31815,0,0,1-.31494.318.67741.67741,0,0,1-.12806-.02,15.71521,15.71521,0,0,0-13.498,0,.61.61,0,0,1-.122.02.31841.31841,0,0,1-.322-.318v-.067a9.62553,9.62553,0,0,0,.35608-2.608,9.803,9.803,0,1,0-9.797,9.8,10.10364,10.10364,0,0,0,2.308-.271h.05493a.31113.31113,0,0,1,.31409.318.32433.32433,0,0,1-.019.12,15.72588,15.72588,0,1,0,29.703,7.216,15.83676,15.83676,0,0,0-1.746-7.23.18417.18417,0,0,1-.0271-.106.31612.31612,0,0,1,.32007-.318h.057a10.15953,10.15953,0,0,0,2.316.271,9.80051,9.80051,0,0,0,0-19.601",transform:"translate(-28.9697 0.13398)"})]}),f.jsxs("g",{id:"railway",children:[f.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)",transform:"translate(0,-2)scale(0.5)"}),f.jsx("path",{fill:"var(--rmg-white)",d:"M169,273.5c0-19,14.7-34.8,33.7-36.3c18.9-1.5,38.1-2.2,57.4-2.2c19.3,0,38.4,0.8,57.3,2.2  c19,1.5,33.7,17.3,33.7,36.3v47.3l-51.3,14.7c-11.2,3.2-18.9,13.4-18.9,25v147.8c0,17.4,12.2,32.3,29.3,35.7l110.6,22.1  c4.9,1,8.4,5.2,8.4,10.2V599H91v-22.7c0-5,3.5-9.2,8.4-10.2L209.9,544c17-3.4,29.3-18.3,29.3-35.7V360.5c0-11.6-7.7-21.8-18.9-25  L169,320.8V273.5z M309.4,31.7c0.2-1.2,0.3-2.4,0.3-3.6c0-14-11.1-25.4-24.9-26C276.6,1.4,268.3,1,260,1c-8.3,0-16.6,0.4-24.7,1.1  c-13.9,0.6-24.9,12-24.9,26c0,1.2,0.1,2.5,0.3,3.6C90.6,54.8,0,160.3,0,287c0,97.2,53.4,182,132.4,226.6l36.8-48.1  C104.3,432.4,59.8,364.9,59.8,287c0-110.6,89.6-200.2,200.2-200.2S460.2,176.4,460.2,287c0,77.9-44.5,145.4-109.4,178.5  c15,19.6,25.6,33.5,36.8,48.1C466.6,469,520,384.2,520,287C520,160.3,429.4,54.8,309.4,31.7z",transform:"translate(-10,0)scale(0.04)"})]}),f.jsx("marker",{id:"arrow_gray",viewBox:"-1.5 0 3 1.5",refY:.5,children:f.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-grey)"})}),f.jsx("marker",{id:"arrow_theme_left",refX:1,refY:.5,children:f.jsx("path",{d:"M1,0L0,1H1z",fill:"var(--rmg-theme-colour)"})}),f.jsx("marker",{id:"arrow_theme_right",refY:.5,children:f.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})}),f.jsx("marker",{id:"arrow_theme",refX:1,refY:.5,children:f.jsx("path",{d:"M0,1H2L1,0z",fill:"var(--rmg-theme-colour)"})}),f.jsx("filter",{id:"contrast-direct",filterUnits:"userSpaceOnUse",children:f.jsxs("feComponentTransfer",{children:[f.jsx("feFuncR",{type:"linear",slope:.5,intercept:.25}),f.jsx("feFuncG",{type:"linear",slope:.5,intercept:.25}),f.jsx("feFuncB",{type:"linear",slope:.5,intercept:.25})]})}),f.jsx("filter",{id:"contrast-express",filterUnits:"userSpaceOnUse",children:f.jsxs("feComponentTransfer",{children:[f.jsx("feFuncR",{type:"linear",slope:.75,intercept:.125}),f.jsx("feFuncG",{type:"linear",slope:.75,intercept:.125}),f.jsx("feFuncB",{type:"linear",slope:.75,intercept:.125})]})}),f.jsx(B,{})]})})),Nn=m.Indoor;function Hn(){var n=g((function(n){return n.app})).canvasScale,t=g((function(n){return n.param})),e=t.svgWidth,r=t.svg_height,i=t.theme,a=t.loop,c=e[Nn];return f.jsxs(v,{type:Nn,svgWidth:c,svgHeight:r,canvasScale:n,theme:i,children:[f.jsx(Ln,{}),a?f.jsx(Sn,{bank_angle:!1,canvas:m.Indoor}):f.jsx(Fn,{}),f.jsx(An,{})]})}var Ln=d.memo((function(){return f.jsxs("defs",{children:[f.jsx("circle",{id:"stn_indoor_sh",fill:"var(--rmg-white)",strokeWidth:5,r:8,transform:"scale(1.5)"}),f.jsx("path",{id:"int2_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V10 a 5,5 0 1 1 -10,0Z"}),f.jsx("path",{id:"express_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V25 a 5,5 0 1 1 -10,0Z"}),f.jsx("path",{id:"direct_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V40 a 5,5 0 1 1 -10,0Z"})]})})),Wn=function(n,t){var e=0;return 2===n[t].parents.length&&(e+=1),2===n[n[t].parents[0]].children.length&&(e+=1),e},Pn=function(n,t){var e=0;return 2===n[t].children.length&&(e+=1),2===n[n[t].children[0]].parents.length&&(e+=1),e},Fn=function(){var n=g((function(n){return n.helper})),t=n.routes,e=n.branches,r=n.depsStr,i=g((function(n){return n.param})),a=y(i.stn_list,Wn,Pn),s=b("linestart","lineend",a),l=b(s.nodes[1],s.nodes.slice(-2)[0],a),u=d.useMemo((function(){return console.log("computing x shares"),Object.keys(i.stn_list).reduce((function(n,t){return c(c({},n),{},o({},t,w(t,a,e)))}),{})}),[e.toString(),JSON.stringify(a)]),h=[i.svgWidth.indoor*i.padding/100,i.svgWidth.indoor*(1-i.padding/100)],m=Object.keys(u).reduce((function(n,t){return c(c({},n),{},o({},t,h[0]+u[t]/l.len*(h[1]-h[0])))}),{}),x=d.useMemo((function(){return k.getYShares(i.stn_list,e)}),[r]),j=Object.keys(x).reduce((function(n,t){return c(c({},n),{},o({},t,x[t]*i.branchSpacingPct*i.svg_height/200))}),{}),v=d.useMemo((function(){return S(i.current_stn_idx,t,i.direction)}),[i.current_stn_idx,i.direction,t.toString()]),_=Object.values(p),M=Object.values(i.stn_list).map((function(n){return n.services})).flat().reduce((function(n,t){return n[_.indexOf(t)]=!0,n}),[!1,!1,!1]).map((function(n,t){return[_[t],n]})).filter((function(n){return n[1]})).map((function(n){return n[0]})),O=k.drawLine(e,v,i.stn_list,h,m,j,i.branchSpacingPct*i.svg_height/200,s,0);return f.jsxs("g",{id:"main",transform:"translate(0,".concat(i.svg_height/2,")"),children:[f.jsx(Bn,{paths:O,services:M}),f.jsx(En,{xs:m,ys:j,services:M})]})},Bn=function(n){return f.jsx("g",{fill:"none",strokeWidth:12,stroke:"var(--rmg-theme-colour)",children:n.services.map((function(t,e){return f.jsxs("g",{transform:"translate(0, ".concat(30*e,")"),children:[n.paths.main.map((function(n,t){return f.jsx("path",{d:n},t)})),n.paths.pass.map((function(n,t){return f.jsx("path",{d:n},t)}))]},"indoor_line_".concat(e))}))})},En=function(n){var t=g((function(n){return n.helper})).branches,e=g((function(n){return n.param})),r=n.xs,i=n.ys,a=n.services;return f.jsx("g",{children:Object.keys(e.stn_list).filter((function(n){return!["linestart","lineend"].includes(n)})).filter((function(n){return 0!==e.stn_list[n].services.length})).map((function(n){return f.jsx("g",{transform:"translate(".concat(r[n],",").concat(i[n],")"),children:f.jsx(xn,{stnId:n,nameDirection:t.filter((function(t){return t.includes(n)})).map((function(t){return t.indexOf(n)%2==0||a.length>1?"downward":"upward"}))[0],services:a})},n)}))})},An=function(){var n=g((function(n){return n.param}));return d.useMemo((function(){return f.jsxs(f.Fragment,{children:[f.jsx("g",{transform:"translate(".concat(n.svgWidth.indoor/2,",50)"),children:f.jsxs("text",{textAnchor:"middle",fontSize:"30",className:"rmg-name__zh",children:["轨道交通",n.line_name[0],"运营线路示意图"]})}),f.jsxs("g",{transform:"translate(".concat(n.svgWidth.indoor/2,",").concat(n.svg_height-270,")"),children:[f.jsx("text",{textAnchor:"middle",fontSize:"18",className:"rmg-name__zh",dx:"-30",dy:"230",children:"友情提示：请留意您需要换乘线路的首末班时间，以免耽误您的出行，末班车进站前三分钟停售该末班车车票。"}),f.jsx("text",{textAnchor:"middle",fontSize:"12",className:"rmg-name__en",dx:"10",dy:"250",children:"Please pay attention to the interchange schedule if you want to transfer to other lines. Stop selling tickets 3 minutes before the last train services."}),f.jsxs("g",{transform:"translate(-600,215)",children:[f.jsx("rect",{x:"-5",y:"-25",width:"100",height:"70",fill:"none",stroke:"black",rx:"5"}),f.jsx("line",{x1:"28",x2:"28",y1:"-20",y2:"40",stroke:"black"}),f.jsx("text",{className:"rmg-name__zh",dx:"3",fontSize:"18",children:"图"}),f.jsx("text",{className:"rmg-name__zh",dx:"3",dy:"18",fontSize:"18",children:"例"}),f.jsx("text",{className:"rmg-name__en",dy:"35",fontSize:"8",children:"legend"}),f.jsx("use",{transform:"translate(45,10)",xlinkHref:"#int2_indoor_sh",stroke:"var(--rmg-black)"}),f.jsx("text",{className:"rmg-name__zh",dx:"60",dy:"10",fontSize:"10",children:"换乘站"}),f.jsx("text",{className:"rmg-name__en",dx:"60",dy:"20",fontSize:"6",children:"Interchange"}),f.jsx("text",{className:"rmg-name__en",dx:"60",dy:"30",fontSize:"6",children:"Station"})]})]})]})}),[n.svgWidth.indoor,n.svg_height,n.line_name])};n("default",{destination:f.jsx(O,{}),runin:f.jsx(A,{}),railmap:f.jsx(zn,{}),indoor:f.jsx(Hn,{})})}}}))}();
