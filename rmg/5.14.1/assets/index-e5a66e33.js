import{j as e}from"./chakra-81918c77.js";import{r as m}from"./react-50230a52.js";import{i as b,be as R,u as f,x as U,S as p,bc as z,a3 as w}from"./index-dbb5f31b.js";import{a as V,c as S,b as X,d as Y,S as C}from"./share-58e764da.js";import{i as J}from"./param-updater-utils-adb6dd56.js";function q(n){const{num:t,inStrip:a,...s}=n;return e.jsxs("g",{textAnchor:"middle",fill:a?b.black:"var(--rmg-theme-fg)",...s,children:[e.jsx("rect",{height:40,width:40,rx:4,x:-20,fill:a?"#fff":"var(--rmg-theme-colour)"}),e.jsx("text",{className:"rmg-name__en",fontSize:20,dy:12,children:t}),e.jsx("text",{className:"rmg-name__zh",fontSize:12,dy:26,children:"屏蔽门"}),e.jsx("text",{className:"rmg-name__en",fontSize:6.5,dy:36,children:"Screen Door"})]})}const P=n=>{const t=(r=>{switch(r){case"gz28":case"gz2otis":case"gz6":case"gzgf":return 60;case"gz1":case"gz3":return 40;case"gz4":case"gz5":case"gz1421":return 20;default:return 0}})(n.variant),a=m.useMemo(()=>{switch(n.variant){case"gz1":return e.jsx("circle",{cy:-58,r:16,fill:"red"});case"gz28":case"gz2otis":return e.jsx("ellipse",{cy:-30,rx:24,ry:12,fill:"orange"});case"gz3":return e.jsx("rect",{x:-15,y:-55,height:30,width:30,fill:"red"});case"gz6":return e.jsx("ellipse",{cy:-30,rx:24,ry:12,fill:"white"});case"gz1421":return e.jsx("ellipse",{cy:-38,rx:24,ry:12,fill:"orange"});case"gz5":return e.jsx("rect",{x:-30,y:-70,height:30,width:60,fill:"orange"});case"gz4":return e.jsx("rect",{x:-50,y:-50,height:25,width:100,fill:"whitesmoke"});case"gzgf":return e.jsx("rect",{x:-30,y:-58,height:30,width:60,fill:"orange"});default:return e.jsx(e.Fragment,{})}},[n.variant]),s=-20;return e.jsxs("g",{transform:"translate(0,".concat(n.variant==="gz4"?s:0,")"),children:[e.jsx("rect",{id:"strip_gz",style:{"--height":"".concat(t,"px")}}),e.jsx("g",{style:{transform:"translate(calc(var(--rmg-svg-width) / 2),var(--rmg-svg-height))"},children:n.isShowLight&&a}),n.isShowPSD!==!1&&e.jsx(K,{...n})]})},K=m.memo(function(t){const a=["gz28","gz2otis","gz6","gzgf"].includes(t.variant),s=(r=>{switch(r){case"gz1":case"gz3":return"82px";case"gz4":return"65px";case"gz5":return"80px";case"gz1421":return"62px";default:return"58px"}})(t.variant);return e.jsx(q,{num:t.isShowPSD,inStrip:a,style:{"--psd-dy":s,transform:"translate(var(--translate-x), var(--translate-y))","--translate-x":"calc(var(--rmg-svg-width) / 2 + 80px)","--translate-y":"calc(var(--rmg-svg-height) - var(--psd-dy, 58px))"}})},(n,t)=>n.variant===t.variant&&n.isShowPSD===t.isShowPSD),Q=m.memo(function(t){const{passed:a,large:s}=t,r=s?"M0,12.95 V-12.95 H-12.95 a12.95,12.95 0 0,0 0,25.9 h25.9 a12.95,12.95 0 0,0 0,-25.9 H0":"M0,9.25 V-9.25 H-9.25 a9.25,9.25 0 0,0 0,18.5 h18.5 a9.25,9.25 0 0,0 0,-18.5 H0";return e.jsx("path",{d:r,fill:"#fff",strokeWidth:2,stroke:a?"#aaa":"var(--rmg-theme-colour)"})},(n,t)=>n.passed===t.passed&&n.large===t.large),T=15;function F(n){const{lineNum:t,stnNum:a,passed:s,large:r,...c}=n,i=m.useRef(null),o=m.useRef(null),[x,l]=m.useState({width:0}),[d,g]=m.useState({width:0});m.useEffect(()=>{i.current&&l(i.current.getBBox()),o.current&&g(o.current.getBBox())},[t,a]);const h=T/Math.max(T,x.width),_=t.length===2&&a.length===2?h:T/Math.max(T,d.width);return e.jsxs("g",{...c,children:[e.jsx(Q,{passed:s,large:r}),e.jsxs("g",{textAnchor:"middle",fontSize:13.5,transform:r?"scale(1.4)":"",fill:s?"#aaa":"#000",children:[e.jsx("g",{transform:"translate(-9.25,0)scale(".concat(h,")"),children:e.jsx("text",{ref:i,className:"rmg-name__zh",children:t})}),e.jsx("g",{transform:"translate(9.25,0)scale(".concat(_,")"),children:e.jsx("text",{ref:o,className:"rmg-name__zh",children:a})})]})]})}const ee=m.memo(function(t){const{lineName:a,commonPart:s}=t,r=m.useRef(null),[c,i]=m.useState({x:0,height:0,width:0});m.useEffect(()=>{r.current&&i(r.current.getBBox())},[a.toString()]);const o=$/Math.max($,c.width),x=(-c.x-c.width/2)*o,l=c.height*(1-o)*1.2/2;return e.jsx("g",{ref:r,transform:"translate(".concat(x,",").concat(l,")scale(").concat(o,")"),children:e.jsxs("text",{className:"rmg-name__zh",fontSize:14,y:12,textAnchor:"end",children:[s,e.jsx("tspan",{className:"rmg-name__zh",fontSize:8,x:0,dy:-2,textAnchor:"start",children:a[0].slice(s.length).trim()}),e.jsx("tspan",{className:"rmg-name__en",fontSize:4,x:0,dy:6,textAnchor:"start",children:a[1].slice(s.length).trim()})]})})},(n,t)=>n.lineName.toString()===t.lineName.toString());function te(n){return e.jsx("rect",{x:-22.5,height:24,width:45,rx:4.5,...n})}const $=42,O=m.memo(function(t){const{lineName:a,foregroundColour:s,backgroundColour:r,passed:c}=t,[i,o]=ne(a),x=m.useRef(null),l=m.useRef(null),[d,g]=m.useState({width:0}),[h,_]=m.useState({width:0});m.useEffect(()=>{x.current&&g(x.current.getBBox()),l.current&&_(l.current.getBBox())},[a.toString()]);const u=$/Math.max($,d.width),B=$/Math.max($,h.width),j={nameZh:{y:7.3+13.5*(1-u)*u/2},nameEn:{y:19.5-9*(1-B)*B/2}};return e.jsxs("g",{textAnchor:"middle",fill:c?b.white:s,children:[e.jsx(te,{fill:c?"#aaa":r}),i===2?e.jsx(ee,{lineName:a,commonPart:o}):e.jsxs(e.Fragment,{children:[e.jsx("text",{ref:x,className:"rmg-name__zh",fontSize:12,transform:"translate(0,".concat(j.nameZh.y,")scale(").concat(u,")"),children:i===1?e.jsxs(e.Fragment,{children:[e.jsx("tspan",{fontSize:16,dy:.7,className:"rmg-name__zh",children:o}),e.jsx("tspan",{dy:-.7,className:"rmg-name__zh",children:a[0].slice(o.length)})]}):a[0]}),e.jsx("text",{ref:l,className:"rmg-name__en",fontSize:8,transform:"translate(0,".concat(j.nameEn.y,")scale(").concat(B,")"),children:a[1]})]})]})},(n,t)=>n.lineName.toString()===t.lineName.toString()&&n.foregroundColour===t.foregroundColour&&n.backgroundColour===t.backgroundColour&&n.passed===t.passed),ne=n=>{const t=n[0].match(/^(\d+)\D+$/);if(t)return[1,t[1]];const a=n.map(s=>s.match(/^(\w+).+$/));return a[0]&&a[1]&&a[0][1]===a[1][1]?[2,a[0][1]]:[3,""]},se=m.memo(function(t){const{stnName:a,onUpdate:s}=t,r=m.useRef(null);return m.useEffect(()=>{r.current&&s&&s(r.current.getBBox())},[a.toString()]),e.jsxs("g",{ref:r,children:[e.jsx("text",{className:"rmg-name__zh",fontSize:18,children:a[0]}),e.jsx("g",{fontSize:10.5,children:a[1].split("\\").map((c,i)=>e.jsx("text",{className:"rmg-name__en",dy:16+i*11,children:c},i))})]})},(n,t)=>n.stnName.toString()===t.stnName.toString());function re(n){const{stnName:t,onUpdate:a,passed:s,...r}=n,c=m.useRef(null),[i,o]=m.useState({x:0,width:0});return m.useEffect(()=>{if(c.current){const x=c.current.getBBox();o(x),a&&a(x)}},[t.toString()]),!t[0]&&!t[1]?e.jsx(e.Fragment,{}):e.jsxs("g",{fill:s?"#aaa":"#000",...r,children:[e.jsxs("g",{transform:"translate(0,3)",fontSize:18,children:[e.jsx("text",{textAnchor:"end",x:i.x-3,className:"rmg-name__zh",children:"("}),e.jsx("text",{textAnchor:"start",x:i.width+i.x+3,className:"rmg-name__zh",children:")"})]}),e.jsxs("g",{ref:c,textAnchor:"middle",children:[e.jsx("text",{className:"rmg-name__zh",fontSize:13,children:t[0]}),e.jsx("text",{dy:10,className:"rmg-name__en",fontSize:6.5,children:t[1]})]})]})}function ae(n){const{passed:t,...a}=n;return e.jsxs("g",{textAnchor:"middle",fill:t?"#aaa":"var(--rmg-theme-colour)",...a,children:[e.jsx("text",{className:"rmg-name__zh",fontSize:13,children:"快车停靠站"}),e.jsx("text",{dy:10,className:"rmg-name__en",fontSize:6.5,children:"Express Station"})]})}function ie(n){const{primaryName:t,secondaryName:a,stationState:s,flipped:r,express:c}=n,[i,o]=m.useState({width:0}),[x,l]=m.useState({x:0,width:-20}),d=_=>{switch(_){case R.PASSED:return"#aaa";case R.CURRENT:return"#f00";case R.FUTURE:return"#000"}},g=t[1].split("\\").length,h={g:{x:0,y:r?17.5:-20-g*14*Math.cos(-45)},StationSecondaryName:{x:(i.width+x.width/2+10)*(r?-1:1),y:2+5*(g-1)},ExpressTag:{x:(i.width+x.width+20+35)*(r?-1:1),y:2+5*(g-1)}};return e.jsxs("g",{textAnchor:r?"end":"start",fill:d(s),transform:"translate(".concat(h.g.x,",").concat(h.g.y,")rotate(-45)"),children:[e.jsx(se,{stnName:t,onUpdate:o}),a&&e.jsx(re,{stnName:a,onUpdate:l,passed:s===R.PASSED,transform:"translate(".concat(h.StationSecondaryName.x,",").concat(h.StationSecondaryName.y,")")}),c&&e.jsx(ae,{passed:s===R.PASSED,transform:"translate(".concat(h.ExpressTag.x,",").concat(h.ExpressTag.y,")")})]})}function ce(n){const{stnId:t,stnState:a,stnY:s}=n,r=f(h=>h.param.theme),c=f(h=>h.param.line_name),i=f(h=>h.param.line_num),o=f(h=>h.param.stn_list[t]),x=o.parents.length===2||o.children.length===2,l=s>0||o.parents.indexOf(o.branch.left[1]||"")===1||o.children.indexOf(o.branch.right[1]||"")===1?180:0,d=o.name[1].split("\\").length,g=x?l===180?16+(d-1)*12*Math.cos(-45):-9:l===180?-6:(25+(d-1)*15)*Math.cos(-45);return e.jsxs(e.Fragment,{children:[e.jsx(oe,{intInfos:x?[{theme:[r[0],r[1],"var(--rmg-theme-colour)","var(--rmg-theme-fg)"],name:c},...o.transfer.groups[0].lines]:o.transfer.groups[0].lines,stnState:a,tickRotation:l}),e.jsx(F,{lineNum:i,stnNum:o.num,passed:a===-1}),e.jsx("g",{transform:"translate(".concat(-g,",0)"),children:e.jsx(ie,{primaryName:o.name,secondaryName:o.secondaryName||void 0,stationState:a,flipped:l===180,express:o.services.includes(U.express)})})]})}const oe=n=>e.jsxs(e.Fragment,{children:[e.jsx(le,{strokeWidth:4,...n}),e.jsx(me,{transform:"translate(0,".concat(n.tickRotation===180?-47:23,")"),...n})]}),le=n=>{const{intInfos:t,stnState:a,tickRotation:s,...r}=n;return e.jsx("g",{...r,children:t.map((c,i)=>{var o;return e.jsx("use",{xlinkHref:"#inttick",stroke:a===-1?"#aaa":(o=c.theme)==null?void 0:o[2],transform:"translate(".concat(-2*(t.length-1)+4*i,",0)rotate(").concat(s===180?180:0,")")},i)})})},me=n=>{const{intInfos:t,tickRotation:a,stnState:s,...r}=n;return e.jsx("g",{...r,children:t.map((c,i)=>{var o,x,l,d;return e.jsx("g",{transform:"translate(0,".concat(i*28*(a===180?-1:1),")"),children:e.jsx(O,{lineName:c.name,foregroundColour:(x=(o=c.theme)==null?void 0:o[3])!=null?x:b.white,backgroundColour:(d=(l=c.theme)==null?void 0:l[2])!=null?d:"#aaaaaa",passed:s===-1})},i)})})},H=(n,t)=>n[t].parents.length===2||n[t].children.length===2?.25:0,xe=(n,t,a)=>{const s=S("linestart","lineend",t);if(s.nodes.includes(n))return S(s.nodes[1],n,t).len;{const r=a.filter(l=>l.includes(n))[0];let c=n;for(;!s.nodes.includes(c);)c=r[r.indexOf(c)-1];let i=n;for(;!s.nodes.includes(i);)i=r[r.indexOf(i)+1];const o=c==="linestart",x=i==="lineend";if(r.toString()===a[0].toString()){const l=[];return!o&&!x?(l[0]=S(s.nodes[1],c,t).len,l[1]=S(c,i,t).len,l[2]=S(c,n,t).len,l[3]=S(n,i,t).len):o?(l[0]=0,l[1]=S(s.nodes[1],i,t).len,l[2]=S(r[1],n,t).len,l[3]=S(n,i,t).len):(l[0]=S(s.nodes[1],c,t).len,l[1]=S(c,s.nodes.slice(-2)[0],t).len,l[2]=S(c,n,t).len,l[3]=S(n,r.slice(-2)[0],t).len),l[0]+l[2]*l[1]/(l[2]+l[3])}else if(!o&&!x){const l=[];return l[0]=S(s.nodes[1],c,t).len,l[1]=S(c,i,t).len,l[2]=S(c,n,t).len,l[3]=S(n,i,t).len,l[0]+l[2]*l[1]/(l[2]+l[3])}else return o?S(s.nodes[1],i,t).len-S(n,i,t).len:S(s.nodes[1],c,t).len+S(c,n,t).len}},he=()=>{const{branches:n,routes:t,depsStr:a}=f(y=>y.helper),{svgWidth:s,svg_height:r,y_pc:c,padding:i,branchSpacingPct:o,direction:x,line_name:l,current_stn_idx:d,stn_list:g}=f(y=>y.param),h=V(g,H,H),_=m.useMemo(()=>(console.log("computing x shares"),Object.keys(g).reduce((y,N)=>({...y,[N]:xe(N,h,n)}),{})),[n.toString(),JSON.stringify(h)]),u=S("linestart","lineend",h),B=S(u.nodes[1],u.nodes.slice(-2)[0],h),j=x===p.right?[s[z.RailMap]*i/100+65,s[z.RailMap]*(1-i/100)-20]:[s[z.RailMap]*i/100,s[z.RailMap]*(1-i/100)-65],v=Object.keys(_).reduce((y,N)=>({...y,[N]:j[0]+_[N]/B.len*(j[1]-j[0])}),{}),I=m.useMemo(()=>(console.log("computing y shares"),Object.keys(g).reduce((y,N)=>{if(n[0].includes(N))return{...y,[N]:0};{const E=n.slice(1).filter(Z=>Z.includes(N))[0];return{...y,[N]:g[E[0]].children.indexOf(E[1])?-2:2}}},{})),[a]),D=Object.keys(I).reduce((y,N)=>({...y,[N]:-I[N]*o*r/200}),{}),W=m.useMemo(()=>X(d,t,x),[d,x,t.toString()]),L=n.map(y=>Y(y,W)).reduce((y,N)=>(y.main.push(N.main),y.pass.push(N.pass),y),{main:[],pass:[]}),G=Object.keys(L).reduce((y,N)=>({...y,[N]:L[N].map(E=>ge(E,v,D))}),{});return e.jsxs("g",{id:"main",style:{"--y-percentage":c,transform:"translateY(calc(var(--y-percentage) * var(--rmg-svg-height) / 100))"},children:[e.jsx(de,{paths:G}),e.jsx(ue,{xs:v,ys:D,stnStates:W}),e.jsx("g",{id:"line_name",style:{"--translate-x":x===p.right?"".concat(j[0]-65,"px"):"".concat(j[1]+65,"px")},children:e.jsx(O,{lineName:l,foregroundColour:"var(--rmg-theme-fg)",backgroundColour:"var(--rmg-theme-colour)"})})]})},de=m.memo(function(t){return e.jsxs("g",{fill:"none",strokeWidth:4,children:[e.jsx("g",{stroke:"#aaa",strokeDasharray:4,children:t.paths.pass.map((a,s)=>e.jsx("path",{d:a},s))}),e.jsx("g",{stroke:"var(--rmg-theme-colour)",children:t.paths.main.map((a,s)=>e.jsx("path",{d:a},s))})]})},(n,t)=>JSON.stringify(n.paths)===JSON.stringify(t.paths)),ge=(n,t,a)=>{let s;const r=[];return n.forEach(c=>{const i=t[c],o=a[c];if(!s&&s!==0){s=o,r.push("M ".concat(i,",").concat(o));return}o===0?(o<s&&r.push("H ".concat(i-40),"a 40,40 0 0,0 40,-40","V ".concat(o)),o>s&&r.push("H ".concat(i-40),"a 40,40 0 0,1 40,40","V ".concat(o))):(o<s&&r.push("V ".concat(o+40),"a 40,40 0 0,1 40,-40","H ".concat(i)),o>s&&r.push("V ".concat(o-40),"a 40,40 0 0,0 40,40","H ".concat(i))),r.push("H ".concat(i)),s=o}),r.join(" ").replace(/( H ([\d.]+))+/g," H $2")},ue=n=>{const{xs:t,ys:a,stnStates:s}=n,r=f(c=>c.param.stn_list);return e.jsx("g",{id:"stn_icons",children:Object.keys(r).filter(c=>!["linestart","lineend"].includes(c)).map(c=>e.jsx("g",{style:{transform:"translate(".concat(t[c],"px,").concat(a[c],"px)")},children:e.jsx(ce,{stnId:c,stnState:s[c],stnY:a[c]})},c))})};function A(n){return e.jsx("path",{d:"M60,60 L0,0 L60,-60 H90 L40,-10 H150 V10 H40 L90,60z",fill:"black",...n})}function fe(n){const{destIds:t,textAnchor:a,...s}=n,r=f(l=>l.param.direction),c=f(l=>l.param.stn_list),i=t.map(l=>c[l].name[0].length),o=Math.min(...i),x=o>1&&i[0]!==i[1]?Math.abs(i[0]-i[1])/(o-1):0;return e.jsxs("g",{textAnchor:a,...s,children:[t.map((l,d)=>{const g=i[d]>i[1-d],h=!J()&&a==="end"&&!g;return e.jsxs(m.Fragment,{children:[e.jsx("text",{className:"rmg-name__zh",fontSize:25,x:r===p.left?0:-75,y:-21+42*d,letterSpacing:g?"0em":"".concat(x,"em"),dx:h?"".concat(x,"em"):"0em",children:c[l].name[0]}),e.jsx("text",{className:"rmg-name__en",fontSize:11.5,x:r===p.left?0:-75,y:-1+42*d,children:"Towards "+c[l].name[1].replace("\\"," ")})]},l)}),e.jsx("text",{className:"rmg-name__zh",fontSize:28,x:r===p.left?25*(Math.max(...i)+1):0,y:5,children:"方向"})]})}const M=z.RailMap,pe=()=>{const{canvasScale:n}=f(h=>h.app),{svgWidth:t,svg_height:a,direction:s,psd_num:r,info_panel_type:c,notesGZMTR:i,current_stn_idx:o,stn_list:x,theme:l}=f(h=>h.param),d=t[M],g=x[o];return e.jsxs(C,{type:M,svgWidth:d,svgHeight:a,canvasScale:n,theme:l,children:[e.jsx(je,{}),e.jsx(P,{variant:c,isShowLight:c===w.gz2otis,isShowPSD:c===w.gz2otis&&r}),s===p.left&&g.parents.includes("linestart")||s===p.right&&g.children.includes("lineend")?e.jsx(ye,{}):e.jsxs(e.Fragment,{children:[e.jsx(he,{}),e.jsx(Se,{}),i.map((h,_)=>e.jsx(Ne,{note:h},_))]}),c===w.gz2otis&&e.jsx("line",{x2:d,transform:"translate(0,90)",strokeWidth:3,stroke:"black"})]})},je=m.memo(function(){return e.jsx("defs",{children:e.jsx("path",{id:"inttick",d:"M 0,0 v 18",strokeLinecap:"square"})})}),Se=()=>{const{routes:n}=f(o=>o.helper),{direction:t,direction_gz_x:a,direction_gz_y:s,current_stn_idx:r}=f(o=>o.param),c=m.useMemo(()=>[...new Set(n.reduce((o,x)=>x.includes(r)?o.concat(x.filter(l=>!["linestart","lineend"].includes(l)).slice(t===p.left?0:-1)[0]):o,[]).filter(o=>o!==r))],[r,t,n.toString()]),i={textAnchor:t===p.left?"start":"end",transform:"translate(".concat(t===p.left?65:-65,",-5)"),destIds:c};return e.jsxs("g",{id:"direction_gz",style:{"--x-percentage":a,"--y-percentage":s},children:[e.jsx(A,{transform:"scale(0.35)rotate(".concat(t===p.left?0:180,")")}),c.length!==2?e.jsx(_e,{...i}):e.jsx(fe,{...i})]})},_e=n=>{const{destIds:t,...a}=n,s=f(r=>r.param.stn_list);return e.jsxs("g",{...a,children:[e.jsx("text",{className:"rmg-name__zh",fontSize:28,children:t.map(r=>s[r].name[0]).join("/")+"方向"}),e.jsx("text",{className:"rmg-name__en",fontSize:14,dy:22,children:"Towards "+t.map(r=>s[r].name[1].replace("\\"," ")).join("/")})]})},ye=m.memo(function(){return e.jsxs("g",{id:"terminus_gz",textAnchor:"middle",children:[e.jsx("text",{className:"rmg-name__zh",fontSize:90,children:"终 点 站"}),e.jsx("text",{dy:70,className:"rmg-name__en",fontSize:36,children:"Terminal"}),e.jsxs("g",{strokeWidth:8,stroke:"#000",children:[e.jsx("path",{d:"M -160,68 h -160"}),e.jsx("path",{d:"M 160,68 h 160"})]})]})}),Ne=m.memo(function(t){const a=m.useRef(null),[s,r]=m.useState({width:0,height:0,y:0});return m.useEffect(()=>{a.current&&r(a.current.getBBox())},[t.note[0],t.note[1]]),e.jsxs("g",{className:"note-box",style:{"--x-percentage":t.note[2],"--y-percentage":t.note[3]},children:[t.note[4]&&e.jsx("rect",{height:s.height+4,width:s.width+4,x:-2,y:s.y-2,fill:"none",stroke:"black",strokeWidth:.5}),e.jsxs("g",{ref:a,children:[e.jsx("g",{fontSize:16,letterSpacing:1.2,children:t.note[0].split("\n").map((c,i)=>e.jsx("text",{className:"rmg-name__zh",y:i*18,children:c},i))}),e.jsx("g",{fontSize:10,letterSpacing:.33,transform:"translate(0,".concat(18*t.note[0].split("\n").length,")"),children:t.note[1].split("\n").map((c,i)=>{var o;return e.jsx("text",{className:"rmg-name__en",y:i*11,textLength:i<(((o=t.note[1].match(/\n/g))==null?void 0:o.length)||0)?s.width:navigator.userAgent.includes("Firefox")?-1:0,lengthAdjust:"spacing",children:c},i)})})]})]})},(n,t)=>n.note.toString()===t.note.toString()),ze=m.memo(function(t){const{stnName:a,onUpdate:s}=t,r=m.useRef(null);return m.useEffect(()=>{r.current&&s&&s(r.current.getBBox())},[a.toString()]),e.jsxs("g",{ref:r,children:[e.jsx("text",{className:"rmg-name__zh",fontSize:90,children:a[0]}),e.jsx("g",{fontSize:36,children:a[1].split("\\").map((c,i)=>e.jsx("text",{className:"rmg-name__en",dy:70+i*36,children:c},i))})]})},(n,t)=>n.stnName.toString()===t.stnName.toString()),Be=n=>{const{secondaryName:t,transform:a}=n,s=m.useRef(null),[r,c]=m.useState({x:0,width:0});return m.useEffect(()=>{s.current&&c(s.current.getBBox())},[t.toString()]),e.jsxs("g",{transform:a,children:[e.jsxs("g",{transform:"translate(0,4.5)",fontSize:36,children:[e.jsx("text",{textAnchor:"end",x:r.x-3,className:"rmg-name__zh",children:"("}),e.jsx("text",{textAnchor:"start",x:r.width+r.x+3,className:"rmg-name__zh",children:")"})]}),e.jsxs("g",{ref:s,textAnchor:"middle",children:[e.jsx("text",{className:"rmg-name__zh",fontSize:26,children:t[0]}),e.jsx("text",{dy:22,className:"rmg-name__en",fontSize:14,children:t[1]})]})]})},we=()=>{const n=f(h=>h.param.svg_height),t=f(h=>h.param.svgWidth),a=f(h=>h.param.direction),s=f(h=>h.param.info_panel_type),r=f(h=>h.param.line_num),c=f(h=>h.param.current_stn_idx),i=f(h=>h.param.stn_list[c]),[o,x]=m.useState({width:0}),l=i[a===p.left?"parents":"children"],d={name:"translate(".concat((a===p.left?1:-1)*t[z.RunIn]/4,",45)"),next:"translate(".concat((a===p.left?1:-1)*t[z.RunIn]/10,",45)")},g={nameGroup:{x:t.runin/2,y:.5*n-50-(i.name[1].split("\\").length-1)*18-(i.secondaryName?29:0)},secondaryName:{x:0,y:70+i.name[1].split("\\").length*36}};return e.jsxs("g",{children:[e.jsxs("g",{transform:s===w.gz2otis?d.name:"",children:[e.jsxs("g",{textAnchor:"middle",transform:"translate(".concat(g.nameGroup.x,",").concat(g.nameGroup.y,")"),children:[e.jsx(ze,{stnName:i.name,onUpdate:x}),i.secondaryName&&e.jsx(Be,{secondaryName:i.secondaryName,transform:"translate(".concat(g.secondaryName.x,",").concat(g.secondaryName.y,")")})]}),e.jsx(F,{lineNum:r,stnNum:i.num,style:{"--translate-x":"".concat((t[z.RunIn]+o.width)/2+55,"px"),"--translate-y":"".concat(.5*n-30-(i.name[1].split("\\").length-1)*18-(i.secondaryName?58/2:0),"px"),transform:"translate(var(--translate-x, 800px), var(--translate-y, 145px))"},large:!0})]}),e.jsx("g",{transform:s===w.gz2otis?d.next:"",children:!l||l.includes("linestart")||l.includes("lineend")?e.jsx(e.Fragment,{}):l.length===1?e.jsx(ve,{nextId:l[0],nameBBox:o}):e.jsx(Re,{nextIds:l,nameBBox:o})})]})},ve=n=>{const{nextId:t,nameBBox:a}=n,s=f(_=>_.param.svgWidth),r=f(_=>_.param.direction),c=f(_=>_.param.stn_list[t]),{name:i,secondaryName:o}=c,[x,l]=m.useState({width:0}),d=m.useRef(null);m.useEffect(()=>{d.current&&l(d.current.getBBox())},[i.toString()]);const g=i[0].length,h=(s[z.RunIn]-a.width)/2;return e.jsxs(e.Fragment,{children:[e.jsxs("g",{id:"big_next",children:[e.jsxs("g",{textAnchor:"middle",style:{"--translate-x":r===p.left?"80px":g<=2?"".concat(s[z.RunIn]-45-x.width-70,"px"):"".concat(s[z.RunIn]-45-x.width-35*1.5,"px")},children:[e.jsx("text",{className:"rmg-name__zh",fontSize:35,children:"下站"}),e.jsx("text",{className:"rmg-name__en",fontSize:17,dy:30,children:"Next"})]}),e.jsxs("g",{textAnchor:"start",ref:d,style:{"--translate-x":r===p.left?g<=2?"".concat(115+35,"px"):"".concat(115+35/2,"px"):"".concat(s[z.RunIn]-45-x.width,"px")},children:[e.jsx("text",{className:"rmg-name__zh",fontSize:35,children:i[0]}),e.jsx("g",{fontSize:17,children:i[1].split("\\").map((_,u)=>e.jsx("text",{className:"rmg-name__en",dy:30+u*17,children:_},u))})]}),o&&e.jsx("g",{textAnchor:"middle",style:{"--translate-x":r===p.left?g<=2?"".concat(115+35,"px"):"".concat(115+35/2,"px"):"".concat(s[z.RunIn]-45-x.width,"px")},children:e.jsx($e,{secName:o,transform:"translate(".concat(x.width/2,",").concat(30+i[1].split("\\").length*17+5,")")})})]}),e.jsx(A,{id:"arrow",style:{"--translate-x":r===p.left?"".concat((115+35*((g<=2?1:.5)+g)+h)/2-20,"px"):"".concat((s[z.RunIn]-45-x.width-(g<=2?70+35:35*2.5)+h+n.nameBBox.width+55+18.5*1.4)/2+20,"px"),"--rotate":r===p.left?"0deg":"180deg"}})]})},$e=n=>{const{secName:t,...a}=n,s=m.useRef(null),[r,c]=m.useState({x:0,width:0});return m.useEffect(()=>{s.current&&c(s.current.getBBox())},[n.secName.toString()]),e.jsxs("g",{...a,children:[e.jsxs("g",{transform:"translate(0,2.5)",fontSize:25,children:[e.jsx("text",{textAnchor:"end",x:r.x-3,className:"rmg-name__zh",children:"("}),e.jsx("text",{textAnchor:"start",x:r.width+r.x+3,className:"rmg-name__zh",children:")"})]}),e.jsxs("g",{ref:s,children:[e.jsx("text",{className:"rmg-name__zh",fontSize:18,children:t[0]}),e.jsx("text",{className:"rmg-name__en",fontSize:10,dy:15,children:t[1]})]})]})},Re=n=>{const{nextIds:t,nameBBox:a}=n,{routes:s}=f(u=>u.helper),r=f(u=>u.param.svgWidth),c=f(u=>u.param.direction),i=f(u=>u.param.stn_list),o=t.map(u=>i[u].name),[x,l]=m.useState({width:0}),d=m.useRef([]);m.useEffect(()=>{l(u=>({...u,width:0})),d.current.forEach(u=>{const B=u==null?void 0:u.getBBox();l(j=>B?j.width>B.width?j:B:j)})},[o.toString()]);const g=n.nextIds.map(u=>s.reduce((B,j)=>j.includes(u)?B.concat(j.filter(v=>!["linestart","lineend"].includes(v)).slice(c===p.left?0:-1)[0]):B,[])),h=Math.max(...o.map(u=>u[0].length)),_=(r[z.RunIn]-a.width)/2;return e.jsxs(e.Fragment,{children:[e.jsx("g",{id:"big_next_2",children:o.map((u,B)=>e.jsxs(m.Fragment,{children:[e.jsxs("g",{textAnchor:"middle",style:{"--translate-x":c===p.left?"72px":"".concat(r[z.RunIn]-45-x.width-41,"px")},children:[e.jsx("text",{className:"rmg-name__zh",children:"下站"}),e.jsx("text",{className:"rmg-name__en",y:22,children:"Next"})]}),e.jsxs("g",{ref:j=>d.current[B]=j,textAnchor:"start",style:{"--translate-x":c===p.left?"113px":"".concat(r[z.RunIn]-45-x.width,"px")},children:[e.jsx("text",{className:"rmg-name__zh",children:u[0]}),u[1].split("\\").map((j,v)=>e.jsx("text",{className:"rmg-name__en",y:22+v*13,children:j},v)),e.jsx("text",{className:"rmg-name__zh",y:-35,children:g[B].map(j=>i[j].name[0]).join("/")+"方向"}),e.jsx("text",{className:"rmg-name__en rmg-name__gzmtr--next2-dest",y:-20,children:"Towards "+g[B].map(j=>i[j].name[1]).join("/").replace("\\"," ")})]})]},B))}),e.jsx(A,{id:"arrow",style:{"--translate-x":c===p.left?"".concat((99+27*(1+h)+_)/2-20,"px"):"".concat((r[z.RunIn]-45-x.width-41-27+_+n.nameBBox.width+55+18.5*1.4)/2+20,"px"),"--rotate":c===p.left?"0deg":"180deg"}})]})};function Ee(n){const{num:t,...a}=n;return e.jsxs("g",{textAnchor:"middle",fill:"var(--rmg-theme-fg)",...a,children:[e.jsx("circle",{cx:0,cy:0,r:30,fill:"var(--rmg-theme-colour)"}),e.jsx("text",{className:"rmg-name__en",fontSize:38,dy:-9.5,children:t}),e.jsx("text",{className:"rmg-name__zh",fontSize:13,dy:10,children:"站台"}),e.jsx("text",{className:"rmg-name__en",fontSize:9,dy:21,children:"Platform"})]})}function Te(n){const{canvasType:t}=n,{svgWidth:a,svg_height:s}=f(r=>r.param);return e.jsxs("g",{id:"otis_frame",strokeWidth:3,stroke:"black",children:[e.jsx("line",{y2:s,transform:"translate(".concat(a[t]/2,",0)")}),e.jsx("line",{x2:a[t],transform:"translate(0,90)"})]})}const k=z.RunIn;function ke(){const{canvasScale:n}=f(d=>d.app),{svgWidth:t,svg_height:a,direction:s,info_panel_type:r,platform_num:c,psd_num:i,theme:o}=f(d=>d.param),x=t[k],l={platform:"translate(".concat(s===p.left?50:-50,",45)")};return e.jsxs(C,{type:k,svgWidth:x,svgHeight:a,canvasScale:n,theme:o,children:[e.jsx(P,{variant:r,isShowLight:r!==w.gz2otis,isShowPSD:r!==w.gz2otis&&i}),e.jsx("g",{transform:r===w.gz2otis?l.platform:"",children:e.jsx(Ee,{num:c,style:{"--translate-x":"".concat(s===p.left?x-100:100,"px"),"--translate-y":"calc(var(--rmg-svg-height) / 2 - 30px)",transform:"translate(var(--translate-x, 100px), var(--translate-y))"}})}),e.jsx(we,{}),r===w.gz2otis&&e.jsx(Te,{canvasType:k})]})}const Le={runin:e.jsx(ke,{}),railmap:e.jsx(pe,{})};export{Le as default};
