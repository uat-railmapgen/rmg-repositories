import{m as w,j as e,b2 as Z}from"./vendor-f157c26c.js";import{ar as L,u as M,j as C}from"./index-cb58e020.js";import{i as Y}from"./app-router-47f896c0.js";import{S as V,d as ce,a as he,c as R,g as de,b as me}from"./share-fcdd048a.js";import{a as te}from"./mtr-85e29938.js";import"./param-updater-utils-9340be9d.js";const je=(r,s,t,n)=>{const a=r.length-n*2-t,l=r.findIndex(m=>m===s),i=[...r,...r,...r],o=r.length+l-Math.floor(a/2)+(a%2===0?1:0),c=r.length+l+Math.floor(a/2);return{top:i.slice(o,c+1),left:i.slice(o-n,o),right:i.slice(c+1,c+1+n),bottom:i.slice(c+1+n,c+1+n+t)}},xe=(r,s,t,n)=>{const a=r.length-n*2-t,l=[...r,...r,...r],i=r.length+r.findIndex(m=>m===s),o=l[i+a-1],c=r.length+r.findIndex(m=>m===o)+(i+a>r.length*2?r.length:0);return{top:l.slice(i,c+1),left:l.slice(i-n,i),right:l.slice(c+1,c+1+n),bottom:l.slice(c+1+n,c+1+n+t)}},_e=(r,s,t,n)=>{let a=r.findIndex(f=>f===s[0]),l=r.findIndex(f=>f===s[1]);[a,l,s[0],s[1]]=a>l?[l,a,s[1],s[0]]:[a,l,s[0],s[1]];const i=r.slice(a,l+1),o=r.filter(f=>!i.filter(x=>!s.includes(x)).includes(f)),c=r.length-(n==="major"?Math.max:Math.min)(i.length,o.length)-t*2,m=n==="major"?i.length>o.length?s[0]:s[1]:i.length>o.length?s[1]:s[0];return xe(r,m,c,t)},$e=(r,s)=>{const t=Object.fromEntries(r.map(m=>[m,-1])),n=Object.fromEntries(r.map(m=>[m,-1])),[a,l,i,o]=[0,1,0,1],c=0;return s.top.forEach((m,f)=>{t[m]=c/2+(1-c)/(s.top.length+1)*(f+1),n[m]=a}),s.right.forEach((m,f)=>{t[m]=o,n[m]=c/2+(1-c)/(s.right.length+1)*(f+1)}),s.bottom.forEach((m,f)=>{t[m]=1-c/2-(1-c)/(s.bottom.length+1)*(f+1),n[m]=l}),s.left.forEach((m,f)=>{t[m]=i,n[m]=1-c/2-(1-c)/(s.left.length+1)*(f+1)}),{x_shares:t,y_shares:n}},ve=(r,s,t,n)=>{const a=r[0].filter(c=>!["linestart","lineend"].includes(c)),l=[...a,...a,...a],i=s==="r"?l:l.reverse(),o=i.findIndex(c=>n===c)+a.length;return i.slice(o+1).filter(c=>t[c].loop_pivot).slice(void 0,2)},ne=L.Destination;function ye(){const{canvasScale:r}=M(l=>l.app),{svgWidth:s,svg_height:t,theme:n}=M(l=>l.param),a=s[ne];return e.jsxs(V,{type:ne,svgWidth:a,svgHeight:t,canvasScale:r,theme:n,children:[e.jsx(Se,{}),e.jsx(ke,{})]})}const Se=w.memo(function(){return e.jsx("defs",{children:e.jsx("marker",{id:"slope",viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})})})}),ke=()=>{const{routes:r,branches:s}=M(v=>v.helper),{line_name:t,theme:n,current_stn_idx:a,direction:l,stn_list:i,info_panel_type:o,loop:c,coline:m}=M(v=>v.param),f=(v,$,k)=>[...new Set(v.filter(y=>y.includes(k)).map(y=>$==="l"?y.at(1):y.at(y.length-2)))],x=(v,$)=>$?[[v.map(k=>i[k].name[0]).join("，"),v.map(k=>i[k].name[1]).join(", ")].map(k=>k.replace("\\",""))]:v.map(k=>i[k].name.map(y=>y.replace("\\",""))),j=c?ve(s,l,i,a):f(r,l,a),u=(c?f(r,l,a):j).filter(v=>s.slice(1).filter($=>Y($,i)).some($=>$.includes(v))),g=j.filter(v=>!u.includes(v)),h=x(g,!c&&o!=="sh2020"),d=x(u,!0),p=u.length!==0&&g.length===0,_=250,S=Object.fromEntries(u.map(v=>[v,Object.values(m).filter($=>$.from===v||$.to===v).at(0)]).filter(([,v])=>v));return e.jsxs(e.Fragment,{children:[!p&&e.jsx(se,{dest_names:h,line_name:t,line_color:[n[2],n[3]],coline:!!u.length,upper:!!u.length}),u.length&&u.map(v=>{var $,k,y;return e.jsx("g",{transform:`translate(0,${-_})`,children:e.jsx(se,{dest_names:[d.at(0)],line_name:($=S[v])==null?void 0:$.colors.at(0).slice(4),line_color:[(k=S[v])==null?void 0:k.colors.at(0)[2],(y=S[v])==null?void 0:y.colors.at(0)[3]],coline:!0,upper:!1})},`coline_${v}`)})]})},se=r=>{const{dest_names:s,line_name:t,line_color:n,coline:a,upper:l}=r,{current_stn_idx:i,direction:o,platform_num:c,svgWidth:m,svg_height:f}=M(v=>v.param),x=w.useRef(null),[j,u]=w.useState({width:0});w.useEffect(()=>{x.current&&u(x.current.getBBox())},[JSON.stringify(s),JSON.stringify(i)]);const[g,h,d,p,_]=[m.destination/2,10,36,264,325],S=g-h-d-j.width>=_/2&&g-h-d-p>=_/2?g:o==="l"?(m.destination+j.width-p)/2:(m.destination-j.width+p)/2;return e.jsxs("g",{transform:`translate(0,${f-300})`,children:[e.jsx("path",{stroke:n[0],strokeWidth:12,d:o==="l"?`M${m.destination-24},16 H 36`:`M24,16 H ${m.destination-36}`,transform:`translate(0,${l?-20:220})`,markerEnd:a?void 0:"url(#slope)"}),e.jsx(we,{ref:x,dest_names:s}),c!==""&&e.jsx("g",{transform:`translate(${S},0)`,children:e.jsx(Me,{})}),t[0].match(/^[\w\d]+(号)?线/)?e.jsx(Ne,{line_name:t,line_color:n}):e.jsx(be,{line_name:t,line_color:n})]})},we=w.forwardRef(function(s,t){const{dest_names:n}=s,{direction:a,svgWidth:l}=M(i=>i.param);return e.jsxs("g",{ref:t,transform:`translate(${a==="l"?36:l.destination-36},145)`,children:[e.jsx("g",{transform:`translate(0,${n.length===2?-20:20})`,children:e.jsx("path",{d:"M60,60L0,0L60-60H100L55-15H160V15H55L100,60z",fill:"black",transform:`rotate(${a==="l"?0:180})scale(0.8)`})}),e.jsx("g",{textAnchor:a==="l"?"start":"end",transform:`translate(${a==="l"?128+20:-128-20},25)`,children:n.map((i,o)=>e.jsxs(w.Fragment,{children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:70,dy:o*-100+7,children:"往"+i[0]},`zh${o}`),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:25,dy:o*-100+40,children:"To "+i[1]},`en${o}`)]},o))})]})}),Me=()=>{const{platform_num:r}=M(s=>s.param);return w.useMemo(()=>e.jsxs("g",{transform:`translate(${-325/2+60},150)`,children:[e.jsx("circle",{r:60,fill:"none",stroke:"black",strokeWidth:2}),e.jsx("text",{className:"rmg-name__en rmg-outline",dominantBaseline:"central",fontSize:120,textAnchor:"middle",children:r}),e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:100,dominantBaseline:"central",x:65,children:"站台"})]}),[r])},be=r=>{const{line_name:s,line_color:t}=r,{direction:n,svgWidth:a}=M(x=>x.param),l=n==="l"?a.destination-42:42,i=w.useRef(null),[o,c]=w.useState({width:0});w.useEffect(()=>{i.current&&c(i.current.getBBox())},[...s]);const m=(n==="l"?-o.width:0)-6,f=(n==="l"?-1:1)*o.width/2;return w.useMemo(()=>e.jsxs("g",{transform:`translate(${l},92)`,children:[e.jsx("rect",{fill:t[0],x:m,width:o.width+10,height:120}),e.jsxs("g",{textAnchor:n==="r"?"start":"end",transform:"translate(0,68)",fill:t[1],children:[e.jsx("g",{ref:i,children:e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:68,children:s[0]})}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:30,textAnchor:"middle",x:f,dy:42,children:s[1]})]})]}),[o,...s,...t,n,a.destination])},Ne=r=>{const{line_name:s,line_color:t}=r,{direction:n,svgWidth:a}=M(c=>c.param),[l,i]=s[0].match(/^[\w\d]+|.+/g),o=n==="l"?a.destination-36-210:36+54;return w.useMemo(()=>e.jsxs("g",{transform:`translate(${o},92)`,children:[e.jsx("rect",{fill:t[0],x:-54,width:108,height:120}),e.jsx("text",{className:"rmg-name__zh rmg-outline",fill:t[1],fontSize:96,textAnchor:"middle",dominantBaseline:"central",transform:"translate(0,60)",letterSpacing:-5,children:l}),e.jsxs("g",{textAnchor:"start",transform:"translate(74,68)",children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:68,children:i}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:30,dy:42,children:s[1]})]})]}),[o,...s,...t,n,a.destination])},D=(r,s)=>r.map(t=>{const n=s.filter(c=>c.includes(t.from)&&c.includes(t.to));if(n.length!==1)return{linePath:[],colors:t.colors};const a=n.flat(),l=a.indexOf(t.from),i=a.indexOf(t.to);return{linePath:l<i?a.slice(l,i+1):a.slice(i,l+1),colors:t.colors}}).filter(t=>t.linePath.length!==0),Oe=(r,s)=>r.map(t=>{const n=ce(t.linePath,s);return{main:[{linePath:n.main,colors:t.colors}],pass:[{linePath:n.pass,colors:t.colors}]}}).reduce((t,n)=>(t.main=[...t.main,...n.main],t.pass=[...t.pass,...n.pass],t),{main:[],pass:[]}),U=()=>Z.useMemo(()=>e.jsxs("filter",{id:"pujiang_outline",colorInterpolationFilters:"sRGB",filterUnits:"userSpaceOnUse",x:"0",y:"-1000",width:"5000",height:"2000",children:[e.jsxs("feComponentTransfer",{in:"SourceGraphic",children:[e.jsx("feFuncR",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"}),e.jsx("feFuncG",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"}),e.jsx("feFuncB",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"})]}),e.jsx("feColorMatrix",{type:"matrix",values:`1 0 0 0 0
                            0 1 0 0 0
                            0 0 1 0 0
                            1 1 1 1 -3`,result:"selectedColor"}),e.jsx("feMorphology",{operator:"erode",in:"selectedColor",radius:"0",result:"e1"}),e.jsx("feMorphology",{operator:"erode",in:"selectedColor",radius:"1",result:"e2"}),e.jsx("feComposite",{in:"e1",in2:"e2",operator:"xor",result:"uncoloredOutline"}),e.jsx("feFlood",{floodColor:"rgb(0,0,0)"}),e.jsx("feComposite",{operator:"in",in2:"uncoloredOutline",result:"outline"}),e.jsx("feComposite",{in:"outline",in2:"selectedColor",operator:"over",result:"result"}),e.jsx("feComposite",{in:"result",in2:"SourceGraphic",operator:"over"})]}),[]);U.displayName="PujiangLineDefs";const F=12,re=L.RunIn,He=()=>{const{canvasScale:r}=M(g=>g.app),{branches:s,routes:t,depsStr:n}=M(g=>g.helper),{svgWidth:a,svg_height:l,current_stn_idx:i,direction:o,loop:c,theme:m}=M(g=>g.param),f=a[re],x=l-300,j=w.useMemo(()=>{let g=t.filter(h=>h.includes(i)).map(h=>h[h.indexOf(i)+(o==="l"?1:-1)]).reduce((h,d)=>h.includes(d)?h:h.concat(d),[]);return c&&s[0].includes(i)&&g.length===1&&["linestart","lineend"].includes(g[0])&&(g=o==="l"?[s[0][1]]:[s[0][s[0].length-2]]),g},[n,i,o,c]),u=w.useMemo(()=>{let g=t.filter(h=>h.includes(i)).map(h=>h[h.indexOf(i)+(o==="l"?-1:1)]).reduce((h,d)=>h.includes(d)?h:h.concat(d),[]);return c&&s[0].includes(i)&&g.length===1&&["linestart","lineend"].includes(g[0])&&(g=o==="l"?[s[0][s[0].length-2]]:[s[0][1]]),g},[n,i,o,c]);return e.jsxs(V,{type:re,svgWidth:f,svgHeight:l,canvasScale:r,theme:m,children:[e.jsx(Ie,{}),e.jsx("g",{transform:`translate(0,${x})`,children:e.jsx(Le,{prevStnIds:j,nextStnIds:u})})]})},Ie=w.memo(function(){return e.jsxs("defs",{children:[e.jsx("marker",{id:"slope",viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})}),e.jsx(U,{})]})}),Le=r=>{const{prevStnIds:s,nextStnIds:t}=r,{info_panel_type:n,svgWidth:a,stn_list:l}=M(u=>u.param),i=a.runin/2,o=t.length===1&&["linestart","lineend"].includes(t[0]),c=s.length===1&&["linestart","lineend"].includes(s[0]),m=t.map(u=>l[u].name),f=s.map(u=>l[u].name),x=(t.length>1?(m[0][0].split("\\").length-1)*-50+(m[0][1].split("\\").length-1)*-30:0)+10,j=(s.length>1?(f[0][0].split("\\").length-1)*-50+(f[0][1].split("\\").length-1)*-30:0)+10;return e.jsxs(e.Fragment,{children:[e.jsx(Be,{prevStnIds:s,nextStnIds:t,nextBranchLineDy:x,prevBranchLineDy:j}),o&&n!=="sh2020"?e.jsx(le,{mode:"terminal",prevStnIds:s,nextStnIds:t}):c&&n!=="sh2020"?e.jsx(le,{mode:"original",prevStnIds:s,nextStnIds:t}):e.jsxs(e.Fragment,{children:[e.jsx(ze,{prevStnIds:s,nextStnIds:t}),e.jsx("g",{transform:`translate(${i},160)`,textAnchor:"middle",children:e.jsx(ge,{})})]}),(c||!o)&&e.jsx(Ee,{stnIds:r.nextStnIds}),(o||!c)&&e.jsx(We,{stnIds:r.prevStnIds})]})},le=r=>{var g;const{mode:s,prevStnIds:t,nextStnIds:n}=r,{current_stn_idx:a,theme:l,svgWidth:i,direction:o,coline:c}=M(h=>h.param),{branches:m}=M(h=>h.helper),f={l:{original:{x:i.runin-36,anchor:"end"},terminal:{x:36,anchor:"start"}},r:{original:{x:36,anchor:"start"},terminal:{x:i.runin-36,anchor:"end"}}},x=D(Object.values(c),m),j=s==="terminal"?t:n,u=n.length>1?"var(--rmg-theme-colour)":(g=x.filter(h=>h.linePath.includes(a)&&h.linePath.includes(j[0])).map(h=>h.colors[0][2])[0])!=null?g:"var(--rmg-theme-colour)";return e.jsxs(e.Fragment,{children:[s==="original"&&e.jsxs(e.Fragment,{children:[u!=="var(--rmg-theme-colour)"&&e.jsx("marker",{id:`slope_${u}`,viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:u})}),e.jsx("path",{transform:`translate(0,${Object.keys(c).length?198:220})${Object.keys(c).length?"scale(1,2)":""}`,stroke:u,strokeWidth:12,d:o==="l"?`M ${i.runin-24},16 H 36`:`M24,16 H ${i.runin-36}`,markerEnd:u==="var(--rmg-theme-colour)"?"url(#slope)":`url(#slope_${u})`})]}),s==="terminal"&&e.jsx("g",{filter:l[2]==="#B5B5B6"?"url(#pujiang_outline)":void 0,children:e.jsx("path",{transform:`translate(0,${Object.keys(c).length?198:220})${Object.keys(c).length?"scale(1,2)":""}`,stroke:"var(--rmg-grey)",strokeWidth:12,d:`M24,16 H ${i.runin-24}`})}),e.jsx("g",{transform:`translate(${f[o][s].x},160)`,textAnchor:f[o][s].anchor,children:e.jsx(ge,{})})]})},ze=r=>{var v;const{prevStnIds:s,nextStnIds:t}=r,{direction:n,svgWidth:a,theme:l,coline:i,current_stn_idx:o,stn_list:c}=M($=>$.param),{branches:m}=M($=>$.helper),f=a.runin/2,x=$=>$.includes("linestart")||$.includes("lineend"),j=D(Object.values(i),m),u=t.length>1?"single":x(t)?j.filter($=>[o,s[0]].every(k=>$.linePath.includes(k))).length>0?"multiple":"single":[o,t[0]].every($=>m[0].includes($))&&j.filter($=>[o,t[0]].every(k=>$.linePath.includes(k))).length>0?"multiple":"single",g=x(t)?s:t,h=t.length>1?"var(--rmg-theme-colour)":(v=j.filter($=>$.linePath.includes(o)&&$.linePath.includes(g[0])).map($=>$.colors[0][2])[0])!=null?v:"var(--rmg-theme-colour)",d=($,k,y,b)=>$.slice(1).filter(I=>[k,y[0]].every(H=>I.includes(H))).filter(I=>Y(I,b)).length>0,p=Object.keys(i).length>0&&d(m,o,t,c)?h:"var(--rmg-theme-colour)",_=Object.keys(i).length>0&&t.length===1&&(x(s)||x(t)?!0:!([o,t[0]].every($=>m[0].includes($))&&j.filter($=>$.linePath.includes(o)&&$.linePath.includes(t[0])).length!==0)),S=Object.keys(i).length>0&&s.length===1;return e.jsxs("g",{transform:"translate(0,220)",strokeWidth:12,children:[e.jsxs(e.Fragment,{children:[p!=="var(--rmg-theme-colour)"&&e.jsx("marker",{id:`slope_${p}`,viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:p})}),e.jsx("path",{stroke:p,d:`M ${f},16 H ${n==="l"?36:a.runin-36}`,markerEnd:p==="var(--rmg-theme-colour)"?"url(#slope)":`url(#slope_${p})`,transform:_?"translate(0,-22)scale(1,2)":void 0})]}),u==="multiple"&&e.jsxs(e.Fragment,{children:[e.jsx("marker",{id:`slope_${h}`,viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:h})}),e.jsx("path",{stroke:h,d:`M ${f},16 H ${n==="l"?36+F:a.runin-(36+F)}`,markerEnd:`url(#slope_${h})`,transform:"translate(0,-12)"})]}),e.jsx("g",{filter:l[2]==="#B5B5B6"?"url(#pujiang_outline)":void 0,transform:`translate(0,${S?-22:0})scale(1,${S?2:1})`,children:e.jsx("path",{stroke:"var(--rmg-grey)",d:`M ${f},16 H ${n==="l"?a.runin-24:24} `})})]})},Be=r=>{const{prevStnIds:s,nextStnIds:t,nextBranchLineDy:n,prevBranchLineDy:a}=r,{direction:l,svgWidth:i,current_stn_idx:o,coline:c,theme:m}=M(_=>_.param),{branches:f}=M(_=>_.helper),x=i.runin/2,j=125,u=_=>`${_[0]},${_[1]}`,g=_=>`M${u(_.at(0))} `+_.slice(1).map(S=>`L${u(S)}`).join(" "),h=l==="l"?[[i.runin/3,j],[i.runin/6,n],[36,n]]:[[i.runin/3*2,j],[i.runin/6*5,n],[i.runin-36,n]],d=l==="l"?[[i.runin/3*2,j],[i.runin/6*5,a],[i.runin-24,a]]:[[i.runin/3,j],[i.runin/6,a],[24,a]];let p="var(--rmg-theme-colour)";if(Object.keys(c).length>0){const _=D(Object.values(c),f);t.length>1&&_.filter(S=>S.linePath.includes(o)&&t.some(v=>S.linePath.includes(v)))&&(h[0][1]-=F-1,h.unshift([x,j-F+1]),p=_.filter(S=>S.linePath.includes(o)&&t.some(v=>S.linePath.includes(v))).at(0).colors.at(0)[2]),s.length>1&&_.filter(S=>S.linePath.includes(o)&&s.some(v=>S.linePath.includes(v)))&&(d[0][1]-=F-1,d.unshift([x,j-F+1]))}return e.jsxs("g",{transform:"translate(0,110)",strokeWidth:12,fill:"none",filter:m[2]==="#B5B5B6"?"url(#pujiang_outline)":void 0,children:[e.jsx("marker",{id:"slope_branch",viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:p})}),t.length>1&&e.jsx("path",{stroke:p,d:g(h),markerEnd:"url(#slope_branch)"}),s.length>1&&e.jsx("path",{stroke:"var(--rmg-grey)",d:g(d)})]})},ge=()=>{const r=M(t=>t.param),{name:s}=r.stn_list[r.current_stn_idx];return w.useMemo(()=>e.jsxs(e.Fragment,{children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:112,children:s[0].replace("\\","")}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:36,dy:50,children:s[1].replace("\\","")})]}),[...s])},G=r=>{const{nextName:s,...t}=r;return e.jsx("g",{...t,children:w.useMemo(()=>e.jsxs(e.Fragment,{children:[s[0].split("\\").map((n,a,l)=>e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:48,dy:(l.length-1-a)*-50-(s[1].split("\\").length-1)*30,children:n},n)),s[1].split("\\").map((n,a,l)=>e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:24,dy:28+(l.length-1-a)*-30,children:n},n))]}),[...s])})},We=r=>{const s=M(l=>l.param),t=r.stnIds.map(l=>s.stn_list[l].name),n=(r.stnIds.length>1?15:125)+t.map(l=>l[0].split("\\").length).reduce((l,i)=>l+i,-t.length)*-50+t.map(l=>l[1].split("\\").length).reduce((l,i)=>l+i,-t.length)*-30,a=(r.stnIds.length>1?(t[0][0].split("\\").length-1)*-50+(t[0][1].split("\\").length-1)*-30:0)+70;return e.jsxs("g",{fill:"gray",textAnchor:s.direction==="l"?"end":"start",transform:`translate(${s.direction==="l"?s.svgWidth.runin-36:36},0)`,children:[e.jsx(G,{nextName:t[0],transform:"translate(0,183)"}),r.stnIds.length>1&&e.jsx(G,{nextName:t[1],transform:`translate(0,${a})`}),e.jsxs("g",{transform:`translate(0, ${n})`,children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:22,children:"上一站"}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:12,dx:s.direction==="l"?-70:70,children:"Past Stop"})]})]})},Ee=r=>{const s=M(l=>l.param),t=r.stnIds.map(l=>s.stn_list[l].name),n=(r.stnIds.length>1?15:125)+t.map(l=>l[0].split("\\").length).reduce((l,i)=>l+i,-t.length)*-50+t.map(l=>l[1].split("\\").length).reduce((l,i)=>l+i,-t.length)*-30,a=(r.stnIds.length>1?(t[0][0].split("\\").length-1)*-50+(t[0][1].split("\\").length-1)*-30:0)+70;return e.jsxs("g",{textAnchor:s.direction==="l"?"start":"end",transform:`translate(${s.direction==="l"?36:s.svgWidth.runin-36},0)`,children:[e.jsx(G,{nextName:s.stn_list[r.stnIds[0]].name,transform:"translate(0,183)"}),r.stnIds.length>1&&e.jsx(G,{nextName:s.stn_list[r.stnIds[1]].name,transform:`translate(0,${a})`}),e.jsxs("g",{transform:`translate(0, ${n})`,children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:22,children:"下一站"}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:12,dx:s.direction==="l"?70:-70,children:"Next Stop"})]})]})},X=r=>{var S;const{stnId:s,stnState:t,color:n,bank:a,direction:l}=r,{direction:i,info_panel_type:o,stn_list:c,loop:m}=M(v=>v.param),f=c[s],x=l!=null?l:i,j=m?0:([...f.branch.left,...f.branch.right].length?8+12*f.name[1].split("\\").length:0)*(x==="r"?-1:1);let u;const g={};o==="sh2020"?(f.services.length===3?u="stn_sh_2020_direct":f.services.length===2?u="stn_sh_2020_express":u="stn_sh_2020",g.fill=t===-1?"gray":n||"var(--rmg-theme-colour)"):(f.services.length===3?u="direct_sh":f.services.length===2?u="express_sh":[...f.transfer.groups[0].lines,...((S=f.transfer.groups[1])==null?void 0:S.lines)||[]].length>0?u="int2_sh":u="stn_sh",g.stroke=t===-1?"gray":n||"var(--rmg-theme-colour)");const h=a!=null?a:0,d=(x==="l"?6:-6)+j+h*30,p=(o==="sh2020"?-20:-6)+Math.abs(h)*(o==="sh2020"?25:11),_=h?0:x==="l"?-45:45;return e.jsxs(e.Fragment,{children:[e.jsx("use",{xlinkHref:`#${u}`,...g,transform:`translate(${h*(o==="sh2020"?5:0)},0)rotate(${h*90*(o==="sh2020"?1:-1)})`}),e.jsx("g",{transform:`translate(${d},${p})rotate(${_})`,children:e.jsx(Pe,{name:f.name,groups:f.transfer.groups,stnState:t,direction:x,facility:f.facility,bank:h,oneLine:f.one_line,intPadding:f.int_padding})}),t===0?e.jsx(Ce,{}):void 0]})},Pe=r=>{var p,_,S,v;const{name:s,groups:t,stnState:n,direction:a,facility:l,bank:i,oneLine:o,intPadding:c}=r,m=w.useRef(null),f=a==="l"?1:-1,x=l!==""?30:0,j=i?-12:0,u=w.useRef(null),[g,h]=w.useState(0);w.useEffect(()=>{var $,k;return h((k=($=u.current)==null?void 0:$.getBBox().width)!=null?k:0)},[JSON.stringify(t)]);const d=c-g;return e.jsxs(e.Fragment,{children:[t.map($=>$.lines).flat().length>0&&e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:(j+x)*f,x2:d*f,stroke:n===-1?"gray":"black",strokeWidth:.5}),e.jsx(Fe,{ref:u,groups:t,direction:a,transform:`translate(${d*f},-10.75)`})]}),l!==""&&e.jsx("use",{xlinkHref:"#"+l,x:10*f,y:-30}),e.jsxs("g",{textAnchor:a==="l"?"start":"end",transform:`translate(${x*f},-14)`,children:[e.jsx(Te,{ref:m,stnName:s,oneLine:o,directionPolarity:f,fill:n===-1?"gray":n===0?"red":"black"}),((_=(p=t[1])==null?void 0:p.lines)==null?void 0:_.length)&&e.jsx("g",{transform:`translate(${(d+g/2)*f},-30)`,children:e.jsx(Ge,{osiInfos:t[1].lines})}),((v=(S=t[2])==null?void 0:S.lines)==null?void 0:v.length)&&e.jsx("g",{transform:`translate(${(c+5)*f},0)`,children:e.jsx(Ye,{osysiInfos:t[2].lines,direction:r.direction})})]})]})},Te=w.forwardRef(function(s,t){const{stnName:n,oneLine:a,directionPolarity:l,...i}=s,o=w.useRef(null),[c,m]=w.useState(0);w.useEffect(()=>{a&&o.current?m(o.current.getBBox().width+5):m(0)},[...n,a]);const[f,x]=[20,8];return e.jsx("g",{ref:t,...i,children:w.useMemo(()=>e.jsxs(e.Fragment,{children:[e.jsx("g",{ref:o,children:n[0].split("\\").map((j,u,g)=>e.jsx("text",{className:"rmg-name__zh rmg-outline",dy:(g.length-1-u)*-f+(a?x:(n[1].split("\\").length-1)*-x),children:j},u))}),e.jsx("g",{fontSize:8,transform:`translate(${c*l},0)`,children:n[1].split("\\").map((j,u,g)=>e.jsx("text",{className:"rmg-name__en rmg-outline",dy:(g.length-2-u)*-x+2,children:j},u))})]}),[...n,a,c,l])})}),Ce=()=>{const{stn_list:r}=M(n=>n.param),s=new Set(Object.values(r).map(n=>n.services).flat()),t=[-1,35,50,75][s.size];return e.jsx("g",{transform:`translate(0, ${t})`,children:e.jsx("text",{className:"rmg-name__zh",fill:"red",textAnchor:"middle",children:"本站"})})},Fe=w.forwardRef(function(s,t){var c,m,f;const{groups:n,direction:a,...l}=s,i=[...n[0].lines,...((c=n[1])==null?void 0:c.lines)||[],...((f=(m=n[2])==null?void 0:m.lines)==null?void 0:f.filter(x=>!!x.name[0].match(/^磁(悬)*浮/)))||[]];let o=0;return e.jsx("g",{ref:t,fontSize:14,textAnchor:"middle",...l,children:i.map((x,j)=>{const u=!!x.name[0].match(/^\w+(号)?线/),g=!!x.name[0].match(/^磁(悬)*浮/);s.direction==="r"&&(o-=(u||g?20:x.name[0].length*14+12)+(j===0?0:5));let h;return g?h=e.jsx("g",{transform:`translate(${o},-16)scale(0.1428571429)`,children:e.jsx(De,{info:x})},j):u?h=e.jsx("g",{transform:`translate(${o},0)`,children:e.jsx(Ae,{info:x})},j):h=e.jsx("g",{transform:`translate(${o},0)`,children:e.jsx(Re,{info:x})},j),s.direction==="l"&&(o+=u||g?20+5:x.name[0].length*14+12+5),h})})}),De=w.memo(function(s){var t,n;return e.jsx(e.Fragment,{children:e.jsx("use",{xlinkHref:"#intbox_maglev",fill:(t=s.info.theme)==null?void 0:t[2],stroke:(n=s.info.theme)==null?void 0:n[2]})})},(r,s)=>JSON.stringify(r.info)===JSON.stringify(s.info)),Ae=w.memo(function(s){var t,n,a;return e.jsxs(e.Fragment,{children:[e.jsx("use",{xlinkHref:"#intbox_number",fill:(t=s.info.theme)==null?void 0:t[2]}),e.jsx("text",{x:10,className:"rmg-name__zh",fill:(n=s.info.theme)==null?void 0:n[3],dominantBaseline:"central",children:(a=s.info.name[0].match(/(\d*)\w+/))==null?void 0:a[0]})]})},(r,s)=>JSON.stringify(r.info)===JSON.stringify(s.info)),Re=w.memo(function(s){var n,a;const t=s.info.name[0].split("\\")[0].length;return e.jsxs(e.Fragment,{children:[e.jsx("rect",{height:22,width:t*14+12,y:-11,fill:(n=s.info.theme)==null?void 0:n[2]}),e.jsx("text",{x:t*7+6,className:"rmg-name__zh",fill:(a=s.info.theme)==null?void 0:a[3],dominantBaseline:"central",children:s.info.name[0].split("\\")[0]})]})},(r,s)=>JSON.stringify(r.info)===JSON.stringify(s.info)),Ge=r=>{const s=r.osiInfos.map(t=>t.name[0]).join("，");return w.useMemo(()=>e.jsxs("g",{textAnchor:"middle",fontSize:"50%",children:[e.jsx("text",{className:"rmg-name__zh",dy:-5,children:`换乘${s}`}),e.jsx("text",{className:"rmg-name__zh",dy:5,children:"仅限公共交通卡"}),e.jsx("text",{className:"rmg-name__en",dy:12.5,fontSize:"75%",children:"Only for Public Transportation Card"})]}),[s.toString()])},Ye=r=>{const s=r.osysiInfos.map(n=>n.name[0]).join("，"),t=r.osysiInfos.map(n=>n.name[1]).join(", ");return w.useMemo(()=>e.jsxs("g",{textAnchor:r.direction==="l"?"start":"end",fontSize:"50%",children:[e.jsxs("text",{className:"rmg-name__zh",dy:3,children:["转乘",s]}),e.jsxs("text",{className:"rmg-name__en",dy:10,fontSize:"75%",children:["To ",t]})]}),[JSON.stringify(r.osysiInfos),r.direction])},Ve=["shanghai","sh4","#5F259F","#fff","4号线","Line 4"],Xe=r=>{const{xs:s,servicesPresent:t,stnStates:n}=r,{svg_height:a,direction:l,stn_list:i,current_stn_idx:o,branchSpacingPct:c,info_panel_type:m,coline:f}=M($=>$.param),{branches:x,depsStr:j}=M($=>$.helper),u=w.useMemo(()=>(console.log("computing y shares"),Object.keys(i).reduce(($,k)=>{if(x[0].includes(k))return{...$,[k]:0};{const y=x.slice(1).filter(b=>b.includes(k))[0];return{...$,[k]:i[y[0]].children.indexOf(y[1])?-3:3}}},{})),[j]),g=Object.entries(u).filter(([$,k])=>k<=0).reduce(($,[k,y])=>({...$,[k]:y}),{}),h=Object.keys(g).reduce(($,k)=>({...$,[k]:-g[k]*c*a/300}),{}),d=w.useMemo(()=>Oe(D(Object.values(f).filter($=>$.display),x),n),[JSON.stringify(f),o,l,j]),p=t.reduce(($,k)=>({...$,[k]:Object.keys(d).reduce((y,b)=>({...y,[b]:d[b].map(I=>({path:fe(I.linePath,b,s,h,l,k,t.length,i,"diagonal"),colors:I.colors})).filter(I=>I.path!=="")}),{})}),{}),_=D(Object.values(f).filter($=>$.display),x).map($=>$.linePath).flat(),S=12,v=m==="sh2020"?3:0;return e.jsx(e.Fragment,{children:e.jsxs("g",{id:"coline",transform:`translate(0,${S+v})`,children:[e.jsx(Je,{paths:p,direction:l}),e.jsx(Ze,{colineStns:d,branches:x,xs:s,ys:h,stnStates:n,lineWidth:S,colineGap:v}),e.jsx(Ue,{stnIds:Object.entries(u).filter(([$,k])=>k<0).reduce(($,[k,y])=>[...$,k],[]).filter($=>!["linestart","lineend"].includes($)).filter($=>i[$].services.length!==0).filter($=>_.includes($)),xs:s,ys:h,stnStates:n})]})})},Je=r=>{const{paths:s,direction:t}=r;return e.jsx(e.Fragment,{children:Object.keys(s).map((n,a)=>{var l,i;return e.jsx("g",{transform:`translate(0,${a*25})`,children:e.jsxs("g",{children:[(l=s[n])==null?void 0:l.pass.map((o,c)=>e.jsx(w.Fragment,{children:e.jsx("path",{stroke:"var(--rmg-grey)",strokeWidth:12,fill:"none",d:o.path,strokeLinejoin:"round",filter:n===C.local?void 0:`url(#contrast-${n})`},c)},c)),(i=s[n])==null?void 0:i.main.map((o,c)=>{var m;return e.jsxs(w.Fragment,{children:[o.colors.length>1&&e.jsx("linearGradient",{id:`grad${c}`,y1:"-100%",y2:"100%",x1:"0",x2:"0",gradientUnits:"userSpaceOnUse",children:o.colors.map((f,x)=>e.jsxs(w.Fragment,{children:[e.jsx("stop",{offset:`${100/o.colors.length*(x+0)}%`,stopColor:f[2]}),e.jsx("stop",{offset:`${100/o.colors.length*(x+1)}%`,stopColor:f[2]})]},x))}),t==="l"&&e.jsx("marker",{id:`arrow_left_${c}_${o.colors.map(f=>f[2]).join("_")}`,refY:.5,refX:1,children:e.jsx("path",{d:"M1,0L0,1H1z",fill:o.colors.length>1?`url(#grad${c})`:o.colors[0][2]})}),t==="r"&&e.jsx("marker",{id:`arrow_right_${c}_${o.colors.map(f=>f[2]).join("_")}`,refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:o.colors.length>1?`url(#grad${c})`:o.colors[0][2]})}),e.jsx("path",{stroke:((m=o.colors.at(-1))!=null?m:Ve)[2],strokeWidth:12,fill:"none",d:o.path,markerStart:t==="l"?`url(#arrow_left_${c}_${o.colors.map(f=>f[2]).join("_")})`:void 0,markerEnd:t==="r"?`url(#arrow_right_${c}_${o.colors.map(f=>f[2]).join("_")})`:void 0,strokeLinejoin:"round",filter:n===C.local?void 0:`url(#contrast-${n})`},c)]},c)})]})},`servicePath${a}`)})})},Ze=r=>{const{colineStns:s,branches:t,xs:n,ys:a,stnStates:l,lineWidth:i,colineGap:o}=r,{line_name:c,theme:m,info_panel_type:f}=M(j=>j.param),x=[...s.main,...s.pass].map(j=>j.linePath.map(u=>{var g;return{curStn:u,x:n[u],y:a[u],color:(g=j.colors.at(-1))!=null?g:[...m,...c]}})).flat().reduce((j,u)=>j.find(g=>g.curStn===u.curStn)?j:j.concat(u),[]).filter(j=>t[0].includes(j.curStn));return console.log(x),e.jsx("g",{id:"stations_in_mainline",children:x.map(j=>{const{curStn:u,x:g,y:h,color:d}=j,p=(l[u]===-1?0:i)+o+i,_=(l[u]===-1?0:-i)-o-i/2;return e.jsx("g",{transform:`translate(${g},${h})`,children:f==="sh2020"?e.jsx("rect",{stroke:"none",height:p,width:12,x:-6,y:_,fill:l[u]===-1?"var(--rmg-grey)":d[2]}):e.jsx("use",{xlinkHref:"#int2_sh",stroke:"var(--rmg-theme-colour)",transform:`translate(0,${-i})`})},u)})})},Ue=r=>{const{xs:s,ys:t,stnStates:n,stnIds:a}=r,{branches:l,depsStr:i}=M(j=>j.helper),{line_name:o,theme:c,coline:m}=M(j=>j.param),f=w.useMemo(()=>D(Object.values(m),l),[JSON.stringify(m),i]),x=a.reduce((j,u)=>{var g;return{...j,[u]:(g=f.filter(h=>h.linePath.includes(u)).map(h=>h.colors).flat().at(0))!=null?g:[...c,...o]}},{});return e.jsx("g",{id:"stations_in_coline",children:a.map(j=>e.jsx("g",{transform:`translate(${s[j]},${t[j]})`,children:e.jsx(X,{stnId:j,stnState:n[j],color:x[j][2]})},j))})},qe=()=>{const{routes:r,branches:s,depsStr:t}=M(y=>y.helper),n=M(y=>y.param),{svg_height:a,stn_list:l,branchSpacingPct:i,coline:o,direction:c}=M(y=>y.param),m=he(n.stn_list,()=>0,()=>0),f=R("linestart","lineend",m),x=R(f.nodes[1],f.nodes.slice(-2)[0],m),j=w.useMemo(()=>(console.log("computing x shares"),Object.keys(n.stn_list).reduce((y,b)=>({...y,[b]:de(b,m,s)}),{})),[s.toString(),JSON.stringify(m)]),u=[n.svgWidth.railmap*n.padding/100,n.svgWidth.railmap*(1-n.padding/100)],g=Object.keys(j).reduce((y,b)=>({...y,[b]:u[0]+j[b]/x.len*(u[1]-u[0])}),{}),h=w.useMemo(()=>(console.log("computing y shares"),Object.keys(l).reduce((y,b)=>{if(s[0].includes(b))return{...y,[b]:0};{const I=s.slice(1).filter(H=>H.includes(b))[0];return{...y,[b]:l[I[0]].children.indexOf(I[1])?-3:3}}},{})),[t]),d=Object.entries(h).filter(([,y])=>y>=0).reduce((y,[b,I])=>({...y,[b]:I}),{}),p=Object.keys(d).reduce((y,b)=>({...y,[b]:-d[b]*i*a/300}),{}),_=w.useMemo(()=>me(n.current_stn_idx,r,n.direction),[n.current_stn_idx,n.direction,r.toString()]),S=Object.values(C),v=Object.values(n.stn_list).map(y=>y.services).flat().reduce((y,b)=>(y[S.indexOf(b)]=!0,y),[!1,!1,!1]).map((y,b)=>[S[b],y]).filter(y=>y[1]).map(y=>y[0]),$=s.map(y=>ce(y,_)).reduce((y,b)=>(y.main.push(b.main),y.pass.push(b.pass),y),{main:[],pass:[]}),k=v.reduce((y,b)=>({...y,[b]:Object.keys($).reduce((I,H)=>({...I,[H]:$[H].map(N=>fe(N,H,g,p,c,b,v.length,l)).filter(N=>N!=="")}),{})}),{});return e.jsxs("g",{id:"main",transform:`translate(0,${n.svg_height*(Object.keys(o).length>0?.5:.7+.1)})`,children:[e.jsx(Ke,{paths:k,direction:n.direction}),e.jsx(Qe,{stnIds:Object.keys(d).filter(y=>!["linestart","lineend"].includes(y)).filter(y=>l[y].services.length!==0),xs:g,ys:p,stnStates:_}),Object.keys(o).length>0&&e.jsx(Xe,{xs:g,servicesPresent:v,stnStates:_}),v.length>1&&e.jsx(et,{servicesLevel:v,lineXs:u})]})},Ke=r=>{const{theme:s}=M(a=>a.param),{paths:t,direction:n}=r;return e.jsx(e.Fragment,{children:Object.keys(t).map((a,l)=>{var i,o;return e.jsxs("g",{transform:`translate(0,${l*25})`,filter:s[2]==="#B5B5B6"?"url(#pujiang_outline)":void 0,children:[e.jsx("g",{children:(i=t[a])==null?void 0:i.pass.map((c,m)=>e.jsx("path",{stroke:"var(--rmg-grey)",strokeWidth:12,fill:"none",d:c,markerStart:r.direction==="l"?"url(#arrow_gray)":void 0,markerEnd:r.direction==="r"?"url(#arrow_gray)":void 0,strokeLinejoin:"round"},m))}),e.jsx("g",{children:(o=t[a])==null?void 0:o.main.map((c,m)=>e.jsx("path",{stroke:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:c,markerStart:n==="l"?"url(#arrow_theme_left)":void 0,markerEnd:n==="r"?"url(#arrow_theme_right)":void 0,strokeLinejoin:"round",filter:a===C.local?void 0:`url(#contrast-${a})`},m))})]},`servicePath${l}`)})})},fe=(r,s,t,n,a,l,i,o,c="rightangle")=>{let[m,f]=[];const x={},j={local:0,express:20,direct:40}[l],u=i>1?50:0;let g=30;if(r.length>0){let d=!1,p=!1;o[r.at(-1)||0].children.some(_=>["linestart","lineend"].includes(_))?p=!0:o[r.at(0)||0].parents.some(_=>["linestart","lineend"].includes(_))&&(d=!0),g=d||p?g:0}const h=30;if(r.forEach(d=>{const p=t[d],_=n[d];if(!m&&m!==0){[f,m]=[p,_],x.start=[p,_];return}_===0?_!==m&&(x.bifurcate=[f,m]):_!==m&&(x.bifurcate=[p,_]),x.end=[p,_],[f,m]=[p,_]}),"start"in x)if("end"in x)if("bifurcate"in x){const[d,p]=x.start,_=x.bifurcate[0],[S,v]=x.end;return s==="main"?a==="l"?v>p?(console.log(x),c==="rightangle"?`M ${d-g},${p} H ${S} V ${v}`:`M ${d},${p} H ${d+h} L ${_-h},${v} H ${S}`):c==="rightangle"?`M ${d},${p} V ${v} H ${S}`:`M ${d-g},${p} H ${_+h} L ${S-h},${v} H ${S}`:v>p?c==="rightangle"?`M ${d},${p} H ${S} V ${v}`:`M ${d},${p} H ${d+h} L ${_-h},${v} H ${S+g}`:c==="rightangle"?`M ${d},${p} V ${v} H ${S+g}`:`M ${d},${p} H ${_+h} L ${S-h},${v} H ${S}`:a==="l"?v>p?c==="rightangle"?`M ${d-g},${p} H ${S} V ${v}`:`M ${d},${p} H ${d+h} L ${_-h},${v} H ${S+g}`:c==="rightangle"?`M ${d},${p} V ${v} H ${S+g}`:`M ${d-g},${p} H ${_+h} L ${S-h},${v} H ${S}`:v>p?c==="rightangle"?`M ${d-g},${p} H ${S} V ${v}`:`M ${d},${p} H ${d+h} L ${_-h},${v} H ${S+g}`:c==="rightangle"?`M ${d},${p} V ${v} H ${S+g}`:`M ${d-g},${p} H ${_+h} L ${S-h},${v} H ${S}`}else{const[d,p]=x.start,_=x.end[0];return s==="main"?a==="l"?`M ${d-g-j},${p} H ${_}`:`M ${d},${p} H ${_+g+j}`:a==="l"?`M ${d-g},${p} H ${_+g+u}`:`M ${d-g-u},${p} H ${_+g}`}else{const[d,p]=x.start;return s==="main"?a==="l"?`M ${d-g-j},${p} H ${d}`:`M ${d},${p} H ${d+g+j}`:a==="l"?`M ${d},${p} L ${d+g+u},${p}`:`M ${d-g-u},${p} L ${d},${p}`}else return""},Qe=r=>{const{xs:s,ys:t,stnStates:n,stnIds:a}=r;return e.jsx("g",{children:a.map(l=>e.jsx("g",{transform:`translate(${s[l]},${t[l]})`,children:e.jsx(X,{stnId:l,stnState:n[l]})},l))})},et=r=>{const{svg_height:s,direction:t,svgWidth:n}=M(c=>c.param),a=-s+130,l=r.servicesLevel.map(c=>({local:"普通车",express:"大站车",direct:"直达车"})[c]),i=t==="r"?r.lineXs[0]-42:r.lineXs[1]+42,o=r.servicesLevel.length===2?350:500;return w.useMemo(()=>e.jsxs("g",{children:[l.map((c,m)=>e.jsxs("g",{transform:`translate(${i},${m*25})`,children:[e.jsx("rect",{x:-27.5,height:10,width:55,fill:"white",stroke:"black",y:-5}),e.jsx("text",{className:"rmg-name__zh",fontSize:9,y:3,textAnchor:"middle",children:`${c}运行线`})]},c)),e.jsxs("g",{transform:`translate(${t==="r"?30:n.railmap-o},${a})`,children:[e.jsx("text",{className:"rmg-name__zh",children:"图例："}),l.map((c,m)=>e.jsxs("g",{transform:`translate(${m*150+50},0)`,children:[e.jsx("line",{x1:"0",x2:"35",y1:"-5",y2:"-5",stroke:"var(--rmg-theme-colour)",strokeWidth:"12",filter:m===2?"url(#contrast-direct)":m===1?"url(#contrast-express)":""}),e.jsx("use",{x:"17.5",y:"-5",xlinkHref:"#stn_sh",fill:"var(--rmg-theme-colour)"}),e.jsx("text",{x:"40",className:"rmg-name__zh",children:`${c}停靠站`})]},`serviceLevel${m}`))]})]}),[s,t,n,r.servicesLevel,r.lineXs])},tt=()=>{const{direction:r,svgWidth:s,coline:t}=M(a=>a.param),n=!!Object.keys(t).length;return w.useMemo(()=>e.jsxs("g",{transform:`translate(${r==="l"?50:s.railmap-150},50)`,children:[e.jsx("text",{className:"rmg-name__zh",children:"列车前进方向"}),e.jsx("path",{d:"M60,60L0,0L60-60H100L55-15H160V15H55L100,60z",stroke:n?"var(--rmg-black)":void 0,strokeWidth:n?5:void 0,fill:n?"var(--rmg-white)":"var(--rmg-theme-colour)",transform:`translate(${r==="l"?-30:125},-5)rotate(${r==="l"?0:180})scale(0.15)`})]}),[r,t,s.railmap])},q=r=>{var m;const{stnId:s,nameDirection:t,services:n,color:a}=r,l=M(f=>f.param.stn_list[s]),i=[...l.transfer.groups[0].lines,...((m=l.transfer.groups[1])==null?void 0:m.lines)||[]];let o;l.services.length===3?o="direct_indoor_sh":l.services.length===2?o="express_indoor_sh":i.length>0?o="int2_indoor_sh":o="stn_indoor_sh";const c=t==="left"||t==="right"?90:0;return e.jsxs(e.Fragment,{children:[e.jsx(nt,{name:l.name,groups:l.transfer.groups,nameDirection:t,services:n}),e.jsx("use",{xlinkHref:`#${o}`,stroke:i.length>0?"var(--rmg-black)":a!=null?a:"var(--rmg-theme-colour)",transform:`rotate(${c})`}),l.services.length>1&&e.jsx("text",{className:"rmg-name__zh",writingMode:"tb",fontSize:"60%",dy:"-12",children:`大站车${l.services.length>2?" 直达车":""}停靠`})]})},nt=r=>{var f,x,j,u,g,h,d,p,_,S,v,$,k,y,b,I,H,N,z,P,E,B;const{name:s,groups:t,nameDirection:n,services:a}=r,l={upward:60,downward:-30,left:0,right:0}[n],i={upward:0,downward:0,left:85,right:-85}[n],o={upward:-185,downward:150+(a.length===3?40:0),left:-30,right:-30}[n],c=((x=(f=t[2])==null?void 0:f.lines)==null?void 0:x.length)>0?{upward:0,downward:0,left:t[0].lines.length+((u=(j=t[1])==null?void 0:j.lines)==null?void 0:u.length)!==0?85:25,right:t[0].lines.length+((h=(g=t[1])==null?void 0:g.lines)==null?void 0:h.length)!==0?-85:-25}[n]:0,m=((p=(d=t[2])==null?void 0:d.lines)==null?void 0:p.length)>0?{upward:(S=(_=t[1])==null?void 0:_.lines)!=null&&S.length?-210:t[0].lines.length?-180:-100,downward:(($=(v=t[1])==null?void 0:v.lines)!=null&&$.length?190:t[0].lines.length?160:100)+(a.length===3?40:0),left:(y=(k=t[1])==null?void 0:k.lines)!=null&&y.length?-60:t[0].lines.length?-30:0,right:(I=(b=t[1])==null?void 0:b.lines)!=null&&I.length?-60:t[0].lines.length?-30:0}[n]:0;return e.jsxs("g",{transform:`translate(0,${l})`,children:[n==="upward"||n==="downward"?e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:-30,x2:30,y1:n==="upward"?-23:-10,y2:n==="upward"?-23:-10,stroke:"black"}),e.jsx("line",{y1:n==="upward"?-23:-10,y2:n==="upward"?-23-25:20,stroke:"black"})]}):e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:n==="left"?-50:15,x2:n==="left"?-15:50,y1:0,y2:0,stroke:"black"}),e.jsx("line",{x1:n==="left"?-50:50,x2:n==="left"?-50:50,y1:-30,y2:30,stroke:"black"})]}),[...t[0].lines,...((H=t[1])==null?void 0:H.lines)||[]].length&&e.jsx(rt,{intInfos:[...t[0].lines,...((N=t[1])==null?void 0:N.lines)||[]],arrowDirection:n,services:a}),e.jsx(st,{stnName:s,nameDirection:n,fill:"black"}),((P=(z=t[1])==null?void 0:z.lines)==null?void 0:P.length)&&e.jsx("g",{transform:`translate(${i},${o})`,children:e.jsx(lt,{osiInfos:t[1].lines,nameDirection:n})}),((B=(E=t[2])==null?void 0:E.lines)==null?void 0:B.length)&&e.jsx("g",{transform:`translate(${c},${m})`,children:e.jsx(at,{osysiInfos:t[2].lines,nameDirection:n})})]})},st=w.forwardRef(function(s,t){const{stnName:n,nameDirection:a,...l}=s,i=n[0].split("\\"),o=n[1].split("\\").length,c={upward:0,downward:0,left:-60,right:60}[a],m={upward:-2,downward:-30-12*(o-1),left:-10*(o-1),right:-10*(o-1)}[a],f={upward:"middle",downward:"middle",left:"end",right:"start"}[a];return e.jsx("g",{ref:t,...l,textAnchor:f,transform:`translate(${c},${m})`,children:w.useMemo(()=>e.jsxs(e.Fragment,{children:[i.map((x,j,u)=>e.jsx("text",{className:"rmg-name__zh",dy:a==="upward"?16*j:(u.length-1-j)*-16,children:x},j)),e.jsx("g",{fontSize:9.6,children:n[1].split("\\").map((x,j)=>e.jsx("text",{className:"rmg-name__en",dy:12*(j+1)+(a==="upward"&&i.length>1?i.length*7.5:0),children:x},j))})]}),[...n])})}),rt=r=>{var g;const{intInfos:s,arrowDirection:t,services:n}=r,a=s.map(h=>{var d;return(d=h.theme)==null?void 0:d[2]}).reduce((h,d)=>h+d,""),l=[s.filter(h=>h.name[0].match(/^\d+.*$/)).map(h=>h.name[0].replace(/^(\d+)(.*)$/,"$1")).join("，").concat("号线"),s.filter(h=>!h.name[0].match(/^\d+.*$/)).map(h=>h.name[0]).join("，")].filter(h=>h&&h!=="号线").join("，"),i=["Line ".concat(s.filter(h=>/^(L|l)ine \d+$/.test(h.name[1])).map(h=>h.name[1].replace("Line","").replace("line","").trim()).join(",")),s.filter(h=>!/^(L|l)ine \d+$/.test(h.name[1])).map(h=>h.name[1]).join(", ")].filter(h=>h&&h!=="Line ").join(", "),o=n.length===3?80:45,c={upward:-145,downward:125+(n.length===3?40:0),left:7,right:7}[t],m={upward:0,downward:0,left:20,right:-20}[t],f={upward:-74,downward:44,left:0,right:0}[t],x={upward:0,downward:180,left:90,right:-90}[t],j={upward:0,downward:0,left:85,right:-85}[t],u={upward:"middle",downward:"middle",left:"start",right:"end"}[t];return e.jsxs("g",{children:[e.jsx("path",{id:"int_indoor_arrow_sh",stroke:"var(--rmg-black)",strokeWidth:1,transform:`translate(${m},${f})rotate(${x})`,fill:s.length===1?(g=s[0].theme)==null?void 0:g[2]:`url(#grad${a})`,d:`M -7.5,0 v -${o} h -7.5 l 15,-15 l 15,15 h -7.5 v ${o} Z`}),s.length>1&&e.jsx(e.Fragment,{children:e.jsx("linearGradient",{id:`grad${a}`,y1:"0",y2:"0",x1:t==="upward"?"25%":"75%",x2:t==="upward"?"75%":"25%",children:s.map((h,d)=>{var p,_;return e.jsxs(w.Fragment,{children:[e.jsx("stop",{offset:`${100/s.length*d}%`,stopColor:(p=h.theme)==null?void 0:p[2]}),e.jsx("stop",{offset:`${100/s.length*(d+1)}%`,stopColor:(_=h.theme)==null?void 0:_[2]})]},d)})})}),e.jsxs("g",{transform:`translate(${j},${c})`,textAnchor:`${u}`,children:[e.jsx("text",{className:"rmg-name__zh",dy:-7,children:`换乘${l}`}),e.jsx("text",{className:"rmg-name__en",dy:5,fontSize:9.6,children:`Interchange ${i}`})]})]})},lt=r=>{const s={upward:"middle",downward:"middle",left:"start",right:"end"}[r.nameDirection];return w.useMemo(()=>e.jsxs("g",{textAnchor:`${s}`,fontSize:"50%",children:[e.jsx("text",{className:"rmg-name__zh",dy:-5,children:`换乘${r.osiInfos.map(t=>t.name[0]).join("，")}`}),e.jsx("text",{className:"rmg-name__zh",dy:5,children:"仅限公共交通卡"}),e.jsx("text",{className:"rmg-name__en",dy:12.5,fontSize:"75%",children:"Only for Public Transportation Card"})]}),[JSON.stringify(r.osiInfos),r.nameDirection])},at=r=>{const s={upward:"middle",downward:"middle",left:"start",right:"end"}[r.nameDirection];return w.useMemo(()=>e.jsxs("g",{textAnchor:`${s}`,children:[e.jsx("text",{className:"rmg-name__zh",dy:-5,children:`转乘${r.osysiInfos.map(t=>t.name[0]).join("，")}`}),e.jsx("text",{className:"rmg-name__en",dy:7.5,fontSize:9.6,children:`To ${r.osysiInfos.map(t=>t.name[1]).join(", ")}`})]}),[JSON.stringify(r.osysiInfos),r.nameDirection])},it=(r,s,t,n,a,l)=>{var j,u,g,h;const i=r[0].filter(d=>!["linestart","lineend"].includes(d)),o=r.slice(1,3).map(d=>d.slice(1,d.length-1)),c=o.reduce((d,p)=>d+p.filter(_=>!["linestart","lineend",...s].includes(_)).length,0)+i.length-l-a*2,m=(t-t*n/100*2)/(1+c),f=[t*n/100+((j=o.at(0))!=null?j:[]).length*m,t*(1-n/100)-((u=o.at(1))!=null?u:[]).length*m],x={...Object.fromEntries(((g=o.at(0))!=null?g:[]).map((d,p)=>[d,t*n/100+p*m])),...Object.fromEntries(((h=o.at(1))!=null?h:[]).map((d,p)=>[d,f[1]+(1+p)*m]))};return{loop_branches:o,line_xs_branches:f,xs_branches:x}},ot=r=>{var _,S,v,$;const{loop_branches:s,edges:t,xs:n,ys:a,canvas:l}=r,[i,o,c,m]=t,{branches:f}=M(k=>k.helper),{current_stn_idx:x,direction:j,coline:u}=M(k=>k.param),g=l===L.RailMap?30:0,h=[`M ${i},${c} H ${Number(n[(S=(_=s.at(0))==null?void 0:_.at(0))!=null?S:""])-g}`,`M ${o},${c} H ${Number(n[($=(v=s.at(1))==null?void 0:v.at(-1))!=null?$:""])+g}`],d=f[0].filter(k=>!["linestart","lineend"].includes(k)),p=Object.values(u).filter(k=>![k.from,k.to].every(y=>d.includes(y))).map(k=>k.colors);return e.jsx(e.Fragment,{children:s.map((k,y)=>{var b,I,H;return e.jsxs(Z.Fragment,{children:[p.filter((N,z,P)=>z===P.findIndex(E=>{var B,T;return((B=E.at(0))==null?void 0:B.at(2))===((T=N.at(0))==null?void 0:T.at(2))})).map(N=>e.jsx("marker",{id:`arrow_theme_${N[0][2]}`,refX:1,refY:.5,children:e.jsx("path",{d:"M0,1H2L1,0z",fill:N[0][2]})},N[0][2])),e.jsx("path",{stroke:(H=(I=(b=p.at(y))==null?void 0:b.at(0))==null?void 0:I.at(2))!=null?H:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:h[y],markerEnd:l===L.RailMap&&(j==="l"&&y===0||j==="r"&&y===1)?p.at(y)?`url(#arrow_theme_${p[y][0][2]})`:"url(#arrow_theme)":void 0}),k.filter(N=>!["linestart","lineend"].includes(N)).map(N=>{var z,P,E,B;return e.jsxs(Z.Fragment,{children:[l===L.RailMap&&e.jsx("g",{transform:`translate(${n[N]},${a[N]})`,children:e.jsx(X,{stnId:N,stnState:x===N?0:1,bank:0,direction:j,color:(P=(z=p.at(y))==null?void 0:z.at(0))==null?void 0:P.at(2)})},N),l===L.Indoor&&e.jsx("g",{transform:`translate(${n[N]},${a[N]})`,children:e.jsx(q,{stnId:N,nameDirection:s.filter(T=>T.includes(N)).map(T=>T.indexOf(N)%2===0?"downward":"upward")[0],services:[C.local],color:(B=(E=p.at(y))==null?void 0:E.at(0))==null?void 0:B.at(2)})},N)]},N)})]},k.at(0))})})},ct=r=>{var p;const{edges:s,loop_stns:t,xs:n,ys:a,canvas:l}=r,[i,o,c,m]=s,{info_panel_type:f,stn_list:x,coline:j}=M(_=>_.param),{branches:u}=M(_=>_.helper),g=Object.values(j).filter(_=>[_.from,_.to].every(S=>u.slice(1,3).filter(v=>Y(v,x)).flat().includes(S))).map(_=>_.colors).at(0),h=12,d=l===L.RailMap&&f==="sh2020"?3:0;return e.jsxs("g",{id:"coline_main",children:[e.jsx("path",{d:`M ${i},${c} H${o}`,strokeWidth:12,stroke:(p=g==null?void 0:g.at(0))==null?void 0:p.at(2)}),l===L.RailMap&&Object.keys(j).length>0&&t.top.map(_=>{var S;return e.jsx("g",{transform:`translate(${n[_]},${a[_]})`,children:f==="sh2020"?e.jsxs(e.Fragment,{children:[e.jsx("rect",{stroke:"none",height:24,width:12,x:-6,y:-d-1,fill:(S=g==null?void 0:g.at(0))==null?void 0:S.at(2)}),e.jsx("rect",{stroke:"none",height:d+h,width:12,x:-6,y:h-2,fill:"var(--rmg-theme-colour)"})]}):e.jsx("use",{xlinkHref:"#int2_sh",stroke:"var(--rmg-theme-colour)",transform:`translate(0,${1+h})`})},_)})]})},ue=r=>{var ee;const{bank_angle:s,canvas:t}=r,{branches:n}=M(O=>O.helper),{current_stn_idx:a,svgWidth:l,svg_height:i,padding:o,branchSpacingPct:c,direction:m,info_panel_type:f,stn_list:x,loop_info:{left_and_right_factor:j,bottom_factor:u},coline:g}=M(O=>O.param),h=n[0].filter(O=>!["linestart","lineend"].includes(O)),d=n.slice(0,3).flat().filter((O=>W=>(O[W]=(O[W]||0)+1)===2)({})).filter(O=>!["linestart","lineend"].includes(O)),p=(ee=Object.values(g).filter(O=>[O.from,O.to].every(W=>n.slice(1,3).filter(A=>Y(A,x)).flat().includes(W))).map(O=>{const W=h.findIndex(J=>J===O.from),A=h.findIndex(J=>J===O.to);return Math.abs(A-W)>h.length-2-Math.abs(A-W)?"major":"minor"}).at(0))!=null?ee:"minor",_=d.at(1)?_e(h,d,j,p):d.at(0)?xe(h,d[0],u,j):je(h,a,u,j),{x_shares:S,y_shares:v}=$e(h,_),{loop_branches:$,line_xs_branches:k,xs_branches:y}=it(n,d,l[t],o,j,_.bottom.length),b={...v,...Object.fromEntries($.flat().map(O=>[O,0]))},I=c*i/300,H=[225+I,i-75-(t===L.RailMap?0:125)-I],N=Object.keys(b).reduce((O,W)=>({...O,[W]:H[0]+b[W]*(H[1]-H[0])}),{}),z=[Math.max(l[t]*o/100+(s&&t===L.RailMap?100:0),k[0]),Math.min(l[t]*(1-o/100)-(s&&t===L.RailMap?100:0),k[1])],P=Object.keys(S).reduce((O,W)=>({...O,[W]:z[0]+S[W]*(z[1]-z[0])}),{}),E=s?{l:1,r:-1}[m]:0;[..._.right,..._.left].forEach(O=>{P[O]-=(N[O]-H[0])*E}),_.bottom.forEach(O=>{P[O]-=(H[1]-H[0])*E});const B={...y,...P},T=ht(_,B,N,E,[...z,...H],m),K=12,Q=t===L.RailMap&&f==="sh2020"?3:0;Object.keys(g).length>0&&_.top.forEach(O=>{N[O]-=Q+K});const pe=$.length?0:(H[1]-H[0])*E/2;return e.jsxs("g",{id:"loop",transform:`translate(${pe},0)`,children:[e.jsx("path",{stroke:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:T,strokeLinejoin:"round"}),t===L.RailMap&&e.jsx(ae,{canvas:t,loop_stns:_,xs:B,ys:N}),e.jsxs("g",{transform:`translate(0,${Object.keys(g).length>0?-K-Q:0})`,children:[e.jsx(ot,{loop_branches:$,edges:[...z,...H],xs:B,ys:N,canvas:t}),Object.keys(g).length>0&&e.jsx(ct,{edges:[...z,...H],loop_stns:_,xs:B,ys:N,canvas:t})]}),t===L.Indoor&&e.jsx(ae,{canvas:t,loop_stns:_,xs:B,ys:N})]})},ht=(r,s,t,n,a,l)=>{const[i,o,c,m]=a,f=(u,g,h,d,p)=>({right:[h+(d-c)*n,g],bottom:[u-(m-g)*n,d],left:[h-(m-d)*n,g],top:[u+(g-c)*n,d]})[p],x=[];r.top.forEach(u=>{x.push([s[u],t[u]])}),["right","bottom","left"].forEach(u=>{if(r[u].length>0)x.push(f(x.at(-1)[0],x.at(-1)[1],s[r[u][0]],t[r[u][0]],u)),r[u].forEach(g=>{x.push([s[g],t[g]])});else{const g={right:[o,x.at(-1)[1]],bottom:[x.at(-1)[0]+(m-x.at(-1)[1])*-n,x.at(-1)[1]+(m-x.at(-1)[1])],left:[i+(n===0?0:(m-c)*(l==="l"?-1:1)),x.at(-1)[1]]};x.push(g[u])}}),x.push(f(x.at(-1)[0],x.at(-1)[1],s[r.top[0]],t[r.top[0]],"top"));const j=x.slice(1).map(([u,g])=>`L${u},${g} `).join(" ");return`M${x[0][0]},${x[0][1]} ${j} Z`},ae=r=>{const{canvas:s,loop_stns:t,xs:n,ys:a}=r,{current_stn_idx:l}=M(m=>m.param),i={top:0,bottom:0,left:-1,right:1},o={left:"r",right:"l",top:void 0,bottom:void 0},c=(m,f)=>({top:f%2===0?"upward":"downward",bottom:f%2===0?"upward":"downward",left:"left",right:"right"})[m];return e.jsxs("g",{id:"loop_stations",children:[s===L.RailMap&&Object.entries(t).map(([m,f])=>f.map(x=>e.jsx("g",{transform:`translate(${n[x]},${a[x]})`,children:e.jsx(X,{stnId:x,stnState:l===x?0:1,bank:i[m],direction:o[m]})},x))),s===L.Indoor&&Object.entries(t).map(([m,f])=>f.map((x,j)=>e.jsx("g",{transform:`translate(${n[x]},${a[x]})`,children:e.jsx(q,{stnId:x,nameDirection:c(m,j),services:[C.local]})},x)))]})},ie=L.RailMap;function dt(){const{canvasScale:r}=M(o=>o.app),{svgWidth:s,svg_height:t,theme:n,loop:a,loop_info:{bank:l}}=M(o=>o.param),i=s[ie];return e.jsxs(V,{type:ie,svgWidth:i,svgHeight:t,canvasScale:r,theme:n,children:[e.jsx(mt,{}),a?e.jsx(ue,{bank_angle:l,canvas:L.RailMap}):e.jsx(qe,{}),e.jsx(tt,{})]})}const mt=w.memo(function(){return e.jsxs("defs",{children:[e.jsx("circle",{id:"stn_sh",fill:"var(--rmg-white)",strokeWidth:2,r:5}),e.jsx("path",{id:"int2_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V10 a 5,5 0 1 1 -10,0Z"}),e.jsx("path",{id:"express_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V25 a 5,5 0 1 1 -10,0Z"}),e.jsx("path",{id:"direct_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V50 a 5,5 0 1 1 -10,0Z"}),e.jsx("rect",{id:"stn_sh_2020",stroke:"none",height:24,width:12,x:-6,y:-18}),e.jsx("rect",{id:"stn_sh_2020_express",stroke:"none",height:49,width:12,x:-6,y:-18}),e.jsx("rect",{id:"stn_sh_2020_direct",stroke:"none",height:74,width:12,x:-6,y:-18}),e.jsx("rect",{id:"intbox_number",height:22,width:20,y:-11}),e.jsxs("g",{id:"intbox_maglev",transform:"translate(-25,0)",children:[e.jsx("rect",{id:"maglev_5",height:144,width:130,y:"40",x:"30",strokeWidth:10}),e.jsx("path",{id:"maglev_3",fill:"var(--rmg-white)",d:"m90,55a40,5 0 0 0 -40,3a5,5 0 0 0 -5,5a5,60 0 0 0 -3,60a5,5 0 0 0 5,5l96,0a5,5 0 0 0 5,-5a5,60 0 0 0 -3,-60a5,5 0 0 0 -5,-5a40,5 0 0 0 -40,-3l-5,-10l-5,10"}),e.jsx("path",{id:"maglev_4",fill:"var(--rmg-white)",d:"m90,140l-40,0a10,5 0 0 1 -10,-5l0,25a10,15 0 0 0 10,15l15,0l0,-10l-15,0l0,-15l90,0l0,15l-15,0l0,10l15,0a10,15 0 0 0 10,-15l0,-25a10,5 0 0 1 -10,5l-50,0"}),e.jsx("rect",{id:"maglev_1",height:"25",width:"40",y:"80",x:"50"}),e.jsx("rect",{id:"maglev_2",height:"25",width:"40",y:"80",x:"100"})]}),e.jsxs("g",{id:"airport",transform:"scale(0.5)",children:[e.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)"}),e.jsx("path",{id:"airport",d:"M28.9769,6.60134c1.711.013,3.111,2.53205,3.111,4.241v10.337s17.106,15.435,17.358,15.666a1.145,1.145,0,0,1,.488,1.152v2.833c0,.651-.451.61-.695.467-.334-.119-17.151-8.863-17.151-8.863-.004,1.458-.797,9.006-1.326,13.304,0,0,4.61,2.457,4.699,2.521.334.268.352.359.352.852v2.001c0,.477-.352.428-.51.324-.183-.062-5.693-1.921-5.693-1.921a2.56018,2.56018,0,0,0-.633-.127,2.31654,2.31654,0,0,0-.666.127s-5.477,1.859-5.672,1.921c-.185.104-.523.153-.523-.324v-2.001c0-.493.029-.584.367-.852.086-.064,4.678-2.521,4.678-2.521-.524-4.298-1.307-11.846-1.325-13.304,0,0-16.822,8.744-17.148,8.863-.217.143-.69.184-.69-.467v-2.833a1.16206,1.16206,0,0,1,.473-1.152c.276-.231,17.365-15.666,17.365-15.666v-10.337c0-1.709,1.403-4.228,3.14105-4.241",transform:"translate(-28.9697,0.14347)",fill:"var(--rmg-white)"})]}),e.jsxs("g",{id:"disney",transform:"scale(0.5)",children:[e.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)"}),e.jsx("path",{fill:"var(--rmg-white)",d:"M45.6152,7.85015a9.80248,9.80248,0,0,0-9.79907,9.801,9.70059,9.70059,0,0,0,.342,2.582c.002.026.002.055.002.093a.31815.31815,0,0,1-.31494.318.67741.67741,0,0,1-.12806-.02,15.71521,15.71521,0,0,0-13.498,0,.61.61,0,0,1-.122.02.31841.31841,0,0,1-.322-.318v-.067a9.62553,9.62553,0,0,0,.35608-2.608,9.803,9.803,0,1,0-9.797,9.8,10.10364,10.10364,0,0,0,2.308-.271h.05493a.31113.31113,0,0,1,.31409.318.32433.32433,0,0,1-.019.12,15.72588,15.72588,0,1,0,29.703,7.216,15.83676,15.83676,0,0,0-1.746-7.23.18417.18417,0,0,1-.0271-.106.31612.31612,0,0,1,.32007-.318h.057a10.15953,10.15953,0,0,0,2.316.271,9.80051,9.80051,0,0,0,0-19.601",transform:"translate(-28.9697 0.13398)"})]}),e.jsxs("g",{id:"railway",children:[e.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)",transform:"translate(0,-2)scale(0.5)"}),e.jsx("path",{fill:"var(--rmg-white)",d:"M169,273.5c0-19,14.7-34.8,33.7-36.3c18.9-1.5,38.1-2.2,57.4-2.2c19.3,0,38.4,0.8,57.3,2.2  c19,1.5,33.7,17.3,33.7,36.3v47.3l-51.3,14.7c-11.2,3.2-18.9,13.4-18.9,25v147.8c0,17.4,12.2,32.3,29.3,35.7l110.6,22.1  c4.9,1,8.4,5.2,8.4,10.2V599H91v-22.7c0-5,3.5-9.2,8.4-10.2L209.9,544c17-3.4,29.3-18.3,29.3-35.7V360.5c0-11.6-7.7-21.8-18.9-25  L169,320.8V273.5z M309.4,31.7c0.2-1.2,0.3-2.4,0.3-3.6c0-14-11.1-25.4-24.9-26C276.6,1.4,268.3,1,260,1c-8.3,0-16.6,0.4-24.7,1.1  c-13.9,0.6-24.9,12-24.9,26c0,1.2,0.1,2.5,0.3,3.6C90.6,54.8,0,160.3,0,287c0,97.2,53.4,182,132.4,226.6l36.8-48.1  C104.3,432.4,59.8,364.9,59.8,287c0-110.6,89.6-200.2,200.2-200.2S460.2,176.4,460.2,287c0,77.9-44.5,145.4-109.4,178.5  c15,19.6,25.6,33.5,36.8,48.1C466.6,469,520,384.2,520,287C520,160.3,429.4,54.8,309.4,31.7z",transform:"translate(-10,0)scale(0.04)"})]}),e.jsx("marker",{id:"arrow_gray",viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-grey)"})}),e.jsx("marker",{id:"arrow_theme_left",refX:1,refY:.5,children:e.jsx("path",{d:"M1,0L0,1H1z",fill:"var(--rmg-theme-colour)"})}),e.jsx("marker",{id:"arrow_theme_right",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})}),e.jsx("marker",{id:"arrow_theme",refX:1,refY:.5,children:e.jsx("path",{d:"M0,1H2L1,0z",fill:"var(--rmg-theme-colour)"})}),e.jsx("filter",{id:"contrast-direct",filterUnits:"userSpaceOnUse",children:e.jsxs("feComponentTransfer",{children:[e.jsx("feFuncR",{type:"linear",slope:.5,intercept:.25}),e.jsx("feFuncG",{type:"linear",slope:.5,intercept:.25}),e.jsx("feFuncB",{type:"linear",slope:.5,intercept:.25})]})}),e.jsx("filter",{id:"contrast-express",filterUnits:"userSpaceOnUse",children:e.jsxs("feComponentTransfer",{children:[e.jsx("feFuncR",{type:"linear",slope:.75,intercept:.125}),e.jsx("feFuncG",{type:"linear",slope:.75,intercept:.125}),e.jsx("feFuncB",{type:"linear",slope:.75,intercept:.125})]})}),e.jsx(U,{})]})}),oe=L.Indoor;function xt(){const{canvasScale:r}=M(i=>i.app),{svgWidth:s,svg_height:t,theme:n,loop:a}=M(i=>i.param),l=s[oe];return e.jsxs(V,{type:oe,svgWidth:l,svgHeight:t,canvasScale:r,theme:n,children:[e.jsx(gt,{}),a?e.jsx(ue,{bank_angle:!1,canvas:L.Indoor}):e.jsx(pt,{}),e.jsx($t,{})]})}const gt=w.memo(function(){return e.jsxs("defs",{children:[e.jsx("circle",{id:"stn_indoor_sh",fill:"var(--rmg-white)",strokeWidth:5,r:8,transform:"scale(1.5)"}),e.jsx("path",{id:"int2_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V10 a 5,5 0 1 1 -10,0Z"}),e.jsx("path",{id:"express_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V25 a 5,5 0 1 1 -10,0Z"}),e.jsx("path",{id:"direct_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V40 a 5,5 0 1 1 -10,0Z"})]})}),ft=(r,s)=>{let t=0;return r[s].parents.length===2&&(t+=1),r[r[s].parents[0]].children.length===2&&(t+=1),t},ut=(r,s)=>{let t=0;return r[s].children.length===2&&(t+=1),r[r[s].children[0]].parents.length===2&&(t+=1),t},pt=()=>{const{routes:r,branches:s,depsStr:t}=M(d=>d.helper),n=M(d=>d.param),a=he(n.stn_list,ft,ut),l=R("linestart","lineend",a),i=R(l.nodes[1],l.nodes.slice(-2)[0],a),o=w.useMemo(()=>(console.log("computing x shares"),Object.keys(n.stn_list).reduce((d,p)=>({...d,[p]:de(p,a,s)}),{})),[s.toString(),JSON.stringify(a)]),c=[n.svgWidth.indoor*n.padding/100,n.svgWidth.indoor*(1-n.padding/100)],m=Object.keys(o).reduce((d,p)=>({...d,[p]:c[0]+o[p]/i.len*(c[1]-c[0])}),{}),f=w.useMemo(()=>te.getYShares(n.stn_list,s),[t]),x=Object.keys(f).reduce((d,p)=>({...d,[p]:f[p]*n.branchSpacingPct*n.svg_height/200}),{}),j=w.useMemo(()=>me(n.current_stn_idx,r,n.direction),[n.current_stn_idx,n.direction,r.toString()]),u=Object.values(C),g=Object.values(n.stn_list).map(d=>d.services).flat().reduce((d,p)=>(d[u.indexOf(p)]=!0,d),[!1,!1,!1]).map((d,p)=>[u[p],d]).filter(d=>d[1]).map(d=>d[0]),h=te.drawLine(s,j,n.stn_list,c,m,x,n.branchSpacingPct*n.svg_height/200,l,0);return e.jsxs("g",{id:"main",transform:`translate(0,${n.svg_height/2})`,children:[e.jsx(jt,{paths:h,services:g}),e.jsx(_t,{xs:m,ys:x,services:g})]})},jt=r=>e.jsx("g",{fill:"none",strokeWidth:12,stroke:"var(--rmg-theme-colour)",children:r.services.map((s,t)=>e.jsxs("g",{transform:`translate(0, ${t*30})`,children:[r.paths.main.map((n,a)=>e.jsx("path",{d:n},a)),r.paths.pass.map((n,a)=>e.jsx("path",{d:n},a))]},`indoor_line_${t}`))}),_t=r=>{const{branches:s}=M(i=>i.helper),t=M(i=>i.param),{xs:n,ys:a,services:l}=r;return e.jsx("g",{children:Object.keys(t.stn_list).filter(i=>!["linestart","lineend"].includes(i)).filter(i=>t.stn_list[i].services.length!==0).map(i=>e.jsx("g",{transform:`translate(${n[i]},${a[i]})`,children:e.jsx(q,{stnId:i,nameDirection:s.filter(o=>o.includes(i)).map(o=>o.indexOf(i)%2===0||l.length>1?"downward":"upward")[0],services:l})},i))})},$t=()=>{const r=M(s=>s.param);return w.useMemo(()=>e.jsxs(e.Fragment,{children:[e.jsx("g",{transform:`translate(${r.svgWidth.indoor/2},50)`,children:e.jsxs("text",{textAnchor:"middle",fontSize:"30",className:"rmg-name__zh",children:["轨道交通",r.line_name[0],"运营线路示意图"]})}),e.jsxs("g",{transform:`translate(${r.svgWidth.indoor/2},${r.svg_height-270})`,children:[e.jsx("text",{textAnchor:"middle",fontSize:"18",className:"rmg-name__zh",dx:"-30",dy:"230",children:"友情提示：请留意您需要换乘线路的首末班时间，以免耽误您的出行，末班车进站前三分钟停售该末班车车票。"}),e.jsx("text",{textAnchor:"middle",fontSize:"12",className:"rmg-name__en",dx:"10",dy:"250",children:"Please pay attention to the interchange schedule if you want to transfer to other lines. Stop selling tickets 3 minutes before the last train services."}),e.jsxs("g",{transform:"translate(-600,215)",children:[e.jsx("rect",{x:"-5",y:"-25",width:"100",height:"70",fill:"none",stroke:"black",rx:"5"}),e.jsx("line",{x1:"28",x2:"28",y1:"-20",y2:"40",stroke:"black"}),e.jsx("text",{className:"rmg-name__zh",dx:"3",fontSize:"18",children:"图"}),e.jsx("text",{className:"rmg-name__zh",dx:"3",dy:"18",fontSize:"18",children:"例"}),e.jsx("text",{className:"rmg-name__en",dy:"35",fontSize:"8",children:"legend"}),e.jsx("use",{transform:"translate(45,10)",xlinkHref:"#int2_indoor_sh",stroke:"var(--rmg-black)"}),e.jsx("text",{className:"rmg-name__zh",dx:"60",dy:"10",fontSize:"10",children:"换乘站"}),e.jsx("text",{className:"rmg-name__en",dx:"60",dy:"20",fontSize:"6",children:"Interchange"}),e.jsx("text",{className:"rmg-name__en",dx:"60",dy:"30",fontSize:"6",children:"Station"})]})]})]}),[r.svgWidth.indoor,r.svg_height,r.line_name])},bt={destination:e.jsx(ye,{}),runin:e.jsx(He,{}),railmap:e.jsx(dt,{}),indoor:e.jsx(xt,{})};export{bt as default};
