import{o as k,j as e,b5 as Q}from"./vendor-8354dbc6.js";import{ar as z,u as M,F as ee,j as C}from"./index-6ce9f305.js";import{i as Y}from"./app-router-4b1e5d91.js";import{S as V,d as ce,a as he,c as R,g as de,b as me}from"./share-d1cb9f2c.js";import{a as te}from"./mtr-2f54f749.js";import"./param-selector-b9f18b41.js";const je=(r,n,t,s)=>{const a=r.length-s*2-t,i=r.findIndex(d=>d===n),l=[...r,...r,...r],o=r.length+i-Math.floor(a/2)+(a%2===0?1:0),h=r.length+i+Math.floor(a/2);return{top:l.slice(o,h+1),left:l.slice(o-s,o),right:l.slice(h+1,h+1+s),bottom:l.slice(h+1+s,h+1+s+t)}},xe=(r,n,t,s)=>{const a=r.length-s*2-t,i=[...r,...r,...r],l=r.length+r.findIndex(d=>d===n),o=i[l+a-1],h=r.length+r.findIndex(d=>d===o)+(l+a>r.length*2?r.length:0);return{top:i.slice(l,h+1),left:i.slice(l-s,l),right:i.slice(h+1,h+1+s),bottom:i.slice(h+1+s,h+1+s+t)}},_e=(r,n,t,s)=>{let a=r.findIndex(g=>g===n[0]),i=r.findIndex(g=>g===n[1]);[a,i,n[0],n[1]]=a>i?[i,a,n[1],n[0]]:[a,i,n[0],n[1]];const l=r.slice(a,i+1),o=r.filter(g=>!l.filter(x=>!n.includes(x)).includes(g)),h=r.length-(s==="major"?Math.max:Math.min)(l.length,o.length)-t*2,d=s==="major"?l.length>o.length?n[0]:n[1]:l.length>o.length?n[1]:n[0];return xe(r,d,h,t)},$e=(r,n)=>{const t=Object.fromEntries(r.map(d=>[d,-1])),s=Object.fromEntries(r.map(d=>[d,-1])),[a,i,l,o]=[0,1,0,1],h=0;return n.top.forEach((d,g)=>{t[d]=h/2+(1-h)/(n.top.length+1)*(g+1),s[d]=a}),n.right.forEach((d,g)=>{t[d]=o,s[d]=h/2+(1-h)/(n.right.length+1)*(g+1)}),n.bottom.forEach((d,g)=>{t[d]=1-h/2-(1-h)/(n.bottom.length+1)*(g+1),s[d]=i}),n.left.forEach((d,g)=>{t[d]=l,s[d]=1-h/2-(1-h)/(n.left.length+1)*(g+1)}),{x_shares:t,y_shares:s}},ve=(r,n,t,s)=>{const a=r[0].filter(h=>!["linestart","lineend"].includes(h)),i=[...a,...a,...a],l=n==="r"?i:i.reverse(),o=l.findIndex(h=>s===h)+a.length;return l.slice(o+1).filter(h=>t[h].loop_pivot).slice(void 0,2)},ne=z.Destination;function ye(){const{canvasScale:r}=M(i=>i.app),{svgWidth:n,svg_height:t,theme:s}=M(i=>i.param),a=n[ne];return e.jsxs(V,{type:ne,svgWidth:a,svgHeight:t,canvasScale:r,theme:s,children:[e.jsx(Se,{}),e.jsx(ke,{})]})}const Se=k.memo(function(){return e.jsx("defs",{children:e.jsx("marker",{id:"slope",viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})})})}),ke=()=>{const{routes:r,branches:n}=M($=>$.helper),{line_name:t,theme:s,current_stn_idx:a,direction:i,stn_list:l,info_panel_type:o,loop:h,coline:d}=M($=>$.param),g=($,S,v)=>[...new Set($.filter(w=>w.includes(v)).map(w=>{const y=w.filter(b=>!["linestart","lineend"].includes(b));return S==="l"?y[0]:y.reverse()[0]}))],x=($,S)=>S?[[$.map(v=>l[v].name[0]).join("，"),$.map(v=>l[v].name[1]).join(", ")].map(v=>v.replace("\\",""))]:$.map(v=>l[v].name.map(w=>w.replace("\\",""))),p=h?ve(n,i,l,a):g(r,i,a),u=(h?g(r,i,a):p).filter($=>n.slice(1).filter(S=>Y(S,l)).some(S=>S.includes($))),c=p.filter($=>!u.includes($)),f=x(c,!h&&o!=="sh2020");console.log(f);const m=x(u,!0),j=250,_=Object.fromEntries(u.map($=>[$,Object.values(d).filter(S=>S.from===$||S.to===$).at(0)]).filter(([,$])=>$));return e.jsxs(e.Fragment,{children:[e.jsx(se,{dest_names:f,line_name:t,line_color:[s[2],s[3]],coline:!!u.length,upper:!!u.length}),u.length&&u.map($=>{var S,v,w;return e.jsx("g",{transform:`translate(0,${-j})`,children:e.jsx(se,{dest_names:[m.at(0)],line_name:(S=_[$])==null?void 0:S.colors.at(0).slice(4),line_color:[(v=_[$])==null?void 0:v.colors.at(0)[2],(w=_[$])==null?void 0:w.colors.at(0)[3]],coline:!0,upper:!1})},`coline_${$}`)})]})},se=r=>{const{dest_names:n,line_name:t,line_color:s,coline:a,upper:i}=r,{current_stn_idx:l,direction:o,platform_num:h,svgWidth:d,svg_height:g}=M(S=>S.param),x=k.useRef(null),[p,u]=k.useState({width:0});k.useEffect(()=>{x.current&&u(x.current.getBBox())},[JSON.stringify(n),JSON.stringify(l)]);const[c,f,m,j,_]=[d.destination/2,10,36,264,325],$=c-f-m-p.width>=_/2&&c-f-m-j>=_/2?c:o==="l"?(d.destination+p.width-j)/2:(d.destination-p.width+j)/2;return e.jsxs("g",{transform:`translate(0,${g-300})`,children:[e.jsx("path",{stroke:s[0],strokeWidth:12,d:o==="l"?`M${d.destination-24},16 H 36`:`M24,16 H ${d.destination-36}`,transform:`translate(0,${i?-20:220})`,markerEnd:a?void 0:"url(#slope)"}),e.jsx(we,{ref:x,dest_names:n}),h!==""&&e.jsx("g",{transform:`translate(${$},0)`,children:e.jsx(Me,{})}),t[0].match(/^[\w\d]+(号)?线/)?e.jsx(Ne,{line_name:t,line_color:s}):e.jsx(be,{line_name:t,line_color:s})]})},we=k.forwardRef(function(n,t){const{dest_names:s}=n,{direction:a,svgWidth:i}=M(l=>l.param);return e.jsxs("g",{ref:t,transform:`translate(${a==="l"?36:i.destination-36},145)`,children:[e.jsx("g",{transform:`translate(0,${s.length===2?-20:20})`,children:e.jsx("path",{d:"M60,60L0,0L60-60H100L55-15H160V15H55L100,60z",fill:"black",transform:`rotate(${a==="l"?0:180})scale(0.8)`})}),e.jsx("g",{textAnchor:a==="l"?"start":"end",transform:`translate(${a==="l"?128+20:-128-20},25)`,children:s.map((l,o)=>e.jsxs(k.Fragment,{children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:70,dy:o*-100+7,children:"往"+l[0]},`zh${o}`),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:25,dy:o*-100+40,children:"To "+l[1]},`en${o}`)]},o))})]})}),Me=()=>{const{platform_num:r}=M(n=>n.param);return k.useMemo(()=>e.jsxs("g",{transform:`translate(${-325/2+60},150)`,children:[e.jsx("circle",{r:60,fill:"none",stroke:"black",strokeWidth:2}),e.jsx("text",{className:"rmg-name__en rmg-outline",dominantBaseline:"central",fontSize:120,textAnchor:"middle",children:r}),e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:100,dominantBaseline:"central",x:65,children:"站台"})]}),[r])},be=r=>{const{line_name:n,line_color:t}=r,{direction:s,svgWidth:a}=M(x=>x.param),i=s==="l"?a.destination-42:42,l=k.useRef(null),[o,h]=k.useState({width:0});k.useEffect(()=>{l.current&&h(l.current.getBBox())},[...n]);const d=(s==="l"?-o.width:0)-6,g=(s==="l"?-1:1)*o.width/2;return k.useMemo(()=>e.jsxs("g",{transform:`translate(${i},92)`,children:[e.jsx("rect",{fill:t[0],x:d,width:o.width+10,height:120}),e.jsxs("g",{textAnchor:s==="r"?"start":"end",transform:"translate(0,68)",fill:t[1],children:[e.jsx("g",{ref:l,children:e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:68,children:n[0]})}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:30,textAnchor:"middle",x:g,dy:42,children:n[1]})]})]}),[o,...n,...t,s,a.destination])},Ne=r=>{const{line_name:n,line_color:t}=r,{direction:s,svgWidth:a}=M(h=>h.param),[i,l]=n[0].match(/^[\w\d]+|.+/g),o=s==="l"?a.destination-36-210:36+54;return k.useMemo(()=>e.jsxs("g",{transform:`translate(${o},92)`,children:[e.jsx("rect",{fill:t[0],x:-54,width:108,height:120}),e.jsx("text",{className:"rmg-name__zh rmg-outline",fill:t[1],fontSize:96,textAnchor:"middle",dominantBaseline:"central",transform:"translate(0,60)",letterSpacing:-5,children:i}),e.jsxs("g",{textAnchor:"start",transform:"translate(74,68)",children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:68,children:l}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:30,dy:42,children:n[1]})]})]}),[o,...n,...t,s,a.destination])},D=(r,n)=>r.map(t=>{const s=n.filter(h=>h.includes(t.from)&&h.includes(t.to));if(s.length!==1)return{linePath:[],colors:t.colors};const a=s.flat(),i=a.indexOf(t.from),l=a.indexOf(t.to);return{linePath:i<l?a.slice(i,l+1):a.slice(l,i+1),colors:t.colors}}).filter(t=>t.linePath.length!==0),He=(r,n)=>r.map(t=>{const s=ce(t.linePath,n);return{main:[{linePath:s.main,colors:t.colors}],pass:[{linePath:s.pass,colors:t.colors}]}}).reduce((t,s)=>(t.main=[...t.main,...s.main],t.pass=[...t.pass,...s.pass],t),{main:[],pass:[]}),F=12,re=z.RunIn,Oe=()=>{const{canvasScale:r}=M(c=>c.app),{branches:n,routes:t,depsStr:s}=M(c=>c.helper),{svgWidth:a,svg_height:i,current_stn_idx:l,direction:o,loop:h,theme:d}=M(c=>c.param),g=a[re],x=i-300,p=k.useMemo(()=>{let c=t.filter(f=>f.includes(l)).map(f=>f[f.indexOf(l)+(o==="l"?1:-1)]).reduce((f,m)=>f.includes(m)?f:f.concat(m),[]);return h&&n[0].includes(l)&&c.length===1&&["linestart","lineend"].includes(c[0])&&(c=o==="l"?[n[0][1]]:[n[0][n[0].length-2]]),c},[s,l,o,h]),u=k.useMemo(()=>{let c=t.filter(f=>f.includes(l)).map(f=>f[f.indexOf(l)+(o==="l"?-1:1)]).reduce((f,m)=>f.includes(m)?f:f.concat(m),[]);return h&&n[0].includes(l)&&c.length===1&&["linestart","lineend"].includes(c[0])&&(c=o==="l"?[n[0][n[0].length-2]]:[n[0][1]]),c},[s,l,o,h]);return e.jsxs(V,{type:re,svgWidth:g,svgHeight:i,canvasScale:r,theme:d,children:[e.jsx(Ie,{}),e.jsx("g",{transform:`translate(0,${x})`,children:e.jsx(ze,{prevStnIds:p,nextStnIds:u})})]})},Ie=k.memo(function(){return e.jsxs("defs",{children:[e.jsx("marker",{id:"slope",viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})}),e.jsxs("filter",{id:"pujiang_outline_runin",colorInterpolationFilters:"sRGB",filterUnits:"userSpaceOnUse",x:"0",y:"-1000",width:"5000",height:"2000",children:[e.jsx("feMorphology",{operator:"erode",in:"SourceAlpha",radius:"0",result:"e1"}),e.jsx("feMorphology",{operator:"erode",in:"SourceAlpha",radius:"1",result:"e2"}),e.jsx("feComposite",{in:"e1",in2:"e2",operator:"xor",result:"outline"}),e.jsx("feComposite",{in:"outline",in2:"SourceGraphic",operator:"over",result:"output"})]})]})}),ze=r=>{const{prevStnIds:n,nextStnIds:t}=r,{info_panel_type:s,svgWidth:a,stn_list:i}=M(u=>u.param),l=a.runin/2,o=t.length===1&&["linestart","lineend"].includes(t[0]),h=n.length===1&&["linestart","lineend"].includes(n[0]),d=t.map(u=>i[u].name),g=n.map(u=>i[u].name),x=(t.length>1?(d[0][0].split("\\").length-1)*-50+(d[0][1].split("\\").length-1)*-30:0)+10,p=(n.length>1?(g[0][0].split("\\").length-1)*-50+(g[0][1].split("\\").length-1)*-30:0)+10;return e.jsxs(e.Fragment,{children:[e.jsx(We,{prevStnIds:n,nextStnIds:t,nextBranchLineDy:x,prevBranchLineDy:p}),o&&s!=="sh2020"?e.jsx(ie,{mode:"terminal",prevStnIds:n,nextStnIds:t}):h&&s!=="sh2020"?e.jsx(ie,{mode:"original",prevStnIds:n,nextStnIds:t}):e.jsxs(e.Fragment,{children:[e.jsx(Le,{prevStnIds:n,nextStnIds:t}),e.jsx("g",{transform:`translate(${l},160)`,textAnchor:"middle",children:e.jsx(ge,{})})]}),(h||!o)&&e.jsx(Pe,{stnIds:r.nextStnIds}),(o||!h)&&e.jsx(Ee,{stnIds:r.prevStnIds})]})},ie=r=>{var c;const{mode:n,prevStnIds:t,nextStnIds:s}=r,{current_stn_idx:a,theme:i,svgWidth:l,direction:o,coline:h}=M(f=>f.param),{branches:d}=M(f=>f.helper),g={l:{original:{x:l.runin-36,anchor:"end"},terminal:{x:36,anchor:"start"}},r:{original:{x:36,anchor:"start"},terminal:{x:l.runin-36,anchor:"end"}}},x=D(Object.values(h),d),p=n==="terminal"?t:s,u=s.length>1?"var(--rmg-theme-colour)":(c=x.filter(f=>f.linePath.includes(a)&&f.linePath.includes(p[0])).map(f=>f.colors[0][2])[0])!=null?c:"var(--rmg-theme-colour)";return e.jsxs(e.Fragment,{children:[n==="original"&&e.jsx("path",{transform:`translate(0,${h.length?"198":"220"})${h.length?"scale(1,2)":""}`,stroke:u,strokeWidth:12,d:o==="l"?`M ${l.runin-24},16 H 36`:`M24,16 H ${l.runin-36}`,markerEnd:"url(#slope)"}),n==="terminal"&&e.jsx("g",{filter:i[2]==="#999999"?"url(#pujiang_outline_runin)":void 0,children:e.jsx("path",{transform:`translate(0,${h.length?"198":"220"})${h.length?"scale(1,2)":""}`,stroke:"var(--rmg-grey)",strokeWidth:12,d:`M24,16 H ${l.runin-24}`})}),e.jsx("g",{transform:`translate(${g[o][n].x},160)`,textAnchor:g[o][n].anchor,children:e.jsx(ge,{})})]})},Le=r=>{var S;const{prevStnIds:n,nextStnIds:t}=r,{direction:s,svgWidth:a,theme:i,coline:l,current_stn_idx:o,stn_list:h}=M(v=>v.param),{branches:d}=M(v=>v.helper),g=a.runin/2,x=v=>v.includes("linestart")||v.includes("lineend"),p=D(Object.values(l),d),u=t.length>1?"single":x(t)?p.filter(v=>[o,n[0]].every(w=>v.linePath.includes(w))).length>0?"multiple":"single":[o,t[0]].every(v=>d[0].includes(v))&&p.filter(v=>[o,t[0]].every(w=>v.linePath.includes(w))).length>0?"multiple":"single",c=x(t)?n:t,f=t.length>1?"var(--rmg-theme-colour)":(S=p.filter(v=>v.linePath.includes(o)&&v.linePath.includes(c[0])).map(v=>v.colors[0][2])[0])!=null?S:"var(--rmg-theme-colour)",m=(v,w,y,b)=>v.slice(1).filter(I=>[w,y[0]].every(O=>I.includes(O))).filter(I=>Y(I,b)).length>0,j=Object.keys(l).length>0&&m(d,o,t,h)?f:"var(--rmg-theme-colour)",_=Object.keys(l).length>0&&t.length===1&&(x(n)||x(t)?!0:!([o,t[0]].every(v=>d[0].includes(v))&&p.filter(v=>v.linePath.includes(o)&&v.linePath.includes(t[0])).length!==0)),$=Object.keys(l).length>0&&n.length===1;return e.jsxs("g",{transform:"translate(0,220)",strokeWidth:12,children:[e.jsxs(e.Fragment,{children:[j!=="var(--rmg-theme-colour)"&&e.jsx("marker",{id:`slope_${j}`,viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:j})}),e.jsx("path",{stroke:j,d:`M ${g},16 H ${s==="l"?36:a.runin-36}`,markerEnd:j==="var(--rmg-theme-colour)"?"url(#slope)":`url(#slope_${j})`,transform:_?"translate(0,-22)scale(1,2)":void 0})]}),u==="multiple"&&e.jsxs(e.Fragment,{children:[e.jsx("marker",{id:`slope_${f}`,viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:f})}),e.jsx("path",{stroke:f,d:`M ${g},16 H ${s==="l"?36+F:a.runin-(36+F)}`,markerEnd:`url(#slope_${f})`,transform:"translate(0,-12)"})]}),e.jsx("g",{filter:i[2]==="#999999"?"url(#pujiang_outline_runin)":void 0,transform:`translate(0,${$?-22:0})scale(1,${$?2:1})`,children:e.jsx("path",{stroke:"var(--rmg-grey)",d:`M ${g},16 H ${s==="l"?a.runin-24:24} `})})]})},We=r=>{const{prevStnIds:n,nextStnIds:t,nextBranchLineDy:s,prevBranchLineDy:a}=r,{direction:i,svgWidth:l,current_stn_idx:o,coline:h,theme:d}=M(_=>_.param),{branches:g}=M(_=>_.helper),x=l.runin/2,p=125,u=_=>`${_[0]},${_[1]}`,c=_=>`M${u(_.at(0))} `+_.slice(1).map($=>`L${u($)}`).join(" "),f=i==="l"?[[l.runin/3,p],[l.runin/6,s],[36,s]]:[[l.runin/3*2,p],[l.runin/6*5,s],[l.runin-36,s]],m=i==="l"?[[l.runin/3*2,p],[l.runin/6*5,a],[l.runin-24,a]]:[[l.runin/3,p],[l.runin/6,a],[24,a]];let j="var(--rmg-theme-colour)";if(Object.keys(h).length>0){const _=D(Object.values(h),g);t.length>1&&_.filter($=>$.linePath.includes(o)&&t.some(S=>$.linePath.includes(S)))&&(f[0][1]-=F-1,f.unshift([x,p-F+1]),j=_.filter($=>$.linePath.includes(o)&&t.some(S=>$.linePath.includes(S))).at(0).colors.at(0)[2]),n.length>1&&_.filter($=>$.linePath.includes(o)&&n.some(S=>$.linePath.includes(S)))&&(m[0][1]-=F-1,m.unshift([x,p-F+1]))}return e.jsxs("g",{transform:"translate(0,110)",strokeWidth:12,fill:"none",filter:d[2]==="#999999"?"url(#pujiang_outline_runin)":void 0,children:[e.jsx("marker",{id:"slope_branch",viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:j})}),t.length>1&&e.jsx("path",{stroke:j,d:c(f),markerEnd:"url(#slope_branch)"}),n.length>1&&e.jsx("path",{stroke:"var(--rmg-grey)",d:c(m)})]})},ge=()=>{const r=M(t=>t.param),{name:n}=r.stn_list[r.current_stn_idx];return k.useMemo(()=>e.jsxs(e.Fragment,{children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:112,children:n[0].replace("\\","")}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:36,dy:50,children:n[1].replace("\\","")})]}),[...n])},G=r=>{const{nextName:n,...t}=r;return e.jsx("g",{...t,children:k.useMemo(()=>e.jsxs(e.Fragment,{children:[n[0].split("\\").map((s,a,i)=>e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:48,dy:(i.length-1-a)*-50-(n[1].split("\\").length-1)*30,children:s},s)),n[1].split("\\").map((s,a,i)=>e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:24,dy:28+(i.length-1-a)*-30,children:s},s))]}),[...n])})},Ee=r=>{const n=M(i=>i.param),t=r.stnIds.map(i=>n.stn_list[i].name),s=(r.stnIds.length>1?15:125)+t.map(i=>i[0].split("\\").length).reduce((i,l)=>i+l,-t.length)*-50+t.map(i=>i[1].split("\\").length).reduce((i,l)=>i+l,-t.length)*-30,a=(r.stnIds.length>1?(t[0][0].split("\\").length-1)*-50+(t[0][1].split("\\").length-1)*-30:0)+70;return e.jsxs("g",{fill:"gray",textAnchor:n.direction==="l"?"end":"start",transform:`translate(${n.direction==="l"?n.svgWidth.runin-36:36},0)`,children:[e.jsx(G,{nextName:t[0],transform:"translate(0,183)"}),r.stnIds.length>1&&e.jsx(G,{nextName:t[1],transform:`translate(0,${a})`}),e.jsxs("g",{transform:`translate(0, ${s})`,children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:22,children:"上一站"}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:12,dx:n.direction==="l"?-70:70,children:"Past Stop"})]})]})},Pe=r=>{const n=M(i=>i.param),t=r.stnIds.map(i=>n.stn_list[i].name),s=(r.stnIds.length>1?15:125)+t.map(i=>i[0].split("\\").length).reduce((i,l)=>i+l,-t.length)*-50+t.map(i=>i[1].split("\\").length).reduce((i,l)=>i+l,-t.length)*-30,a=(r.stnIds.length>1?(t[0][0].split("\\").length-1)*-50+(t[0][1].split("\\").length-1)*-30:0)+70;return e.jsxs("g",{textAnchor:n.direction==="l"?"start":"end",transform:`translate(${n.direction==="l"?36:n.svgWidth.runin-36},0)`,children:[e.jsx(G,{nextName:n.stn_list[r.stnIds[0]].name,transform:"translate(0,183)"}),r.stnIds.length>1&&e.jsx(G,{nextName:n.stn_list[r.stnIds[1]].name,transform:`translate(0,${a})`}),e.jsxs("g",{transform:`translate(0, ${s})`,children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:22,children:"下一站"}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:12,dx:n.direction==="l"?70:-70,children:"Next Stop"})]})]})},X=r=>{const{stnId:n,stnState:t,color:s,bank:a,direction:i}=r,{direction:l,info_panel_type:o,stn_list:h,loop:d}=M($=>$.param),g=h[n],x=i!=null?i:l,p=d?0:([...g.branch.left,...g.branch.right].length?8+12*g.name[1].split("\\").length:0)*(x==="r"?-1:1);let u;const c={};o==="sh2020"?(g.services.length===3?u="stn_sh_2020_direct":g.services.length===2?u="stn_sh_2020_express":u="stn_sh_2020",c.fill=t===-1?"gray":s||"var(--rmg-theme-colour)"):(g.services.length===3?u="direct_sh":g.services.length===2?u="express_sh":[...g.transfer.info[0],...g.transfer.info[1]||[]].length>0?u="int2_sh":u="stn_sh",c.stroke=t===-1?"gray":s||"var(--rmg-theme-colour)");const f=a!=null?a:0,m=(x==="l"?6:-6)+p+f*30,j=(o==="sh2020"?-20:-6)+Math.abs(f)*(o==="sh2020"?25:11),_=f?0:x==="l"?-45:45;return e.jsxs(e.Fragment,{children:[e.jsx("use",{xlinkHref:`#${u}`,...c,transform:`translate(${f*(o==="sh2020"?5:0)},0)rotate(${f*90*(o==="sh2020"?1:-1)})`}),e.jsx("g",{transform:`translate(${m},${j})rotate(${_})`,children:e.jsx(Te,{name:g.name,infos:g.transfer.info,stnState:t,direction:x,facility:g.facility,bank:f,oneLine:g.one_line,intPadding:g.int_padding})}),t===0?e.jsx(Ce,{}):void 0]})},Te=r=>{var j;const{name:n,infos:t,stnState:s,direction:a,facility:i,bank:l,oneLine:o,intPadding:h}=r,d=k.useRef(null),g=a==="l"?1:-1,x=i!==ee.none?30:0,p=l?-12:0,u=k.useRef(null),[c,f]=k.useState(0);k.useEffect(()=>{var _,$;return f(($=(_=u.current)==null?void 0:_.getBBox().width)!=null?$:0)},[...JSON.stringify(t)]);const m=h-c;return e.jsxs(e.Fragment,{children:[t.flat().length>0&&e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:(p+x)*g,x2:m*g,stroke:s===-1?"gray":"black",strokeWidth:.5}),e.jsx(Fe,{ref:u,intInfos:t,direction:a,transform:`translate(${m*g},-10.75)`})]}),i!==ee.none&&e.jsx("use",{xlinkHref:"#"+i,x:10*g,y:-30}),e.jsxs("g",{textAnchor:a==="l"?"start":"end",transform:`translate(${x*g},-14)`,children:[e.jsx(Be,{ref:d,stnName:n,oneLine:o,directionPolarity:g,fill:s===-1?"gray":s===0?"red":"black"}),((j=t[1])==null?void 0:j.length)>0&&e.jsx("g",{transform:`translate(${(m+c/2)*g},-30)`,children:e.jsx(Ge,{osiInfos:t[1]})}),[...t[2]||[]].length>0&&e.jsx("g",{transform:`translate(${(h+5)*g},0)`,children:e.jsx(Ye,{osysiInfos:t[2],direction:r.direction})})]})]})},Be=k.forwardRef(function(n,t){const{stnName:s,oneLine:a,directionPolarity:i,...l}=n,o=k.useRef(null),[h,d]=k.useState(0);k.useEffect(()=>{a&&o.current?d(o.current.getBBox().width+5):d(0)},[...s,a]);const[g,x]=[20,8];return e.jsx("g",{ref:t,...l,children:k.useMemo(()=>e.jsxs(e.Fragment,{children:[e.jsx("g",{ref:o,children:s[0].split("\\").map((p,u,c)=>e.jsx("text",{className:"rmg-name__zh rmg-outline",dy:(c.length-1-u)*-g+(a?x:(s[1].split("\\").length-1)*-x),children:p},u))}),e.jsx("g",{fontSize:8,transform:`translate(${h*i},0)`,children:s[1].split("\\").map((p,u,c)=>e.jsx("text",{className:"rmg-name__en rmg-outline",dy:(c.length-2-u)*-x+2,children:p},u))})]}),[...s,a,h,i])})}),Ce=()=>{const{stn_list:r}=M(s=>s.param),n=new Set(Object.values(r).map(s=>s.services).flat()),t=[-1,35,50,75][n.size];return e.jsx("g",{transform:`translate(0, ${t})`,children:e.jsx("text",{className:"rmg-name__zh",fill:"red",textAnchor:"middle",children:"本站"})})},Fe=k.forwardRef(function(n,t){var h;const{intInfos:s,direction:a,...i}=n,l=[...s[0],...s[1]||[],...((h=s[2])==null?void 0:h.filter(d=>!!d[4].match(/^磁(悬)*浮/)))||[]];let o=0;return e.jsx("g",{ref:t,fontSize:14,textAnchor:"middle",...i,children:l.map((d,g)=>{const x=!!d[4].match(/^\w+(号)?线/),p=!!d[4].match(/^磁(悬)*浮/);n.direction==="r"&&(o-=(x||p?20:d[4].length*14+12)+(g===0?0:5));let u;return p?u=e.jsx("g",{transform:`translate(${o},-16)scale(0.1428571429)`,children:e.jsx(De,{info:d})},g):x?u=e.jsx("g",{transform:`translate(${o},0)`,children:e.jsx(Ae,{info:d})},g):u=e.jsx("g",{transform:`translate(${o},0)`,children:e.jsx(Re,{info:d})},g),n.direction==="l"&&(o+=x||p?20+5:d[4].length*14+12+5),u})})}),De=k.memo(function(n){return e.jsx(e.Fragment,{children:e.jsx("use",{xlinkHref:"#intbox_maglev",fill:n.info[2],stroke:n.info[2]})})},(r,n)=>r.info.toString()===n.info.toString()),Ae=k.memo(function(n){var t;return e.jsxs(e.Fragment,{children:[e.jsx("use",{xlinkHref:"#intbox_number",fill:n.info[2]}),e.jsx("text",{x:10,className:"rmg-name__zh",fill:n.info[3],dominantBaseline:"central",children:(t=n.info[4].match(/(\d*)\w+/))==null?void 0:t[0]})]})},(r,n)=>r.info.toString()===n.info.toString()),Re=k.memo(function(n){const t=n.info[4].split("\\")[0].length;return e.jsxs(e.Fragment,{children:[e.jsx("rect",{height:22,width:t*14+12,y:-11,fill:n.info[2]}),e.jsx("text",{x:t*7+6,className:"rmg-name__zh",fill:n.info[3],dominantBaseline:"central",children:n.info[4].split("\\")[0]})]})},(r,n)=>r.info.toString()===n.info.toString()),Ge=r=>{const n=r.osiInfos.map(t=>t[4]).join("，");return k.useMemo(()=>e.jsxs("g",{textAnchor:"middle",fontSize:"50%",children:[e.jsx("text",{className:"rmg-name__zh",dy:-5,children:`换乘${n}`}),e.jsx("text",{className:"rmg-name__zh",dy:5,children:"仅限公共交通卡"}),e.jsx("text",{className:"rmg-name__en",dy:12.5,fontSize:"75%",children:"Only for Public Transportation Card"})]}),[n.toString()])},Ye=r=>{const n=r.osysiInfos.map(s=>s[4]).join("，"),t=r.osysiInfos.map(s=>s[5]).join(", ");return k.useMemo(()=>e.jsxs("g",{textAnchor:r.direction==="l"?"start":"end",fontSize:"50%",children:[e.jsxs("text",{className:"rmg-name__zh",dy:3,children:["转乘",n]}),e.jsxs("text",{className:"rmg-name__en",dy:10,fontSize:"75%",children:["To ",t]})]}),[r.osysiInfos.toString(),r.direction])},Ve=["shanghai","sh4","#5F259F","#fff","4号线","Line 4"],Xe=r=>{const{xs:n,servicesPresent:t,stnStates:s}=r,{svg_height:a,direction:i,stn_list:l,current_stn_idx:o,branchSpacingPct:h,info_panel_type:d,coline:g}=M(v=>v.param),{branches:x,depsStr:p}=M(v=>v.helper),u=k.useMemo(()=>(console.log("computing y shares"),Object.keys(l).reduce((v,w)=>{if(x[0].includes(w))return{...v,[w]:0};{const y=x.slice(1).filter(b=>b.includes(w))[0];return{...v,[w]:l[y[0]].children.indexOf(y[1])?-3:3}}},{})),[p]),c=Object.entries(u).filter(([v,w])=>w<=0).reduce((v,[w,y])=>({...v,[w]:y}),{}),f=Object.keys(c).reduce((v,w)=>({...v,[w]:-c[w]*h*a/300}),{}),m=k.useMemo(()=>He(D(Object.values(g).filter(v=>v.display),x),s),[JSON.stringify(g),o,i,p]),j=t.reduce((v,w)=>({...v,[w]:Object.keys(m).reduce((y,b)=>({...y,[b]:m[b].map(I=>({path:fe(I.linePath,b,n,f,i,w,t.length,l,"diagonal"),colors:I.colors})).filter(I=>I.path!=="")}),{})}),{}),_=D(Object.values(g).filter(v=>v.display),x).map(v=>v.linePath).flat(),$=12,S=d==="sh2020"?3:0;return e.jsx(e.Fragment,{children:e.jsxs("g",{id:"coline",transform:`translate(0,${$+S})`,children:[e.jsx(Ue,{paths:j,direction:i}),e.jsx(Ze,{colineStns:m,branches:x,xs:n,ys:f,stnStates:s,lineWidth:$,colineGap:S}),e.jsx(Je,{stnIds:Object.entries(u).filter(([v,w])=>w<0).reduce((v,[w,y])=>[...v,w],[]).filter(v=>!["linestart","lineend"].includes(v)).filter(v=>l[v].services.length!==0).filter(v=>_.includes(v)),xs:n,ys:f,stnStates:s})]})})},Ue=r=>{const{paths:n,direction:t}=r;return e.jsx(e.Fragment,{children:Object.keys(n).map((s,a)=>{var i,l;return e.jsx("g",{transform:`translate(0,${a*25})`,children:e.jsxs("g",{children:[(i=n[s])==null?void 0:i.pass.map((o,h)=>e.jsx(k.Fragment,{children:e.jsx("path",{stroke:"var(--rmg-grey)",strokeWidth:12,fill:"none",d:o.path,strokeLinejoin:"round",filter:s===C.local?void 0:`url(#contrast-${s})`},h)},h)),(l=n[s])==null?void 0:l.main.map((o,h)=>{var d;return e.jsxs(k.Fragment,{children:[o.colors.length>1&&e.jsx("linearGradient",{id:`grad${h}`,y1:"-100%",y2:"100%",x1:"0",x2:"0",gradientUnits:"userSpaceOnUse",children:o.colors.map((g,x)=>e.jsxs(k.Fragment,{children:[e.jsx("stop",{offset:`${100/o.colors.length*(x+0)}%`,stopColor:g[2]}),e.jsx("stop",{offset:`${100/o.colors.length*(x+1)}%`,stopColor:g[2]})]},x))}),t==="l"&&e.jsx("marker",{id:`arrow_left_${h}_${o.colors.map(g=>g[2]).join("_")}`,refY:.5,refX:1,children:e.jsx("path",{d:"M1,0L0,1H1z",fill:o.colors.length>1?`url(#grad${h})`:o.colors[0][2]})}),t==="r"&&e.jsx("marker",{id:`arrow_right_${h}_${o.colors.map(g=>g[2]).join("_")}`,refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:o.colors.length>1?`url(#grad${h})`:o.colors[0][2]})}),e.jsx("path",{stroke:((d=o.colors.at(-1))!=null?d:Ve)[2],strokeWidth:12,fill:"none",d:o.path,markerStart:t==="l"?`url(#arrow_left_${h}_${o.colors.map(g=>g[2]).join("_")})`:void 0,markerEnd:t==="r"?`url(#arrow_right_${h}_${o.colors.map(g=>g[2]).join("_")})`:void 0,strokeLinejoin:"round",filter:s===C.local?void 0:`url(#contrast-${s})`},h)]},h)})]})},`servicePath${a}`)})})},Ze=r=>{const{colineStns:n,branches:t,xs:s,ys:a,stnStates:i,lineWidth:l,colineGap:o}=r,{line_name:h,theme:d,info_panel_type:g}=M(p=>p.param),x=[...n.main,...n.pass].map(p=>p.linePath.map(u=>{var c;return{curStn:u,x:s[u],y:a[u],color:(c=p.colors.at(-1))!=null?c:[...d,...h]}})).flat().reduce((p,u)=>p.find(c=>c.curStn===u.curStn)?p:p.concat(u),[]).filter(p=>t[0].includes(p.curStn));return console.log(x),e.jsx("g",{id:"stations_in_mainline",children:x.map(p=>{const{curStn:u,x:c,y:f,color:m}=p,j=(i[u]===-1?0:l)+o+l,_=(i[u]===-1?0:-l)-o-l/2;return e.jsx("g",{transform:`translate(${c},${f})`,children:g==="sh2020"?e.jsx("rect",{stroke:"none",height:j,width:12,x:-6,y:_,fill:i[u]===-1?"var(--rmg-grey)":m[2]}):e.jsx("use",{xlinkHref:"#int2_sh",stroke:"var(--rmg-theme-colour)",transform:`translate(0,${-l})`})},u)})})},Je=r=>{const{xs:n,ys:t,stnStates:s,stnIds:a}=r,{branches:i,depsStr:l}=M(p=>p.helper),{line_name:o,theme:h,coline:d}=M(p=>p.param),g=k.useMemo(()=>D(Object.values(d),i),[JSON.stringify(d),l]),x=a.reduce((p,u)=>{var c;return{...p,[u]:(c=g.filter(f=>f.linePath.includes(u)).map(f=>f.colors).flat().at(0))!=null?c:[...h,...o]}},{});return e.jsx("g",{id:"stations_in_coline",children:a.map(p=>e.jsx("g",{transform:`translate(${n[p]},${t[p]})`,children:e.jsx(X,{stnId:p,stnState:s[p],color:x[p][2]})},p))})},qe=()=>{const{routes:r,branches:n,depsStr:t}=M(y=>y.helper),s=M(y=>y.param),{svg_height:a,stn_list:i,branchSpacingPct:l,coline:o,direction:h}=M(y=>y.param),d=he(s.stn_list,()=>0,()=>0),g=R("linestart","lineend",d),x=R(g.nodes[1],g.nodes.slice(-2)[0],d),p=k.useMemo(()=>(console.log("computing x shares"),Object.keys(s.stn_list).reduce((y,b)=>({...y,[b]:de(b,d,n)}),{})),[n.toString(),JSON.stringify(d)]),u=[s.svgWidth.railmap*s.padding/100,s.svgWidth.railmap*(1-s.padding/100)],c=Object.keys(p).reduce((y,b)=>({...y,[b]:u[0]+p[b]/x.len*(u[1]-u[0])}),{}),f=k.useMemo(()=>(console.log("computing y shares"),Object.keys(i).reduce((y,b)=>{if(n[0].includes(b))return{...y,[b]:0};{const I=n.slice(1).filter(O=>O.includes(b))[0];return{...y,[b]:i[I[0]].children.indexOf(I[1])?-3:3}}},{})),[t]),m=Object.entries(f).filter(([,y])=>y>=0).reduce((y,[b,I])=>({...y,[b]:I}),{}),j=Object.keys(m).reduce((y,b)=>({...y,[b]:-m[b]*l*a/300}),{}),_=k.useMemo(()=>me(s.current_stn_idx,r,s.direction),[s.current_stn_idx,s.direction,r.toString()]),$=Object.values(C),S=Object.values(s.stn_list).map(y=>y.services).flat().reduce((y,b)=>(y[$.indexOf(b)]=!0,y),[!1,!1,!1]).map((y,b)=>[$[b],y]).filter(y=>y[1]).map(y=>y[0]),v=n.map(y=>ce(y,_)).reduce((y,b)=>(y.main.push(b.main),y.pass.push(b.pass),y),{main:[],pass:[]}),w=S.reduce((y,b)=>({...y,[b]:Object.keys(v).reduce((I,O)=>({...I,[O]:v[O].map(N=>fe(N,O,c,j,h,b,S.length,i)).filter(N=>N!=="")}),{})}),{});return e.jsxs("g",{id:"main",transform:`translate(0,${s.svg_height*(Object.keys(o).length>0?.5:.7+.1)})`,children:[e.jsx(Ke,{paths:w,direction:s.direction}),e.jsx(Qe,{stnIds:Object.keys(m).filter(y=>!["linestart","lineend"].includes(y)).filter(y=>i[y].services.length!==0),xs:c,ys:j,stnStates:_}),Object.keys(o).length>0&&e.jsx(Xe,{xs:c,servicesPresent:S,stnStates:_}),S.length>1&&e.jsx(et,{servicesLevel:S,lineXs:u})]})},Ke=r=>{const{theme:n}=M(a=>a.param),{paths:t,direction:s}=r;return e.jsx(e.Fragment,{children:Object.keys(t).map((a,i)=>{var l,o;return e.jsxs("g",{transform:`translate(0,${i*25})`,filter:n[2]==="#999999"?"url(#pujiang_outline_railmap)":void 0,children:[e.jsx("g",{children:(l=t[a])==null?void 0:l.pass.map((h,d)=>e.jsx("path",{stroke:"var(--rmg-grey)",strokeWidth:12,fill:"none",d:h,markerStart:r.direction==="l"?"url(#arrow_gray)":void 0,markerEnd:r.direction==="r"?"url(#arrow_gray)":void 0,strokeLinejoin:"round"},d))}),e.jsx("g",{children:(o=t[a])==null?void 0:o.main.map((h,d)=>e.jsx("path",{stroke:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:h,markerStart:s==="l"?"url(#arrow_theme_left)":void 0,markerEnd:s==="r"?"url(#arrow_theme_right)":void 0,strokeLinejoin:"round",filter:a===C.local?void 0:`url(#contrast-${a})`},d))})]},`servicePath${i}`)})})},fe=(r,n,t,s,a,i,l,o,h="rightangle")=>{let[d,g]=[];const x={},p={local:0,express:20,direct:40}[i],u=l>1?50:0;let c=30;if(r.length>0){let m=!1,j=!1;o[r.at(-1)||0].children.some(_=>["linestart","lineend"].includes(_))?j=!0:o[r.at(0)||0].parents.some(_=>["linestart","lineend"].includes(_))&&(m=!0),c=m||j?c:0}const f=30;if(r.forEach(m=>{const j=t[m],_=s[m];if(!d&&d!==0){[g,d]=[j,_],x.start=[j,_];return}_===0?_!==d&&(x.bifurcate=[g,d]):_!==d&&(x.bifurcate=[j,_]),x.end=[j,_],[g,d]=[j,_]}),"start"in x)if("end"in x)if("bifurcate"in x){const[m,j]=x.start,_=x.bifurcate[0],[$,S]=x.end;return n==="main"?a==="l"?S>j?(console.log(x),h==="rightangle"?`M ${m-c},${j} H ${$} V ${S}`:`M ${m},${j} H ${m+f} L ${_-f},${S} H ${$}`):h==="rightangle"?`M ${m},${j} V ${S} H ${$}`:`M ${m-c},${j} H ${_+f} L ${$-f},${S} H ${$}`:S>j?h==="rightangle"?`M ${m},${j} H ${$} V ${S}`:`M ${m},${j} H ${m+f} L ${_-f},${S} H ${$+c}`:h==="rightangle"?`M ${m},${j} V ${S} H ${$+c}`:`M ${m},${j} H ${_+f} L ${$-f},${S} H ${$}`:a==="l"?S>j?h==="rightangle"?`M ${m-c},${j} H ${$} V ${S}`:`M ${m},${j} H ${m+f} L ${_-f},${S} H ${$+c}`:h==="rightangle"?`M ${m},${j} V ${S} H ${$+c}`:`M ${m-c},${j} H ${_+f} L ${$-f},${S} H ${$}`:S>j?h==="rightangle"?`M ${m-c},${j} H ${$} V ${S}`:`M ${m},${j} H ${m+f} L ${_-f},${S} H ${$+c}`:h==="rightangle"?`M ${m},${j} V ${S} H ${$+c}`:`M ${m-c},${j} H ${_+f} L ${$-f},${S} H ${$}`}else{const[m,j]=x.start,_=x.end[0];return n==="main"?a==="l"?`M ${m-c-p},${j} H ${_}`:`M ${m},${j} H ${_+c+p}`:a==="l"?`M ${m-c},${j} H ${_+c+u}`:`M ${m-c-u},${j} H ${_+c}`}else{const[m,j]=x.start;return n==="main"?a==="l"?`M ${m-c-p},${j} H ${m}`:`M ${m},${j} H ${m+c+p}`:a==="l"?`M ${m},${j} L ${m+c+u},${j}`:`M ${m-c-u},${j} L ${m},${j}`}else return""},Qe=r=>{const{xs:n,ys:t,stnStates:s,stnIds:a}=r;return e.jsx("g",{children:a.map(i=>e.jsx("g",{transform:`translate(${n[i]},${t[i]})`,children:e.jsx(X,{stnId:i,stnState:s[i]})},i))})},et=r=>{const{svg_height:n,direction:t,svgWidth:s}=M(h=>h.param),a=-n+130,i=r.servicesLevel.map(h=>({local:"普通车",express:"大站车",direct:"直达车"})[h]),l=t==="r"?r.lineXs[0]-42:r.lineXs[1]+42,o=r.servicesLevel.length===2?350:500;return k.useMemo(()=>e.jsxs("g",{children:[i.map((h,d)=>e.jsxs("g",{transform:`translate(${l},${d*25})`,children:[e.jsx("rect",{x:-27.5,height:10,width:55,fill:"white",stroke:"black",y:-5}),e.jsx("text",{className:"rmg-name__zh",fontSize:9,y:3,textAnchor:"middle",children:`${h}运行线`})]},h)),e.jsxs("g",{transform:`translate(${t==="r"?30:s.railmap-o},${a})`,children:[e.jsx("text",{className:"rmg-name__zh",children:"图例："}),i.map((h,d)=>e.jsxs("g",{transform:`translate(${d*150+50},0)`,children:[e.jsx("line",{x1:"0",x2:"35",y1:"-5",y2:"-5",stroke:"var(--rmg-theme-colour)",strokeWidth:"12",filter:d===2?"url(#contrast-direct)":d===1?"url(#contrast-express)":""}),e.jsx("use",{x:"17.5",y:"-5",xlinkHref:"#stn_sh",fill:"var(--rmg-theme-colour)"}),e.jsx("text",{x:"40",className:"rmg-name__zh",children:`${h}停靠站`})]},`serviceLevel${d}`))]})]}),[n,t,s,r.servicesLevel,r.lineXs])},tt=()=>{const{direction:r,svgWidth:n,coline:t}=M(a=>a.param),s=!!Object.keys(t).length;return k.useMemo(()=>e.jsxs("g",{transform:`translate(${r==="l"?50:n.railmap-150},50)`,children:[e.jsx("text",{className:"rmg-name__zh",children:"列车前进方向"}),e.jsx("path",{d:"M60,60L0,0L60-60H100L55-15H160V15H55L100,60z",stroke:s?"var(--rmg-black)":void 0,strokeWidth:s?5:void 0,fill:s?"var(--rmg-white)":"var(--rmg-theme-colour)",transform:`translate(${r==="l"?-30:125},-5)rotate(${r==="l"?0:180})scale(0.15)`})]}),[r,t,n.railmap])},Z=r=>{const{stnId:n,nameDirection:t,services:s,color:a}=r,i=M(d=>d.param.stn_list[n]),l=[...i.transfer.info[0],...i.transfer.info[1]||[]];let o;i.services.length===3?o="direct_indoor_sh":i.services.length===2?o="express_indoor_sh":l.length>0?o="int2_indoor_sh":o="stn_indoor_sh";const h=t==="left"||t==="right"?90:0;return e.jsxs(e.Fragment,{children:[e.jsx(nt,{name:i.name,infos:i.transfer.info,nameDirection:t,services:s}),e.jsx("use",{xlinkHref:`#${o}`,stroke:l.length>0?"var(--rmg-black)":a!=null?a:"var(--rmg-theme-colour)",transform:`rotate(${h})`}),i.services.length>1&&e.jsx("text",{className:"rmg-name__zh",writingMode:"tb",fontSize:"60%",dy:"-12",children:`大站车${i.services.length>2?" 直达车":""}停靠`})]})},nt=r=>{var g,x,p,u,c,f,m,j;const{name:n,infos:t,nameDirection:s,services:a}=r,i={upward:60,downward:-30,left:0,right:0}[s],l={upward:0,downward:0,left:85,right:-85}[s],o={upward:-185,downward:150+(a.length===3?40:0),left:-30,right:-30}[s],h=((g=t[2])==null?void 0:g.length)>0?{upward:0,downward:0,left:t[0].length+t[1].length!==0?85:25,right:t[0].length+t[1].length!==0?-85:-25}[s]:0,d=((x=t[2])==null?void 0:x.length)>0?{upward:(p=t[1])!=null&&p.length?-210:t[0].length?-180:-100,downward:((u=t[1])!=null&&u.length?190:t[0].length?160:100)+(a.length===3?40:0),left:(c=t[1])!=null&&c.length?-60:t[0].length?-30:0,right:(f=t[1])!=null&&f.length?-60:t[0].length?-30:0}[s]:0;return e.jsxs("g",{transform:`translate(0,${i})`,children:[s==="upward"||s==="downward"?e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:-30,x2:30,y1:s==="upward"?-23:-10,y2:s==="upward"?-23:-10,stroke:"black"}),e.jsx("line",{y1:s==="upward"?-23:-10,y2:s==="upward"?-23-25:20,stroke:"black"})]}):e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:s==="left"?-50:15,x2:s==="left"?-15:50,y1:0,y2:0,stroke:"black"}),e.jsx("line",{x1:s==="left"?-50:50,x2:s==="left"?-50:50,y1:-30,y2:30,stroke:"black"})]}),[...t[0],...t[1]||[]].length>0&&e.jsx(rt,{intInfos:[...t[0],...t[1]||[]],arrowDirection:s,services:a}),e.jsx(st,{stnName:n,nameDirection:s,fill:"black"}),((m=t[1])==null?void 0:m.length)>0&&e.jsx("g",{transform:`translate(${l},${o})`,children:e.jsx(it,{osiInfos:t[1],nameDirection:s})}),((j=t[2])==null?void 0:j.length)>0&&e.jsx("g",{transform:`translate(${h},${d})`,children:e.jsx(lt,{osysiInfos:t[2],nameDirection:s})})]})},st=k.forwardRef(function(n,t){const{stnName:s,nameDirection:a,...i}=n,l=s[0].split("\\"),o=s[1].split("\\").length,h={upward:0,downward:0,left:-60,right:60}[a],d={upward:-2,downward:-30-12*(o-1),left:-10*(o-1),right:-10*(o-1)}[a],g={upward:"middle",downward:"middle",left:"end",right:"start"}[a];return e.jsx("g",{ref:t,...i,textAnchor:g,transform:`translate(${h},${d})`,children:k.useMemo(()=>e.jsxs(e.Fragment,{children:[l.map((x,p,u)=>e.jsx("text",{className:"rmg-name__zh",dy:a==="upward"?16*p:(u.length-1-p)*-16,children:x},p)),e.jsx("g",{fontSize:9.6,children:s[1].split("\\").map((x,p)=>e.jsx("text",{className:"rmg-name__en",dy:12*(p+1)+(a==="upward"&&l.length>1?l.length*7.5:0),children:x},p))})]}),[...s])})}),rt=r=>{const{intInfos:n,arrowDirection:t,services:s}=r,a=n.map(c=>c[2]).reduce((c,f)=>c+f,""),i=[n.filter(c=>c[4].match(/^\d+.*$/)).map(c=>c[4].replace(/^(\d+)(.*)$/,"$1")).join("，").concat("号线"),n.filter(c=>!c[4].match(/^\d+.*$/)).map(c=>c[4]).join("，")].filter(c=>c&&c!=="号线").join("，"),l=["Line ".concat(n.filter(c=>c[5].match(/^(L|l)ine$/)).map(c=>c[5].replace("Line","").replace("line","").trim()).join(",")),n.filter(c=>!c[5].match(/^(L|l)ine$/)).map(c=>c[5]).join("，")].filter(c=>c&&c!=="Line ").join(","),o=s.length===3?80:45,h={upward:-145,downward:125+(s.length===3?40:0),left:7,right:7}[t],d={upward:0,downward:0,left:20,right:-20}[t],g={upward:-74,downward:44,left:0,right:0}[t],x={upward:0,downward:180,left:90,right:-90}[t],p={upward:0,downward:0,left:85,right:-85}[t],u={upward:"middle",downward:"middle",left:"start",right:"end"}[t];return e.jsxs("g",{children:[e.jsx("path",{id:"int_indoor_arrow_sh",stroke:"var(--rmg-black)",strokeWidth:1,transform:`translate(${d},${g})rotate(${x})`,fill:n.length===1?n[0][2]:`url(#grad${a})`,d:`M -7.5,0 v -${o} h -7.5 l 15,-15 l 15,15 h -7.5 v ${o} Z`}),n.length>1&&e.jsx(e.Fragment,{children:e.jsx("linearGradient",{id:`grad${a}`,y1:"0",y2:"0",x1:t==="upward"?"25%":"75%",x2:t==="upward"?"75%":"25%",children:n.map((c,f)=>e.jsxs(k.Fragment,{children:[e.jsx("stop",{offset:`${100/n.length*f}%`,stopColor:c[2]}),e.jsx("stop",{offset:`${100/n.length*(f+1)}%`,stopColor:c[2]})]},f))})}),e.jsxs("g",{transform:`translate(${p},${h})`,textAnchor:`${u}`,children:[e.jsx("text",{className:"rmg-name__zh",dy:-7,children:`换乘${i}`}),e.jsx("text",{className:"rmg-name__en",dy:5,fontSize:9.6,children:`Interchange ${l}`})]})]})},it=r=>{const n={upward:"middle",downward:"middle",left:"start",right:"end"}[r.nameDirection];return k.useMemo(()=>e.jsxs("g",{textAnchor:`${n}`,fontSize:"50%",children:[e.jsx("text",{className:"rmg-name__zh",dy:-5,children:`换乘${r.osiInfos.map(t=>t[4]).join("，")}`}),e.jsx("text",{className:"rmg-name__zh",dy:5,children:"仅限公共交通卡"}),e.jsx("text",{className:"rmg-name__en",dy:12.5,fontSize:"75%",children:"Only for Public Transportation Card"})]}),[r.osiInfos.toString(),r.nameDirection])},lt=r=>{const n={upward:"middle",downward:"middle",left:"start",right:"end"}[r.nameDirection];return k.useMemo(()=>e.jsxs("g",{textAnchor:`${n}`,children:[e.jsx("text",{className:"rmg-name__zh",dy:-5,children:`转乘${r.osysiInfos.map(t=>t[4]).join("，")}`}),e.jsx("text",{className:"rmg-name__en",dy:7.5,fontSize:9.6,children:`To ${r.osysiInfos.map(t=>t[5]).join(", ")}`})]}),[r.osysiInfos.toString(),r.nameDirection])},at=(r,n,t,s,a,i)=>{var p,u,c,f;const l=r[0].filter(m=>!["linestart","lineend"].includes(m)),o=r.slice(1,3).map(m=>m.slice(1,m.length-1)),h=o.reduce((m,j)=>m+j.filter(_=>!["linestart","lineend",...n].includes(_)).length,0)+l.length-i-a*2,d=(t-t*s/100*2)/(1+h),g=[t*s/100+((p=o.at(0))!=null?p:[]).length*d,t*(1-s/100)-((u=o.at(1))!=null?u:[]).length*d],x={...Object.fromEntries(((c=o.at(0))!=null?c:[]).map((m,j)=>[m,t*s/100+j*d])),...Object.fromEntries(((f=o.at(1))!=null?f:[]).map((m,j)=>[m,g[1]+(1+j)*d]))};return{loop_branches:o,line_xs_branches:g,xs_branches:x}},ot=r=>{var _,$,S,v;const{loop_branches:n,edges:t,xs:s,ys:a,canvas:i}=r,[l,o,h,d]=t,{branches:g}=M(w=>w.helper),{current_stn_idx:x,direction:p,coline:u}=M(w=>w.param),c=i===z.RailMap?30:0,f=[`M ${l},${h} H ${Number(s[($=(_=n.at(0))==null?void 0:_.at(0))!=null?$:""])-c}`,`M ${o},${h} H ${Number(s[(v=(S=n.at(1))==null?void 0:S.at(-1))!=null?v:""])+c}`],m=g[0].filter(w=>!["linestart","lineend"].includes(w)),j=Object.values(u).filter(w=>![w.from,w.to].every(y=>m.includes(y))).map(w=>w.colors);return e.jsx(e.Fragment,{children:n.map((w,y)=>{var b,I,O;return e.jsxs(Q.Fragment,{children:[j.filter((N,W,T)=>W===T.findIndex(P=>{var E,B;return((E=P.at(0))==null?void 0:E.at(2))===((B=N.at(0))==null?void 0:B.at(2))})).map(N=>e.jsx("marker",{id:`arrow_theme_${N[0][2]}`,refX:1,refY:.5,children:e.jsx("path",{d:"M0,1H2L1,0z",fill:N[0][2]})},N[0][2])),e.jsx("path",{stroke:(O=(I=(b=j.at(y))==null?void 0:b.at(0))==null?void 0:I.at(2))!=null?O:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:f[y],markerEnd:i===z.RailMap&&(p==="l"&&y===0||p==="r"&&y===1)?j.at(y)?`url(#arrow_theme_${j[y][0][2]})`:"url(#arrow_theme)":void 0}),w.filter(N=>!["linestart","lineend"].includes(N)).map(N=>{var W,T,P,E;return e.jsxs(Q.Fragment,{children:[i===z.RailMap&&e.jsx("g",{transform:`translate(${s[N]},${a[N]})`,children:e.jsx(X,{stnId:N,stnState:x===N?0:1,bank:0,direction:p,color:(T=(W=j.at(y))==null?void 0:W.at(0))==null?void 0:T.at(2)})},N),i===z.Indoor&&e.jsx("g",{transform:`translate(${s[N]},${a[N]})`,children:e.jsx(Z,{stnId:N,nameDirection:n.filter(B=>B.includes(N)).map(B=>B.indexOf(N)%2===0?"downward":"upward")[0],services:[C.local],color:(E=(P=j.at(y))==null?void 0:P.at(0))==null?void 0:E.at(2)})},N)]},N)})]},w.at(0))})})},ct=r=>{var j;const{edges:n,loop_stns:t,xs:s,ys:a,canvas:i}=r,[l,o,h,d]=n,{info_panel_type:g,stn_list:x,coline:p}=M(_=>_.param),{branches:u}=M(_=>_.helper),c=Object.values(p).filter(_=>[_.from,_.to].every($=>u.slice(1,3).filter(S=>Y(S,x)).flat().includes($))).map(_=>_.colors).at(0),f=12,m=i===z.RailMap&&g==="sh2020"?3:0;return e.jsxs("g",{id:"coline_main",children:[e.jsx("path",{d:`M ${l},${h} H${o}`,strokeWidth:12,stroke:(j=c==null?void 0:c.at(0))==null?void 0:j.at(2)}),i===z.RailMap&&Object.keys(p).length>0&&t.top.map(_=>{var $;return e.jsx("g",{transform:`translate(${s[_]},${a[_]})`,children:g==="sh2020"?e.jsxs(e.Fragment,{children:[e.jsx("rect",{stroke:"none",height:24,width:12,x:-6,y:-m-1,fill:($=c==null?void 0:c.at(0))==null?void 0:$.at(2)}),e.jsx("rect",{stroke:"none",height:m+f,width:12,x:-6,y:f-2,fill:"var(--rmg-theme-colour)"})]}):e.jsx("use",{xlinkHref:"#int2_sh",stroke:"var(--rmg-theme-colour)",transform:`translate(0,${1+f})`})},_)})]})},ue=r=>{var K;const{bank_angle:n,canvas:t}=r,{branches:s}=M(H=>H.helper),{current_stn_idx:a,svgWidth:i,svg_height:l,padding:o,branchSpacingPct:h,direction:d,info_panel_type:g,stn_list:x,loop_info:{left_and_right_factor:p,bottom_factor:u},coline:c}=M(H=>H.param),f=s[0].filter(H=>!["linestart","lineend"].includes(H)),m=s.slice(0,3).flat().filter((H=>L=>(H[L]=(H[L]||0)+1)===2)({})).filter(H=>!["linestart","lineend"].includes(H)),j=(K=Object.values(c).filter(H=>[H.from,H.to].every(L=>s.slice(1,3).filter(A=>Y(A,x)).flat().includes(L))).map(H=>{const L=f.findIndex(U=>U===H.from),A=f.findIndex(U=>U===H.to);return Math.abs(A-L)>f.length-2-Math.abs(A-L)?"major":"minor"}).at(0))!=null?K:"minor",_=m.at(1)?_e(f,m,p,j):m.at(0)?xe(f,m[0],u,p):je(f,a,u,p),{x_shares:$,y_shares:S}=$e(f,_),{loop_branches:v,line_xs_branches:w,xs_branches:y}=at(s,m,i[t],o,p,_.bottom.length),b={...S,...Object.fromEntries(v.flat().map(H=>[H,0]))},I=h*l/300,O=[225+I,l-75-(t===z.RailMap?0:125)-I],N=Object.keys(b).reduce((H,L)=>({...H,[L]:O[0]+b[L]*(O[1]-O[0])}),{}),W=[Math.max(i[t]*o/100+(n&&t===z.RailMap?100:0),w[0]),Math.min(i[t]*(1-o/100)-(n&&t===z.RailMap?100:0),w[1])],T=Object.keys($).reduce((H,L)=>({...H,[L]:W[0]+$[L]*(W[1]-W[0])}),{}),P=n?{l:1,r:-1}[d]:0;[..._.right,..._.left].forEach(H=>{T[H]-=(N[H]-O[0])*P}),_.bottom.forEach(H=>{T[H]-=(O[1]-O[0])*P});const E={...y,...T},B=ht(_,E,N,P,[...W,...O],d),J=12,q=t===z.RailMap&&g==="sh2020"?3:0;Object.keys(c).length>0&&_.top.forEach(H=>{N[H]-=q+J});const pe=v.length?0:(O[1]-O[0])*P/2;return e.jsxs("g",{id:"loop",transform:`translate(${pe},0)`,children:[e.jsx("path",{stroke:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:B,strokeLinejoin:"round"}),t===z.RailMap&&e.jsx(le,{canvas:t,loop_stns:_,xs:E,ys:N}),e.jsxs("g",{transform:`translate(0,${Object.keys(c).length>0?-J-q:0})`,children:[e.jsx(ot,{loop_branches:v,edges:[...W,...O],xs:E,ys:N,canvas:t}),Object.keys(c).length>0&&e.jsx(ct,{edges:[...W,...O],loop_stns:_,xs:E,ys:N,canvas:t})]}),t===z.Indoor&&e.jsx(le,{canvas:t,loop_stns:_,xs:E,ys:N})]})},ht=(r,n,t,s,a,i)=>{const[l,o,h,d]=a,g=(u,c,f,m,j)=>({right:[f+(m-h)*s,c],bottom:[u-(d-c)*s,m],left:[f-(d-m)*s,c],top:[u+(c-h)*s,m]})[j],x=[];r.top.forEach(u=>{x.push([n[u],t[u]])}),["right","bottom","left"].forEach(u=>{if(r[u].length>0)x.push(g(x.at(-1)[0],x.at(-1)[1],n[r[u][0]],t[r[u][0]],u)),r[u].forEach(c=>{x.push([n[c],t[c]])});else{const c={right:[o,x.at(-1)[1]],bottom:[x.at(-1)[0]+(d-x.at(-1)[1])*-s,x.at(-1)[1]+(d-x.at(-1)[1])],left:[l+(s===0?0:(d-h)*(i==="l"?-1:1)),x.at(-1)[1]]};x.push(c[u])}}),x.push(g(x.at(-1)[0],x.at(-1)[1],n[r.top[0]],t[r.top[0]],"top"));const p=x.slice(1).map(([u,c])=>`L${u},${c} `).join(" ");return`M${x[0][0]},${x[0][1]} ${p} Z`},le=r=>{const{canvas:n,loop_stns:t,xs:s,ys:a}=r,{current_stn_idx:i}=M(d=>d.param),l={top:0,bottom:0,left:-1,right:1},o={left:"r",right:"l",top:void 0,bottom:void 0},h=(d,g)=>({top:g%2===0?"upward":"downward",bottom:g%2===0?"upward":"downward",left:"left",right:"right"})[d];return e.jsxs("g",{id:"loop_stations",children:[n===z.RailMap&&Object.entries(t).map(([d,g])=>g.map(x=>e.jsx("g",{transform:`translate(${s[x]},${a[x]})`,children:e.jsx(X,{stnId:x,stnState:i===x?0:1,bank:l[d],direction:o[d]})},x))),n===z.Indoor&&Object.entries(t).map(([d,g])=>g.map((x,p)=>e.jsx("g",{transform:`translate(${s[x]},${a[x]})`,children:e.jsx(Z,{stnId:x,nameDirection:h(d,p),services:[C.local]})},x)))]})},ae=z.RailMap;function dt(){const{canvasScale:r}=M(o=>o.app),{svgWidth:n,svg_height:t,theme:s,loop:a,loop_info:{bank:i}}=M(o=>o.param),l=n[ae];return e.jsxs(V,{type:ae,svgWidth:l,svgHeight:t,canvasScale:r,theme:s,children:[e.jsx(mt,{}),a?e.jsx(ue,{bank_angle:i,canvas:z.RailMap}):e.jsx(qe,{}),e.jsx(tt,{})]})}const mt=k.memo(function(){return e.jsxs("defs",{children:[e.jsx("circle",{id:"stn_sh",fill:"var(--rmg-white)",strokeWidth:2,r:5}),e.jsx("path",{id:"int2_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V10 a 5,5 0 1 1 -10,0Z"}),e.jsx("path",{id:"express_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V25 a 5,5 0 1 1 -10,0Z"}),e.jsx("path",{id:"direct_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V50 a 5,5 0 1 1 -10,0Z"}),e.jsx("rect",{id:"stn_sh_2020",stroke:"none",height:24,width:12,x:-6,y:-18}),e.jsx("rect",{id:"stn_sh_2020_express",stroke:"none",height:49,width:12,x:-6,y:-18}),e.jsx("rect",{id:"stn_sh_2020_direct",stroke:"none",height:74,width:12,x:-6,y:-18}),e.jsx("rect",{id:"intbox_number",height:22,width:20,y:-11}),e.jsxs("g",{id:"intbox_maglev",transform:"translate(-25,0)",children:[e.jsx("rect",{id:"maglev_5",height:144,width:130,y:"40",x:"30",strokeWidth:10}),e.jsx("path",{id:"maglev_3",fill:"var(--rmg-white)",d:"m90,55a40,5 0 0 0 -40,3a5,5 0 0 0 -5,5a5,60 0 0 0 -3,60a5,5 0 0 0 5,5l96,0a5,5 0 0 0 5,-5a5,60 0 0 0 -3,-60a5,5 0 0 0 -5,-5a40,5 0 0 0 -40,-3l-5,-10l-5,10"}),e.jsx("path",{id:"maglev_4",fill:"var(--rmg-white)",d:"m90,140l-40,0a10,5 0 0 1 -10,-5l0,25a10,15 0 0 0 10,15l15,0l0,-10l-15,0l0,-15l90,0l0,15l-15,0l0,10l15,0a10,15 0 0 0 10,-15l0,-25a10,5 0 0 1 -10,5l-50,0"}),e.jsx("rect",{id:"maglev_1",height:"25",width:"40",y:"80",x:"50"}),e.jsx("rect",{id:"maglev_2",height:"25",width:"40",y:"80",x:"100"})]}),e.jsxs("g",{id:"airport",transform:"scale(0.5)",children:[e.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)"}),e.jsx("path",{id:"airport",d:"M28.9769,6.60134c1.711.013,3.111,2.53205,3.111,4.241v10.337s17.106,15.435,17.358,15.666a1.145,1.145,0,0,1,.488,1.152v2.833c0,.651-.451.61-.695.467-.334-.119-17.151-8.863-17.151-8.863-.004,1.458-.797,9.006-1.326,13.304,0,0,4.61,2.457,4.699,2.521.334.268.352.359.352.852v2.001c0,.477-.352.428-.51.324-.183-.062-5.693-1.921-5.693-1.921a2.56018,2.56018,0,0,0-.633-.127,2.31654,2.31654,0,0,0-.666.127s-5.477,1.859-5.672,1.921c-.185.104-.523.153-.523-.324v-2.001c0-.493.029-.584.367-.852.086-.064,4.678-2.521,4.678-2.521-.524-4.298-1.307-11.846-1.325-13.304,0,0-16.822,8.744-17.148,8.863-.217.143-.69.184-.69-.467v-2.833a1.16206,1.16206,0,0,1,.473-1.152c.276-.231,17.365-15.666,17.365-15.666v-10.337c0-1.709,1.403-4.228,3.14105-4.241",transform:"translate(-28.9697,0.14347)",fill:"var(--rmg-white)"})]}),e.jsxs("g",{id:"disney",transform:"scale(0.5)",children:[e.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)"}),e.jsx("path",{fill:"var(--rmg-white)",d:"M45.6152,7.85015a9.80248,9.80248,0,0,0-9.79907,9.801,9.70059,9.70059,0,0,0,.342,2.582c.002.026.002.055.002.093a.31815.31815,0,0,1-.31494.318.67741.67741,0,0,1-.12806-.02,15.71521,15.71521,0,0,0-13.498,0,.61.61,0,0,1-.122.02.31841.31841,0,0,1-.322-.318v-.067a9.62553,9.62553,0,0,0,.35608-2.608,9.803,9.803,0,1,0-9.797,9.8,10.10364,10.10364,0,0,0,2.308-.271h.05493a.31113.31113,0,0,1,.31409.318.32433.32433,0,0,1-.019.12,15.72588,15.72588,0,1,0,29.703,7.216,15.83676,15.83676,0,0,0-1.746-7.23.18417.18417,0,0,1-.0271-.106.31612.31612,0,0,1,.32007-.318h.057a10.15953,10.15953,0,0,0,2.316.271,9.80051,9.80051,0,0,0,0-19.601",transform:"translate(-28.9697 0.13398)"})]}),e.jsxs("g",{id:"railway",children:[e.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)",transform:"translate(0,-2)scale(0.5)"}),e.jsx("path",{fill:"var(--rmg-white)",d:"M169,273.5c0-19,14.7-34.8,33.7-36.3c18.9-1.5,38.1-2.2,57.4-2.2c19.3,0,38.4,0.8,57.3,2.2  c19,1.5,33.7,17.3,33.7,36.3v47.3l-51.3,14.7c-11.2,3.2-18.9,13.4-18.9,25v147.8c0,17.4,12.2,32.3,29.3,35.7l110.6,22.1  c4.9,1,8.4,5.2,8.4,10.2V599H91v-22.7c0-5,3.5-9.2,8.4-10.2L209.9,544c17-3.4,29.3-18.3,29.3-35.7V360.5c0-11.6-7.7-21.8-18.9-25  L169,320.8V273.5z M309.4,31.7c0.2-1.2,0.3-2.4,0.3-3.6c0-14-11.1-25.4-24.9-26C276.6,1.4,268.3,1,260,1c-8.3,0-16.6,0.4-24.7,1.1  c-13.9,0.6-24.9,12-24.9,26c0,1.2,0.1,2.5,0.3,3.6C90.6,54.8,0,160.3,0,287c0,97.2,53.4,182,132.4,226.6l36.8-48.1  C104.3,432.4,59.8,364.9,59.8,287c0-110.6,89.6-200.2,200.2-200.2S460.2,176.4,460.2,287c0,77.9-44.5,145.4-109.4,178.5  c15,19.6,25.6,33.5,36.8,48.1C466.6,469,520,384.2,520,287C520,160.3,429.4,54.8,309.4,31.7z",transform:"translate(-10,0)scale(0.04)"})]}),e.jsx("marker",{id:"arrow_gray",viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-grey)"})}),e.jsx("marker",{id:"arrow_theme_left",refX:1,refY:.5,children:e.jsx("path",{d:"M1,0L0,1H1z",fill:"var(--rmg-theme-colour)"})}),e.jsx("marker",{id:"arrow_theme_right",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})}),e.jsx("marker",{id:"arrow_theme",refX:1,refY:.5,children:e.jsx("path",{d:"M0,1H2L1,0z",fill:"var(--rmg-theme-colour)"})}),e.jsx("filter",{id:"contrast-direct",filterUnits:"userSpaceOnUse",children:e.jsxs("feComponentTransfer",{children:[e.jsx("feFuncR",{type:"linear",slope:.5,intercept:.25}),e.jsx("feFuncG",{type:"linear",slope:.5,intercept:.25}),e.jsx("feFuncB",{type:"linear",slope:.5,intercept:.25})]})}),e.jsx("filter",{id:"contrast-express",filterUnits:"userSpaceOnUse",children:e.jsxs("feComponentTransfer",{children:[e.jsx("feFuncR",{type:"linear",slope:.75,intercept:.125}),e.jsx("feFuncG",{type:"linear",slope:.75,intercept:.125}),e.jsx("feFuncB",{type:"linear",slope:.75,intercept:.125})]})}),e.jsxs("filter",{id:"pujiang_outline_railmap",colorInterpolationFilters:"sRGB",filterUnits:"userSpaceOnUse",x:"0",y:"-1000",width:"5000",height:"2000",children:[e.jsxs("feComponentTransfer",{in:"SourceGraphic",children:[e.jsx("feFuncR",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"}),e.jsx("feFuncG",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"}),e.jsx("feFuncB",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"})]}),e.jsx("feColorMatrix",{type:"matrix",values:`1 0 0 0 0
                                                 0 1 0 0 0
                                                 0 0 1 0 0
                                                 1 1 1 1 -3`,result:"selectedColor1"}),e.jsx("feMorphology",{operator:"erode",in:"selectedColor1",radius:"0",result:"e1"}),e.jsx("feMorphology",{operator:"erode",in:"selectedColor1",radius:"1",result:"e2"}),e.jsx("feComposite",{in:"e1",in2:"e2",operator:"xor",result:"uncoloredOutline"}),e.jsx("feFlood",{floodColor:"rgb(0,0,0)"}),e.jsx("feComposite",{operator:"in",in2:"uncoloredOutline",result:"outline"}),e.jsx("feComposite",{in:"outline",in2:"selectedColor1",operator:"over",result:"result"}),e.jsx("feComposite",{in:"result",in2:"SourceGraphic",operator:"over"})]})]})}),oe=z.Indoor;function xt(){const{canvasScale:r}=M(l=>l.app),{svgWidth:n,svg_height:t,theme:s,loop:a}=M(l=>l.param),i=n[oe];return e.jsxs(V,{type:oe,svgWidth:i,svgHeight:t,canvasScale:r,theme:s,children:[e.jsx(gt,{}),a?e.jsx(ue,{bank_angle:!1,canvas:z.Indoor}):e.jsx(pt,{}),e.jsx($t,{})]})}const gt=k.memo(function(){return e.jsxs("defs",{children:[e.jsx("circle",{id:"stn_indoor_sh",fill:"var(--rmg-white)",strokeWidth:5,r:8,transform:"scale(1.5)"}),e.jsx("path",{id:"int2_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V10 a 5,5 0 1 1 -10,0Z"}),e.jsx("path",{id:"express_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V25 a 5,5 0 1 1 -10,0Z"}),e.jsx("path",{id:"direct_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V40 a 5,5 0 1 1 -10,0Z"})]})}),ft=(r,n)=>{let t=0;return r[n].parents.length===2&&(t+=1),r[r[n].parents[0]].children.length===2&&(t+=1),t},ut=(r,n)=>{let t=0;return r[n].children.length===2&&(t+=1),r[r[n].children[0]].parents.length===2&&(t+=1),t},pt=()=>{const{routes:r,branches:n,depsStr:t}=M(m=>m.helper),s=M(m=>m.param),a=he(s.stn_list,ft,ut),i=R("linestart","lineend",a),l=R(i.nodes[1],i.nodes.slice(-2)[0],a),o=k.useMemo(()=>(console.log("computing x shares"),Object.keys(s.stn_list).reduce((m,j)=>({...m,[j]:de(j,a,n)}),{})),[n.toString(),JSON.stringify(a)]),h=[s.svgWidth.indoor*s.padding/100,s.svgWidth.indoor*(1-s.padding/100)],d=Object.keys(o).reduce((m,j)=>({...m,[j]:h[0]+o[j]/l.len*(h[1]-h[0])}),{}),g=k.useMemo(()=>te.getYShares(s.stn_list,n),[t]),x=Object.keys(g).reduce((m,j)=>({...m,[j]:g[j]*s.branchSpacingPct*s.svg_height/200}),{}),p=k.useMemo(()=>me(s.current_stn_idx,r,s.direction),[s.current_stn_idx,s.direction,r.toString()]),u=Object.values(C),c=Object.values(s.stn_list).map(m=>m.services).flat().reduce((m,j)=>(m[u.indexOf(j)]=!0,m),[!1,!1,!1]).map((m,j)=>[u[j],m]).filter(m=>m[1]).map(m=>m[0]),f=te.drawLine(n,p,s.stn_list,h,d,x,s.branchSpacingPct*s.svg_height/200,i,0);return e.jsxs("g",{id:"main",transform:`translate(0,${s.svg_height/2})`,children:[e.jsx(jt,{paths:f,services:c}),e.jsx(_t,{xs:d,ys:x,services:c})]})},jt=r=>e.jsx("g",{fill:"none",strokeWidth:12,stroke:"var(--rmg-theme-colour)",children:r.services.map((n,t)=>e.jsxs("g",{transform:`translate(0, ${t*30})`,children:[r.paths.main.map((s,a)=>e.jsx("path",{d:s},a)),r.paths.pass.map((s,a)=>e.jsx("path",{d:s},a))]},`indoor_line_${t}`))}),_t=r=>{const{branches:n}=M(l=>l.helper),t=M(l=>l.param),{xs:s,ys:a,services:i}=r;return e.jsx("g",{children:Object.keys(t.stn_list).filter(l=>!["linestart","lineend"].includes(l)).filter(l=>t.stn_list[l].services.length!==0).map(l=>e.jsx("g",{transform:`translate(${s[l]},${a[l]})`,children:e.jsx(Z,{stnId:l,nameDirection:n.filter(o=>o.includes(l)).map(o=>o.indexOf(l)%2===0||i.length>1?"downward":"upward")[0],services:i})},l))})},$t=()=>{const r=M(n=>n.param);return k.useMemo(()=>e.jsxs(e.Fragment,{children:[e.jsx("g",{transform:`translate(${r.svgWidth.indoor/2},50)`,children:e.jsxs("text",{textAnchor:"middle",fontSize:"30",className:"rmg-name__zh",children:["轨道交通",r.line_name[0],"运营线路示意图"]})}),e.jsxs("g",{transform:`translate(${r.svgWidth.indoor/2},${r.svg_height-270})`,children:[e.jsx("text",{textAnchor:"middle",fontSize:"18",className:"rmg-name__zh",dx:"-30",dy:"230",children:"友情提示：请留意您需要换乘线路的首末班时间，以免耽误您的出行，末班车进站前三分钟停售该末班车车票。"}),e.jsx("text",{textAnchor:"middle",fontSize:"12",className:"rmg-name__en",dx:"10",dy:"250",children:"Please pay attention to the interchange schedule if you want to transfer to other lines. Stop selling tickets 3 minutes before the last train services."}),e.jsxs("g",{transform:"translate(-600,215)",children:[e.jsx("rect",{x:"-5",y:"-25",width:"100",height:"70",fill:"none",stroke:"black",rx:"5"}),e.jsx("line",{x1:"28",x2:"28",y1:"-20",y2:"40",stroke:"black"}),e.jsx("text",{className:"rmg-name__zh",dx:"3",fontSize:"18",children:"图"}),e.jsx("text",{className:"rmg-name__zh",dx:"3",dy:"18",fontSize:"18",children:"例"}),e.jsx("text",{className:"rmg-name__en",dy:"35",fontSize:"8",children:"legend"}),e.jsx("use",{transform:"translate(45,10)",xlinkHref:"#int2_indoor_sh",stroke:"var(--rmg-black)"}),e.jsx("text",{className:"rmg-name__zh",dx:"60",dy:"10",fontSize:"10",children:"换乘站"}),e.jsx("text",{className:"rmg-name__en",dx:"60",dy:"20",fontSize:"6",children:"Interchange"}),e.jsx("text",{className:"rmg-name__en",dx:"60",dy:"30",fontSize:"6",children:"Station"})]})]})]}),[r.svgWidth.indoor,r.svg_height,r.line_name])},bt={destination:e.jsx(ye,{}),runin:e.jsx(Oe,{}),railmap:e.jsx(dt,{}),indoor:e.jsx(xt,{})};export{bt as default};
